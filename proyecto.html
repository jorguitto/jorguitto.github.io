<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitTracker Pro - Medical Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb', // Azul m√©dico
                        secondary: '#10b981',
                        danger: '#ef4444',
                        dark: '#1e293b',
                        light: '#f1f5f9',
                        study: '#8b5cf6'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; padding-bottom: 100px; }
        
        /* Animaciones y UI */
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05), 0 8px 10px -6px rgba(0,0,0,0.01); transition: transform 0.2s; border: 1px solid #f1f5f9; }
        .nav-item.active { color: #2563eb; transform: translateY(-2px); }
        .nav-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: #94a3b8; }
        
        /* Sliders Personalizados */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
            background: white; border: 2px solid #2563eb; cursor: pointer; margin-top: -10px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer; background: #e2e8f0; border-radius: 99px;
        }

        /* Botones de Estudio */
        .focus-btn { transition: all 0.2s; border: 2px solid transparent; }
        .focus-btn.selected { border-color: #8b5cf6; background-color: #f3e8ff; color: #6d28d9; transform: scale(1.05); }

        .page-section { display: none; opacity: 0; animation: fadeIn 0.4s ease-out forwards; }
        .page-section.active { display: block; opacity: 1; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .meal-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        .meal-content.open { max-height: 2000px; }
        
        /* Barra de Estr√©s (M√©dico) */
        .stress-bar-container { height: 12px; background: #e2e8f0; border-radius: 99px; overflow: hidden; position: relative; }
        .stress-bar { height: 100%; border-radius: 99px; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1), background-color 1s; }
    </style>
</head>
<body>

    <header class="fixed top-0 w-full bg-white/90 backdrop-blur-md z-50 border-b border-gray-100 px-5 py-4 flex justify-between items-center">
        <button onclick="navigateTo('registro')" class="text-gray-400 hover:text-primary transition"><i class="fas fa-history text-xl"></i></button>
        <div class="text-center">
            <h1 class="text-lg font-bold text-slate-800 tracking-tight">FitTracker <span class="text-primary text-xs bg-blue-50 px-2 py-0.5 rounded-full ml-1">AI Doctor</span></h1>
            <p id="season-indicator" class="text-[10px] text-gray-500 font-medium mt-0.5 uppercase tracking-wider">Detectando...</p>
        </div>
        <button onclick="openSettings()" class="text-gray-400 hover:text-primary transition"><i class="fas fa-cog text-xl"></i></button>
    </header>

    <main class="container mx-auto px-4 mt-24 max-w-lg">

        <div id="inicio" class="page-section active">
            
            <div class="card p-5 mb-5 border-l-4 border-indigo-500">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-gray-700 text-sm"><i class="fas fa-moon text-indigo-500 mr-2"></i>Descanso</h3>
                    <span id="sleep-feedback" class="text-xs font-bold text-gray-400">Registrar datos</span>
                </div>
                <div class="flex gap-3">
                    <div class="w-1/2">
                        <label class="text-[10px] text-gray-400 uppercase font-bold block mb-1">Hora Despertar</label>
                        <input type="time" id="wakeTime" onchange="updateDay()" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-sm focus:border-indigo-500 outline-none">
                    </div>
                    <div class="w-1/4">
                        <label class="text-[10px] text-gray-400 uppercase font-bold block mb-1">Horas</label>
                        <input type="number" id="sleepHours" placeholder="8" onchange="updateDay()" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-sm text-center focus:border-indigo-500 outline-none">
                    </div>
                    <div class="w-1/4">
                        <label class="text-[10px] text-gray-400 uppercase font-bold block mb-1">Calidad %</label>
                        <input type="number" id="sleepQuality" placeholder="100" onchange="updateDay()" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-sm text-center focus:border-indigo-500 outline-none">
                    </div>
                </div>
            </div>

            <div class="card p-6 mb-6 relative overflow-hidden">
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <h2 class="text-lg font-bold text-slate-800">Nivel de Carga Diario</h2>
                        <p class="text-xs text-gray-500">An√°lisis biom√©trico en tiempo real</p>
                    </div>
                    <div class="text-right">
                        <span id="stress-score" class="text-2xl font-black text-green-500">0%</span>
                    </div>
                </div>
                
                <div class="stress-bar-container mb-3">
                    <div id="stress-bar" class="stress-bar bg-green-500" style="width: 0%"></div>
                </div>
                <p id="stress-msg" class="text-xs font-medium text-center text-gray-600 bg-gray-50 py-2 rounded-lg">
                    D√≠a nuevo. El cuerpo est√° descansado.
                </p>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="card p-4 border-b-4 border-blue-400">
                    <p class="text-xs text-gray-400 font-bold uppercase mb-1">Hidrataci√≥n</p>
                    <div class="flex items-end justify-between">
                        <span class="text-2xl font-bold text-slate-700"><span id="home-water">0</span><span class="text-sm text-gray-400 font-normal">ml</span></span>
                        <i class="fas fa-glass-water text-blue-400 text-xl opacity-50"></i>
                    </div>
                    <div class="w-full bg-gray-100 h-1 mt-2 rounded-full overflow-hidden">
                        <div id="mini-bar-water" class="bg-blue-400 h-full w-0 transition-all duration-500"></div>
                    </div>
                </div>

                <div class="card p-4 border-b-4 border-study">
                    <p class="text-xs text-gray-400 font-bold uppercase mb-1">Estudio</p>
                    <div class="flex items-end justify-between">
                        <span class="text-2xl font-bold text-slate-700"><span id="home-study">0</span><span class="text-sm text-gray-400 font-normal">h</span></span>
                        <i class="fas fa-brain text-study text-xl opacity-50"></i>
                    </div>
                     <p id="home-focus-label" class="text-[10px] text-study mt-2 font-bold text-right">--</p>
                </div>
            </div>
            
            <div class="card p-5 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700 text-sm">Combustible</h3>
                    <span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded">Objetivo Din√°mico: <span id="goal-cals" class="font-bold">2000</span> kcal</span>
                </div>

                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-xs mb-1 font-bold text-slate-600">
                            <span>Energ√≠a (Kcal)</span>
                            <span><span id="val-cals">0</span></span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-2">
                            <div id="bar-cals" class="bg-slate-800 h-2 rounded-full transition-all duration-700" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4 mt-2">
                        <div>
                            <span class="text-[10px] text-gray-400 block mb-1">Prote√≠na</span>
                            <div class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden">
                                <div id="bar-prot" class="h-full bg-green-500 w-0"></div>
                            </div>
                            <span class="text-[10px] text-right block mt-0.5"><span id="val-prot">0</span>/<span id="goal-prot">0</span></span>
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-400 block mb-1">Grasas</span>
                            <div class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden">
                                <div id="bar-fat" class="h-full bg-yellow-400 w-0"></div>
                            </div>
                            <span class="text-[10px] text-right block mt-0.5"><span id="val-fat">0</span>/<span id="goal-fat">0</span></span>
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-400 block mb-1">Carbos</span>
                            <div class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden">
                                <div id="bar-carbs" class="h-full bg-red-400 w-0"></div>
                            </div>
                            <span class="text-[10px] text-right block mt-0.5"><span id="val-carbs">0</span>/<span id="goal-carbs">0</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="finishDay()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-xl shadow-slate-200 active:scale-95 transition-transform flex items-center justify-center gap-2">
                <i class="fas fa-flag-checkered"></i> Finalizar D√≠a
            </button>
        </div>

        <div id="comida" class="page-section">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Nutrici√≥n</h2>
                <button onclick="openCustomFoodModal()" class="bg-white border border-gray-200 text-slate-700 px-4 py-2 rounded-full text-xs font-bold shadow-sm active:scale-95 transition">
                    + Crear Nuevo
                </button>
            </div>
            
            <div class="relative mb-6">
                <input type="text" id="globalSearch" onkeyup="searchGlobal(this.value)" placeholder="üîç Buscar alimento..." class="w-full bg-white p-4 pl-12 rounded-2xl border-none shadow-sm text-sm focus:ring-2 focus:ring-primary/50 outline-none">
                <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                <div id="searchResults" class="absolute z-20 w-full bg-white shadow-xl rounded-xl mt-2 hidden max-h-60 overflow-y-auto border border-gray-100"></div>
            </div>

            <div id="foodCategoriesContainer" class="space-y-3 pb-8"></div>

            <div class="mt-6 pt-4 border-t border-gray-200">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">Registro de Hoy</h3>
                <div id="addedFoodsList" class="space-y-2"></div>
            </div>
        </div>

        <div id="agua" class="page-section">
            <h2 class="text-2xl font-bold text-center text-slate-800 mb-2">Hidrataci√≥n</h2>
            <p id="water-goal-text" class="text-center text-xs text-blue-500 font-bold bg-blue-50 py-1 px-3 rounded-full mx-auto w-max mb-8">Meta din√°mica: 2200 ml</p>
            
            <div class="flex flex-col items-center">
                <div class="relative w-56 h-56 mb-10 flex items-center justify-center">
                    <svg class="w-full h-full transform -rotate-90 filter drop-shadow-xl">
                        <circle cx="112" cy="112" r="90" stroke="#f1f5f9" stroke-width="15" fill="transparent"/>
                        <circle id="water-circle" cx="112" cy="112" r="90" stroke="#3b82f6" stroke-width="15" fill="transparent" stroke-dasharray="565" stroke-dashoffset="565" stroke-linecap="round" class="transition-all duration-1000"/>
                    </svg>
                    <div class="absolute text-center">
                        <i class="fas fa-glass-water text-blue-400 text-2xl mb-1"></i>
                        <span id="water-display-lg" class="text-5xl font-black text-slate-800 block">0</span>
                        <span class="text-sm text-gray-400 font-medium">ml bebidos</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6 w-full max-w-sm px-4">
                    <button onclick="addWater(250)" class="bg-white h-32 rounded-3xl shadow-lg border-2 border-transparent hover:border-blue-200 active:scale-95 transition flex flex-col items-center justify-center gap-2">
                        <div class="bg-blue-50 w-12 h-12 rounded-full flex items-center justify-center"><i class="fas fa-glass-water text-blue-500"></i></div>
                        <span class="font-bold text-slate-600 text-sm">Vaso<br><span class="text-xs text-gray-400">250 ml</span></span>
                    </button>
                    <button onclick="addWater(1000)" class="bg-white h-32 rounded-3xl shadow-lg border-2 border-transparent hover:border-blue-200 active:scale-95 transition flex flex-col items-center justify-center gap-2">
                         <div class="bg-blue-50 w-12 h-12 rounded-full flex items-center justify-center"><i class="fas fa-bottle-water text-blue-600"></i></div>
                        <span class="font-bold text-slate-600 text-sm">Jarra<br><span class="text-xs text-gray-400">1 Litro</span></span>
                    </button>
                </div>
            </div>
        </div>

        <div id="estudio" class="page-section">
            <h2 class="text-2xl font-bold mb-6 text-slate-800">Productividad</h2>
            
            <div class="card p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-clock text-study"></i> Tiempo de Estudio</h3>
                    <span class="text-2xl font-bold text-study"><span id="val-study-hours">0</span>h</span>
                </div>
                <input type="range" min="0" max="12" step="0.5" value="0" id="range-study-hours" oninput="updateStudy('hours', this.value)" class="accent-study">
                <div class="flex justify-between text-xs text-gray-400 mt-3 font-medium">
                    <span>0h</span>
                    <span>6h</span>
                    <span>12h</span>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-brain text-orange-400"></i> Calidad del Foco</h3>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="setFocusLevel(1)" id="focus-btn-1" class="focus-btn bg-gray-50 py-4 rounded-xl flex flex-col items-center gap-2">
                        <i class="fas fa-mobile-alt text-lg text-gray-400"></i>
                        <span class="text-xs font-bold text-gray-500">Bajo</span>
                    </button>
                    <button onclick="setFocusLevel(2)" id="focus-btn-2" class="focus-btn bg-gray-50 py-4 rounded-xl flex flex-col items-center gap-2">
                        <i class="fas fa-user-check text-lg text-gray-400"></i>
                        <span class="text-xs font-bold text-gray-500">Medio</span>
                    </button>
                    <button onclick="setFocusLevel(3)" id="focus-btn-3" class="focus-btn bg-gray-50 py-4 rounded-xl flex flex-col items-center gap-2">
                        <i class="fas fa-brain text-lg text-gray-400"></i>
                        <span class="text-xs font-bold text-gray-500">Deep Work</span>
                    </button>
                </div>
                <p class="text-xs text-center text-gray-400 mt-4 italic" id="focus-desc">Selecciona tu nivel de concentraci√≥n</p>
            </div>
        </div>

        <div id="deporte" class="page-section">
            <h2 class="text-2xl font-bold mb-6 text-slate-800">Entrenamiento</h2>
            
            <div class="card p-5 mb-6 border-l-4 border-orange-500">
                <div class="flex items-center gap-2 mb-4">
                    <div class="bg-orange-100 p-2 rounded-lg text-orange-600"><i class="fas fa-running text-xl"></i></div>
                    <div>
                        <h3 class="font-bold text-slate-700">Running</h3>
                        <p class="text-[10px] text-gray-400">Gasto cal√≥rico alto</p>
                    </div>
                </div>

                <div class="space-y-5">
                    <div>
                        <div class="flex justify-between text-xs font-bold text-gray-500 mb-2">
                            <span>Distancia</span>
                            <span class="text-orange-600"><span id="val-run-km">0</span> km</span>
                        </div>
                        <input type="range" min="0" max="21" step="0.5" value="0" id="range-run-km" oninput="updateSport()">
                    </div>
                    
                    <div class="flex gap-4">
                        <div class="w-1/2">
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Ritmo (min/km)</label>
                            <input type="range" min="3" max="8" step="0.1" value="5.5" id="range-run-pace" oninput="updateSport()" class="mt-2">
                            <div class="text-center text-xs font-bold text-slate-600 mt-1"><span id="val-run-pace">5:30</span> /km</div>
                        </div>
                        <div class="w-1/2">
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Intensidad</label>
                            <input type="range" min="1" max="3" step="1" value="2" id="range-run-int" oninput="updateSport()" class="mt-2">
                            <div class="text-center text-xs font-bold text-slate-600 mt-1" id="val-run-int-text">Normal</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-5 border-l-4 border-indigo-500">
                <div class="flex items-center gap-2 mb-4">
                    <div class="bg-indigo-100 p-2 rounded-lg text-indigo-600"><i class="fas fa-bicycle text-xl"></i></div>
                    <div>
                        <h3 class="font-bold text-slate-700">Ciclismo</h3>
                        <p class="text-[10px] text-gray-400">Resistencia</p>
                    </div>
                </div>

                <div class="space-y-5">
                    <div>
                        <div class="flex justify-between text-xs font-bold text-gray-500 mb-2">
                            <span>Distancia</span>
                            <span class="text-indigo-600"><span id="val-bike-km">0</span> km</span>
                        </div>
                        <input type="range" min="0" max="100" step="1" value="0" id="range-bike-km" oninput="updateSport()">
                    </div>
                     <div class="flex gap-4">
                        <div class="w-full">
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Nivel de Esfuerzo</label>
                            <input type="range" min="1" max="3" step="1" value="2" id="range-bike-int" oninput="updateSport()" class="mt-2">
                            <div class="flex justify-between text-[10px] text-gray-400 mt-1">
                                <span>Paseo</span>
                                <span>Ruta</span>
                                <span>Competici√≥n</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="registro" class="page-section">
            <h2 class="text-2xl font-bold mb-6 text-slate-800">Historial M√©dico</h2>
            <div id="historyList" class="space-y-4 pb-12"></div>
        </div>

    </main>

    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-100 py-3 px-2 flex justify-between items-center z-50 shadow-[0_-5px_15px_rgba(0,0,0,0.02)]">
        <button onclick="navigateTo('inicio')" class="nav-item active flex flex-col items-center w-1/5" id="nav-inicio">
            <i class="fas fa-home text-xl mb-1"></i><span class="text-[10px] font-bold">Resumen</span>
        </button>
        <button onclick="navigateTo('comida')" class="nav-item flex flex-col items-center w-1/5" id="nav-comida">
            <i class="fas fa-apple-whole text-xl mb-1"></i><span class="text-[10px] font-bold">Nutrici√≥n</span>
        </button>
        <button onclick="navigateTo('agua')" class="nav-item flex flex-col items-center w-1/5" id="nav-agua">
            <i class="fas fa-droplet text-xl mb-1"></i><span class="text-[10px] font-bold">Agua</span>
        </button>
        <button onclick="navigateTo('estudio')" class="nav-item flex flex-col items-center w-1/5" id="nav-estudio">
            <i class="fas fa-book-open text-xl mb-1"></i><span class="text-[10px] font-bold">Estudio</span>
        </button>
        <button onclick="navigateTo('deporte')" class="nav-item flex flex-col items-center w-1/5" id="nav-deporte">
            <i class="fas fa-person-running text-xl mb-1"></i><span class="text-[10px] font-bold">Deporte</span>
        </button>
    </nav>

    <script>
        // --- 1. BASE DE DATOS Y ESTADO ---
        const foodDatabase = {
            'Desayuno': [
                { name: 'Caf√© con leche', cal: 69, prot: 8, fat: 1, sat: 0.5, carb: 12, weight: 200 },
                { name: 'Tostada Pan+Tomate', cal: 180, prot: 4, fat: 8, sat: 1, carb: 25, weight: 100 },
                { name: 'Avena con Leche', cal: 220, prot: 10, fat: 4, sat: 1, carb: 35, weight: 250 }
            ],
            'Almuerzo': [
                 { name: 'Bocadillo Jam√≥n', cal: 400, prot: 25, fat: 15, sat: 5, carb: 45, weight: 150 },
                 { name: 'Fruta (Pieza)', cal: 60, prot: 0.5, fat: 0, sat: 0, carb: 15, weight: 120 }
            ],
            'Comida': [
                { name: 'Pechuga Pollo Plancha', cal: 165, prot: 31, fat: 3.6, sat: 1, carb: 0, weight: 150 },
                { name: 'Arroz Blanco', cal: 200, prot: 4, fat: 0.5, sat: 0, carb: 44, weight: 150 },
                { name: 'Lentejas', cal: 320, prot: 18, fat: 12, sat: 2, carb: 40, weight: 300 }
            ],
            'Cena': [
                 { name: 'Merluza', cal: 94, prot: 20, fat: 1, sat: 0.2, carb: 0, weight: 300 },
                 { name: 'Ensalada Mixta', cal: 150, prot: 3, fat: 12, sat: 2, carb: 8, weight: 250 },
                 { name: 'Tortilla Francesa', cal: 190, prot: 14, fat: 14, sat: 4, carb: 1, weight: 120 }
            ]
        };

        // Estado Inicial Limpio (Reset)
        const INITIAL_STATE = {
            wakeTime: '', sleepHours: 0, sleepQuality: 0,
            water: 0,
            studyHours: 0, studyFocus: 0, // 0:Nada, 1:Bajo, 2:Medio, 3:Alto
            runKm: 0, runPace: 5.5, runInt: 2,
            bikeKm: 0, bikeInt: 2,
            foodLog: []
        };

        let todayData = JSON.parse(JSON.stringify(INITIAL_STATE));
        const BASE_GOALS = { cals: 2000, prot: 110, fat: 60, sat: 20, carbs: 260, water: 2200 };
        let currentGoals = { ...BASE_GOALS };
        let currentSeason = 'Winter';
        let history = JSON.parse(localStorage.getItem('fitTrackerHistory_v3')) || [];

        // --- 2. INICIALIZACI√ìN ---
        window.onload = function() {
            detectSeason();
            loadDay();
            renderFoodCategories();
            updateDay(); // Calcula todo
            updateHistoryUI();
        };

        function detectSeason() {
            const m = new Date().getMonth();
            const el = document.getElementById('season-indicator');
            if (m >= 5 && m <= 8) { currentSeason = 'Summer'; el.innerText = 'VERANO (ALICANTE)'; }
            else if (m >= 9 && m <= 10) { currentSeason = 'Autumn'; el.innerText = 'OTO√ëO'; }
            else if (m >= 2 && m <= 4) { currentSeason = 'Spring'; el.innerText = 'PRIMAVERA'; }
            else { currentSeason = 'Winter'; el.innerText = 'INVIERNO'; }
        }

        // --- 3. EL "M√âDICO" (ALGORITMOS) ---
        
        function updateDay() {
            // Recoger inputs visuales que pueden haber cambiado
            todayData.wakeTime = document.getElementById('wakeTime').value;
            todayData.sleepHours = Number(document.getElementById('sleepHours').value);
            todayData.sleepQuality = Number(document.getElementById('sleepQuality').value);
            // El resto (deporte/comida) se actualiza en sus propias funciones
            
            calculateDynamicGoals();
            calculateStressBar(); // El "M√©dico"
            saveDay();
            updateUI();
        }

        function calculateDynamicGoals() {
            // Reset
            let g = { ...BASE_GOALS };
            
            // Clima Base Agua
            if (currentSeason === 'Summer') g.water = 2800;
            else if (currentSeason === 'Winter') g.water = 2200;
            else g.water = 2400;

            // --- IMPACTO CORRER (Complejo) ---
            if (todayData.runKm > 0) {
                // Factor Ritmo: Correr a 4:00 (r√°pido) gasta m√°s que a 7:00 (lento)
                // Slider Pace: 3 min/km (r√°pido) a 8 min/km (lento). 
                // Invertimos: cuanto menor el n√∫mero, mayor la intensidad.
                let paceFactor = 1 + ((8 - todayData.runPace) * 0.1); // Ejemplo: Pace 4.0 -> Factor 1.4
                
                // Factor Intensidad Slider
                let intFactor = todayData.runInt === 3 ? 1.2 : (todayData.runInt === 1 ? 0.9 : 1.0);

                let totalRunFactor = paceFactor * intFactor;

                g.cals += todayData.runKm * 60 * totalRunFactor;
                g.prot += todayData.runKm * 3; 
                g.carbs += todayData.runKm * 15 * totalRunFactor; // Carbos disparan con intensidad
                g.water += todayData.runKm * (currentSeason === 'Summer' ? 250 : 150) * totalRunFactor;
            }

            // --- IMPACTO BICI ---
            if (todayData.bikeKm > 0) {
                let bikeFactor = todayData.bikeInt === 3 ? 1.5 : (todayData.bikeInt === 1 ? 0.8 : 1.0);
                g.cals += todayData.bikeKm * 30 * bikeFactor;
                g.water += todayData.bikeKm * (currentSeason === 'Summer' ? 150 : 80) * bikeFactor;
                g.carbs += todayData.bikeKm * 8 * bikeFactor;
            }

            currentGoals = g;
        }

        function calculateStressBar() {
            // LA BARRA EMPIEZA EN 0. Sube con lo malo.
            let stress = 0;

            // 1. Sue√±o (18 a√±os necesita 8h)
            if (todayData.sleepHours === 0) {
                // No ha registrado a√∫n (neutral tirando a aviso)
            } else if (todayData.sleepHours < 8) {
                stress += (8 - todayData.sleepHours) * 10; // Cada hora menos es mucho estr√©s
            }
            if (todayData.sleepQuality > 0 && todayData.sleepQuality < 85) {
                stress += (100 - todayData.sleepQuality) * 0.2;
            }
            // Hora despertar (M√©dico estricto)
            if (todayData.wakeTime) {
                const hour = parseInt(todayData.wakeTime.split(':')[0]);
                if (hour > 10) stress += 15; // Despertar muy tarde afecta biorritmo
                if (hour < 6 && todayData.sleepHours < 7) stress += 20; // Madrug√≥n sin dormir
            }

            // 2. Hidrataci√≥n
            const waterP = (todayData.water / currentGoals.water) * 100;
            if (waterP < 50) stress += 10; // Deshidratado

            // 3. Estudio (Carga mental)
            stress += todayData.studyHours * 2; // Carga base
            if (todayData.studyFocus === 1) stress += todayData.studyHours * 5; // Distra√≠do cansa m√°s (frustraci√≥n)
            if (todayData.studyFocus === 3) stress += todayData.studyHours * 1; // Deep work cansa menos (flow), pero cansa.
            
            // 4. Deporte (Carga f√≠sica)
            // Correr r√°pido sube fatiga f√≠sica
            if (todayData.runKm > 0) {
                stress += todayData.runKm * (todayData.runInt === 3 ? 3 : 1);
            }
            if (todayData.bikeKm > 0) {
                stress += todayData.bikeKm * 0.5;
            }

            // Normalizar 0-100
            stress = Math.min(100, Math.max(0, stress));

            // Renderizar
            const bar = document.getElementById('stress-bar');
            const txt = document.getElementById('stress-score');
            const msg = document.getElementById('stress-msg');

            bar.style.width = stress + '%';
            txt.innerText = Math.round(stress) + '%';

            // Colores y Mensajes
            if (stress < 30) {
                bar.className = 'stress-bar bg-green-500';
                txt.className = 'text-2xl font-black text-green-500';
                msg.innerText = "Estado √ìptimo. Listo para rendir.";
            } else if (stress < 60) {
                bar.className = 'stress-bar bg-yellow-400';
                txt.className = 'text-2xl font-black text-yellow-500';
                msg.innerText = "Carga Moderada. Mant√©n la hidrataci√≥n.";
            } else if (stress < 85) {
                bar.className = 'stress-bar bg-orange-500';
                txt.className = 'text-2xl font-black text-orange-500';
                msg.innerText = "Cansancio Notable. Prioriza descanso hoy.";
            } else {
                bar.className = 'stress-bar bg-red-600';
                txt.className = 'text-2xl font-black text-red-600';
                msg.innerText = "ALERTA: Sobrecarga. Riesgo de lesi√≥n/burnout.";
            }
        }

        // --- 4. FUNCIONES DE UI ESPEC√çFICAS ---

        // Deporte Avanzado
        function updateSport() {
            todayData.runKm = parseFloat(document.getElementById('range-run-km').value);
            todayData.runPace = parseFloat(document.getElementById('range-run-pace').value);
            todayData.runInt = parseFloat(document.getElementById('range-run-int').value);
            todayData.bikeKm = parseFloat(document.getElementById('range-bike-km').value);
            todayData.bikeInt = parseFloat(document.getElementById('range-bike-int').value);

            // Textos
            document.getElementById('val-run-km').innerText = todayData.runKm;
            // Convertir ritmo decimal a min:seg
            let min = Math.floor(todayData.runPace);
            let sec = Math.round((todayData.runPace - min) * 60);
            document.getElementById('val-run-pace').innerText = `${min}:${sec < 10 ? '0' : ''}${sec}`;
            
            const ints = ['--', 'Suave', 'Normal', 'Alta'];
            document.getElementById('val-run-int-text').innerText = ints[todayData.runInt];

            document.getElementById('val-bike-km').innerText = todayData.bikeKm;

            updateDay();
        }

        // Estudio (Botones)
        function updateStudy(type, val) {
            if (type === 'hours') {
                todayData.studyHours = parseFloat(val);
                document.getElementById('val-study-hours').innerText = val;
                document.getElementById('home-study').innerText = val;
            }
            updateDay();
        }

        function setFocusLevel(level) {
            todayData.studyFocus = level;
            // UI Update
            [1, 2, 3].forEach(i => document.getElementById(`focus-btn-${i}`).classList.remove('selected'));
            document.getElementById(`focus-btn-${level}`).classList.add('selected');
            
            const labels = ['', 'Bajo (Distra√≠do)', 'Normal', 'Alto (Deep Work)'];
            document.getElementById('focus-desc').innerText = "Nivel seleccionado: " + labels[level];
            document.getElementById('home-focus-label').innerText = labels[level];
            
            updateDay();
        }

        // Comida con PREVISUALIZACI√ìN (Lupa)
        function renderFoodCategories() {
            const c = document.getElementById('foodCategoriesContainer');
            c.innerHTML = Object.keys(foodDatabase).map(cat => `
                <div class="border rounded-xl bg-white overflow-hidden mb-2 shadow-sm">
                    <div class="p-4 bg-gray-50 font-bold text-slate-700 cursor-pointer flex justify-between items-center" onclick="this.nextElementSibling.classList.toggle('open')">
                        <span>${cat}</span> <i class="fas fa-chevron-down text-xs text-gray-400"></i>
                    </div>
                    <div class="meal-content">
                        ${foodDatabase[cat].map((f, i) => `
                            <div class="p-3 border-t border-gray-100 flex justify-between items-center hover:bg-blue-50/50 transition">
                                <div>
                                    <div class="font-bold text-sm text-slate-700">${f.name}</div>
                                    <div class="text-[10px] text-gray-400">${f.cal} kcal / ${f.weight}g</div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="viewFoodDetails('${cat}', ${i})" class="w-8 h-8 rounded-full bg-white border border-gray-200 text-gray-400 hover:text-blue-500 hover:border-blue-200 transition flex items-center justify-center">
                                        <i class="fas fa-search text-xs"></i>
                                    </button>
                                    <button onclick="addFood('${cat}', ${i})" class="w-8 h-8 rounded-full bg-primary text-white shadow-md hover:bg-blue-600 active:scale-90 transition flex items-center justify-center">
                                        <i class="fas fa-plus text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function viewFoodDetails(cat, idx) {
            const f = foodDatabase[cat][idx];
            Swal.fire({
                title: f.name,
                html: `
                    <div class="grid grid-cols-2 gap-4 text-left bg-gray-50 p-4 rounded-xl">
                        <div>
                            <p class="text-xs text-gray-500">Calor√≠as</p>
                            <p class="font-bold text-lg text-slate-800">${f.cal}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Peso Base</p>
                            <p class="font-bold text-lg text-slate-800">${f.weight}g</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Prote√≠nas</p>
                            <p class="font-bold text-green-600">${f.prot}g</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Grasas</p>
                            <p class="font-bold text-yellow-500">${f.fat}g <span class="text-[10px] text-gray-400">(${f.sat}g sat)</span></p>
                        </div>
                        <div class="col-span-2">
                            <p class="text-xs text-gray-500">Carbohidratos</p>
                            <p class="font-bold text-red-500">${f.carb}g</p>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'A√±adir',
                cancelButtonText: 'Cerrar',
                confirmButtonColor: '#2563eb'
            }).then((r) => {
                if(r.isConfirmed) addFood(cat, idx);
            });
        }

        function addFood(cat, idx) {
            const f = foodDatabase[cat][idx];
            todayData.foodLog.push({ ...f });
            updateDay();
            const toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
            toast.fire({ icon: 'success', title: 'A√±adido' });
        }

        function updateUI() {
            // Recalcular Nutrici√≥n Log
            let sum = { cal:0, prot:0, fat:0, sat:0, carb:0 };
            todayData.foodLog.forEach(f => {
                sum.cal+=f.cal; sum.prot+=f.prot; sum.fat+=f.fat; sum.sat+=f.sat; sum.carb+=f.carb;
            });

            // UI Home
            const setBar = (id, val, max, color) => {
                const p = Math.min((val/max)*100, 100);
                document.getElementById(`bar-${id}`).style.width = p+'%';
                document.getElementById(`val-${id}`).innerText = Math.round(val);
                if(document.getElementById(`goal-${id}`)) document.getElementById(`goal-${id}`).innerText = Math.round(max);
            };

            setBar('cals', sum.cal, currentGoals.cals);
            setBar('prot', sum.prot, currentGoals.prot);
            setBar('fat', sum.fat, currentGoals.fat);
            setBar('carbs', sum.carb, currentGoals.carbs);
            
            // Agua Home
            document.getElementById('home-water').innerText = todayData.water;
            document.getElementById('mini-bar-water').style.width = Math.min((todayData.water/currentGoals.water)*100, 100) + '%';
            
            // Agua Secci√≥n
            const wp = Math.min(todayData.water / currentGoals.water, 1);
            document.getElementById('water-circle').style.strokeDashoffset = 565 - (wp * 565);
            document.getElementById('water-display-lg').innerText = todayData.water;
            document.getElementById('water-goal-text').innerText = `Meta din√°mica: ${Math.round(currentGoals.water)} ml`;

            // Listado
            document.getElementById('addedFoodsList').innerHTML = todayData.foodLog.map((f, i) => `
                <div class="flex justify-between items-center text-sm py-2 border-b border-gray-100 last:border-0">
                    <span class="text-slate-600">${f.name}</span>
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-xs text-slate-400">${Math.round(f.cal)} kcal</span>
                        <button onclick="removeFood(${i})" class="text-red-300 hover:text-red-500"><i class="fas fa-times"></i></button>
                    </div>
                </div>
            `).join('');
        }
        
        function removeFood(idx) { todayData.foodLog.splice(idx, 1); updateDay(); }
        function addWater(ml) { todayData.water += ml; updateDay(); }
        
        // --- GESTI√ìN GLOBAL ---
        function saveDay() { localStorage.setItem('fitTrackerToday_v3', JSON.stringify(todayData)); }
        function loadDay() {
            const s = localStorage.getItem('fitTrackerToday_v3');
            if(s) {
                todayData = JSON.parse(s);
                // Restaurar inputs visuales
                document.getElementById('wakeTime').value = todayData.wakeTime;
                document.getElementById('sleepHours').value = todayData.sleepHours || '';
                document.getElementById('sleepQuality').value = todayData.sleepQuality || '';
                document.getElementById('range-run-km').value = todayData.runKm;
                document.getElementById('range-run-pace').value = todayData.runPace;
                document.getElementById('range-run-int').value = todayData.runInt;
                document.getElementById('range-bike-km').value = todayData.bikeKm;
                document.getElementById('range-study-hours').value = todayData.studyHours;
                if(todayData.studyFocus) setFocusLevel(todayData.studyFocus);
                // Refrescar textos deporte
                let min = Math.floor(todayData.runPace);
                let sec = Math.round((todayData.runPace - min) * 60);
                document.getElementById('val-run-pace').innerText = `${min}:${sec < 10 ? '0' : ''}${sec}`;
            }
        }

        function finishDay() {
            Swal.fire({
                title: '¬øCerrar D√≠a?',
                text: "Se guardar√° el informe y la barra de estr√©s volver√° a CERO.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#1e293b',
                confirmButtonText: 'S√≠, a dormir'
            }).then((r) => {
                if(r.isConfirmed) {
                    const now = new Date();
                    history.unshift({ date: now.toLocaleDateString(), data: { ...todayData }, goals: { ...currentGoals } });
                    localStorage.setItem('fitTrackerHistory_v3', JSON.stringify(history));
                    
                    // RESET TOTAL A CERO
                    todayData = JSON.parse(JSON.stringify(INITIAL_STATE));
                    saveDay();
                    window.location.reload();
                }
            });
        }
        
        function navigateTo(id) {
            document.querySelectorAll('.page-section').forEach(e=>e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            document.getElementById('nav-'+id).classList.add('active');
        }

        // Historial y PDF (Simplificado para el ejemplo)
        function updateHistoryUI() {
            document.getElementById('historyList').innerHTML = history.map((h, i) => `
                <div class="card p-4 flex justify-between items-center">
                    <div>
                        <div class="font-bold text-slate-700">${h.date}</div>
                        <div class="text-[10px] text-gray-400">Cal: ${Math.round(h.data.foodLog.reduce((a,b)=>a+b.cal,0))} | Agua: ${h.data.water}ml</div>
                    </div>
                    <button onclick="exportPDF(${i})" class="text-gray-300 hover:text-red-500"><i class="fas fa-file-pdf text-xl"></i></button>
                </div>
            `).join('');
        }
        
        function exportPDF(i) {
             const rec = history[i];
             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();
             doc.text(`Informe FitTracker: ${rec.date}`, 10, 10);
             doc.save(`Reporte_${rec.date.replace(/\//g,'-')}.pdf`);
        }

        // Search y Customs (Funcionalidad b√°sica mantenida)
        function searchGlobal(q) {
             const r = document.getElementById('searchResults');
             if(!q.trim()) { r.classList.add('hidden'); return; }
             let m = [];
             const clean = q.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
             for(const [c, fs] of Object.entries(foodDatabase)) {
                 fs.forEach((f, idx) => { if(f.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(clean)) m.push({...f, c, idx}); });
             }
             r.innerHTML = m.map(f => `<div class="p-3 border-b hover:bg-gray-50 cursor-pointer" onclick="viewFoodDetails('${f.c}', ${f.idx})">${f.name}</div>`).join('');
             r.classList.remove('hidden');
        }
    </script>
</body>
</html>