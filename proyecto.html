<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitTracker AI - Biological Engine V5</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', 
                        secondary: '#10b981',
                        danger: '#ef4444',
                        dark: '#1e293b',
                        light: '#f8fafc',
                        study: '#8b5cf6',
                        muscle: '#f59e0b'
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9; 
            -webkit-tap-highlight-color: transparent; 
            padding-bottom: 140px;
        }
        
        .card { background: white; border-radius: 24px; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.08); transition: transform 0.2s; border: 1px solid #f1f5f9; }
        .card-clickable:active { transform: scale(0.98); background-color: #f8fafc; }
        
        .modal-overlay { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal-content { transform: scale(0.9); opacity: 0; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .modal-overlay.open .modal-content { transform: scale(1); opacity: 1; }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 28px; width: 28px; border-radius: 50%;
            background: white; border: 2px solid #3b82f6; cursor: pointer; margin-top: -12px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer; background: #e2e8f0; border-radius: 99px;
        }

        input[type="time"] { -webkit-appearance: none; appearance: none; background-color: #f9fafb; min-width: 95px; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .nav-item.active { color: #3b82f6; transform: translateY(-2px); }
        .nav-item.active i { transform: scale(1.1); }
        .nav-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: #94a3b8; }
        
        .page-section { display: none; opacity: 0; animation: fadeIn 0.4s ease-out forwards; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .meal-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        .meal-content.open { max-height: 4000px; }

        .group-header { cursor: pointer; transition: background 0.2s; }
        .group-header:active { background-color: #f1f5f9; }
        .group-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease; }
        .group-content.open { max-height: 5000px; }

        .pb-safe-area { padding-bottom: env(safe-area-inset-bottom); }

        .alert-card { transition: all 0.3s ease; }
        .alert-water-low { background-color: #fee2e2; border-color: #ef4444; animation: pulse 2s infinite; }
        .alert-water-high { background-color: #fef3c7; border-color: #f59e0b; }
        .alert-food-low { background-color: #fee2e2; border-color: #ef4444; animation: pulse 2s infinite; }
        .alert-nutrition { background-color: #fef3c7; border-color: #f59e0b; animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Estilos para el selector de m√∫sculos y SVG */
        .muscle-btn { border: 1px solid #e2e8f0; background: #f8fafc; color: #64748b; transition: all 0.2s; }
        .muscle-btn.selected { background-color: #3b82f6; color: white; border-color: #3b82f6; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); transform: translateY(-1px); }
        .body-part { transition: fill 0.5s ease; }
        .body-green { fill: #10b981; }
        .body-orange { fill: #f59e0b; }
        .body-red { fill: #ef4444; }
        
        /* Estilos para el cuerpo muscular detallado */
        .muscle-base { 
            fill: #e2e8f0; /* Color base (Gris apagado) */
            stroke: #ffffff; 
            stroke-width: 0.5px; 
            transition: all 0.4s ease; 
        }
        .muscle-active-low { fill: #10b981; }   /* Verde (Suave / Recuperaci√≥n) */
        .muscle-active-mid { fill: #f59e0b; }   /* Amarillo (M√∫sculo Secundario) */
        .muscle-active-max { fill: #ef4444; filter: drop-shadow(0 0 2px rgba(239, 68, 68, 0.4)); } /* Rojo (M√∫sculo Primario / Fallo) */
        .label-text { font-size: 6px; fill: #64748b; font-weight: 800; text-anchor: middle; letter-spacing: 1px; }

        /* --- NUEVO ESTILO ANATOM√çA PRO --- */
        .human-body-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding-top: 20px;
        }

        .anatomy-svg {
            height: 300px;
            width: auto;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.05));
        }
    </style>
</head>
<body>

    <header class="fixed top-0 w-full bg-white/90 backdrop-blur-xl z-40 border-b border-gray-100 px-6 py-4 flex justify-between items-center shadow-sm">
        <button onclick="navigateTo('registro')" class="text-gray-400 hover:text-primary transition"><i class="fas fa-history text-xl"></i></button>
        <div class="text-center">
            <h1 class="text-lg font-black text-slate-800 tracking-tighter italic">FIT<span class="text-primary">TRACKER</span></h1>
            <p id="season-indicator" class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Sincronizando...</p>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="editUserProfile()" class="text-gray-400 hover:text-blue-500 transition"><i class="fas fa-user-circle text-xl"></i></button>
            <button onclick="finishDay()" class="text-gray-400 hover:text-green-500 transition"><i class="fas fa-check-circle text-xl"></i></button>
        </div>
    </header>

    <main class="container mx-auto px-5 mt-24 max-w-lg">

        <div id="inicio" class="page-section active">
            
            <div class="card p-5 mb-5 border-l-4 border-indigo-500 relative">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2"><i class="fas fa-moon text-indigo-500"></i> Recuperaci√≥n SNC</h3>
                    <span id="sleep-score" class="text-[10px] font-bold bg-indigo-50 text-indigo-600 px-2 py-1 rounded">--</span>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label class="text-[10px] text-gray-400 uppercase font-bold block mb-1">Hora Despertar</label>
                        <input type="time" id="wakeTime" onchange="triggerMorningPrediction()" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-3 text-sm focus:border-indigo-500 outline-none font-bold text-slate-600">
                    </div>
                    <div class="grid grid-cols-2 gap-3 sm:col-span-2">
                        <div>
                            <label class="text-[10px] text-gray-400 uppercase font-bold block mb-1">Horas</label>
                            <input type="number" id="sleepHours" placeholder="8" onchange="triggerMorningPrediction()" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-3 text-sm text-center focus:border-indigo-500 outline-none font-bold text-slate-600">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 uppercase font-bold block mb-1">Calidad (Watch)</label>
                            <input type="number" id="sleepQuality" placeholder="%" oninput="updateDay()" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-3 text-sm text-center focus:border-indigo-500 outline-none font-bold text-slate-600">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-5 mb-5 border-b-4 border-slate-400 card-clickable cursor-pointer" onclick="showDetails('stress')" id="stress-card">
                <div class="flex justify-between mb-4">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Estado Fisiol√≥gico</p>
                    <i class="fas fa-heart-pulse text-slate-400 text-xs"></i>
                </div>

                <div class="mb-3">
                    <div class="flex justify-between text-[10px] font-bold text-gray-500 mb-1">
                        <span>üß† Carga Mental</span>
                        <span id="mental-val">0%</span>
                    </div>
                    <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                        <div id="bar-mental" class="bg-indigo-500 h-full w-0 transition-all duration-700 rounded-full"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="flex justify-between text-[10px] font-bold text-gray-500 mb-1">
                        <span>üí™ Carga F√≠sica</span>
                        <span id="phys-val">0%</span>
                    </div>
                    <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                        <div id="bar-physical" class="bg-orange-500 h-full w-0 transition-all duration-700 rounded-full"></div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between text-[10px] font-bold text-gray-500 mb-1">
                        <span>üìÖ Fatiga (7 d√≠as)</span>
                        <span id="fatigue-val">0%</span>
                    </div>
                    <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                        <div id="bar-fatigue" class="bg-teal-500 h-full w-0 transition-all duration-700 rounded-full"></div>
                    </div>
                </div>

                <!-- SVG Body Map Insertado -->
                <div class="mt-4 flex flex-col items-center border-t border-gray-100 pt-4">
                    <div id="body-analysis-text" class="text-xs text-center font-bold text-slate-600 mb-2 bg-slate-100 px-3 py-1 rounded-full w-full">
                        Analizando composici√≥n...
                    </div>
                    <svg width="100%" height="280" viewBox="0 0 200 280" xmlns="http://www.w3.org/2000/svg" class="mx-auto">
                        
                        <g transform="translate(0, 0)">
                            <!-- VISTA FRONTAL (Mejorada) -->
                            <g transform="translate(0, 10)">
                                <text x="50" y="-2" class="label-text">FRONTAL</text>
                                
                                <!-- Cabeza -->
                                <path d="M50,2 C44,2 40,8 40,16 C40,24 44,28 50,28 C56,28 60,24 60,16 C60,8 56,2 50,2 Z" class="muscle-base" />
                                <path d="M50,3 C45,3 41,8 41,15 C41,22 45,26 50,26 C55,26 59,22 59,15 C59,8 55,3 50,3 Z" class="muscle-base" />
                                
                                <!-- Trapecios -->
                                <path id="front-traps" d="M40,18 Q30,22 24,28 L32,32 L42,26 Z M60,18 Q70,22 76,28 L68,32 L58,26 Z" class="muscle-base" />
                                <path id="front-traps" d="M43,16 Q33,19 26,26 L33,29 L44,23 Z M57,16 Q67,19 74,26 L67,29 L56,23 Z" class="muscle-base" />
                                
                                <!-- Hombros (Deltoides) -->
                                <path id="front-delts" d="M24,28 Q12,32 12,42 Q14,52 20,50 L28,38 Z M76,28 Q88,32 88,42 Q86,52 80,50 L72,38 Z" class="muscle-base" />
                                <path id="front-delts" d="M26,26 Q13,29 13,39 Q15,49 23,47 L31,35 Z M74,26 Q87,29 87,39 Q85,49 77,47 L69,35 Z" class="muscle-base" />
                                
                                <!-- Pectorales -->
                                <path id="front-pecs" d="M28,38 Q50,42 72,38 L68,58 Q50,65 32,58 Z" class="muscle-base" />
                                <path id="front-pecs" d="M31,35 Q50,39 69,35 L66,55 Q50,63 34,55 Z" class="muscle-base" />
                                
                                <!-- B√≠ceps -->
                                <path id="front-biceps" d="M20,50 Q16,60 18,68 L26,65 L28,50 Z M80,50 Q84,60 82,68 L74,65 L72,50 Z" class="muscle-base" />
                                <path id="front-biceps" d="M23,47 Q19,57 21,64 L29,61 L31,47 Z M77,47 Q81,57 79,64 L71,61 L69,47 Z" class="muscle-base" />
                                
                                <!-- Antebrazos -->
                                <path id="front-forearms" d="M18,68 Q14,80 16,90 L22,88 L26,65 Z M82,68 Q86,80 84,90 L78,88 L74,65 Z" class="muscle-base" />
                                <path id="front-forearms" d="M21,64 Q16,76 19,86 L25,84 L29,61 Z M79,64 Q84,76 81,86 L75,84 L71,61 Z" class="muscle-base" />
                                
                                <!-- Abdominales -->
                                <path id="front-abs" d="M32,58 L68,58 L64,85 Q50,90 36,85 Z" class="muscle-base" />
                                <path id="front-abs" d="M34,55 L66,55 L63,82 Q50,88 37,82 Z" class="muscle-base" />
                                
                                <!-- Oblicuos -->
                                <path id="front-obliques" d="M28,58 L32,58 L36,85 L26,80 Z M72,58 L68,58 L64,85 L74,80 Z" class="muscle-base" />
                                <path id="front-obliques" d="M29,55 L34,55 L37,82 L27,77 Z M71,55 L66,55 L63,82 L73,77 Z" class="muscle-base" />
                                
                                <!-- Cu√°driceps -->
                                <path id="front-quads" d="M26,85 L50,85 L48,145 Q35,155 22,135 Z M74,85 L50,85 L52,145 Q65,155 78,135 Z" class="muscle-base" />
                                <path id="front-quads" d="M27,82 L50,82 L48,140 Q35,150 22,130 Z M73,82 L50,82 L52,140 Q65,150 78,130 Z" class="muscle-base" />
                                
                                <!-- Gemelos -->
                                <path id="front-calves" d="M24,140 L48,145 L46,190 L28,185 Z M76,140 L52,145 L54,190 L72,185 Z" class="muscle-base" />
                                <path id="front-calves" d="M24,135 L48,140 L46,185 L26,180 Z M76,135 L52,140 L54,185 L74,180 Z" class="muscle-base" />
                                
                                <!-- Pies -->
                                <path d="M28,185 L46,190 L46,200 L26,200 Z M72,185 L54,190 L54,200 L74,200 Z" class="muscle-base" />
                                <path d="M26,180 L46,185 L46,195 L24,195 Z M74,180 L54,185 L54,195 L76,195 Z" class="muscle-base" />
                            </g>

                            <!-- VISTA DORSAL (Mejorada) -->
                            <g transform="translate(100, 10)">
                                <text x="50" y="-2" class="label-text">DORSAL</text>
                                
                                <!-- Cabeza -->
                                <path d="M50,2 C44,2 40,8 40,16 C40,24 44,28 50,28 C56,28 60,24 60,16 C60,8 56,2 50,2 Z" class="muscle-base" />
                                <path d="M50,3 C45,3 41,8 41,15 C41,22 45,26 50,26 C55,26 59,22 59,15 C59,8 55,3 50,3 Z" class="muscle-base" />
                                
                                <!-- Trapecios -->
                                <path id="back-traps" d="M40,18 L60,18 L68,30 L50,55 L32,30 Z" class="muscle-base" />
                                <path id="back-traps" d="M42,16 L58,16 L66,28 L50,52 L34,28 Z" class="muscle-base" />
                                
                                <!-- Hombros Traseros -->
                                <path id="back-delts" d="M32,30 L16,32 L18,45 L32,40 Z M68,30 L84,32 L82,45 L68,40 Z" class="muscle-base" />
                                <path id="back-delts" d="M34,28 L18,30 L20,43 L34,38 Z M66,28 L82,30 L80,43 L66,38 Z" class="muscle-base" />
                                
                                <!-- Tr√≠ceps -->
                                <path id="back-triceps" d="M18,45 L28,42 L26,60 L20,58 Z M82,45 L72,42 L74,60 L80,58 Z" class="muscle-base" />
                                <path id="back-triceps" d="M20,43 L30,40 L28,58 L22,56 Z M80,43 L70,40 L72,58 L78,56 Z" class="muscle-base" />
                                
                                <!-- Antebrazos -->
                                <path id="back-forearms" d="M20,58 L26,60 L24,85 L18,82 Z M80,58 L74,60 L76,85 L82,82 Z" class="muscle-base" />
                                <path id="back-forearms" d="M22,56 L28,58 L26,83 L20,80 Z M78,56 L72,58 L74,83 L80,80 Z" class="muscle-base" />
                                
                                <!-- Dorsales (Lats) -->
                                <path id="back-lats" d="M32,40 L68,40 L62,75 L38,75 Z" class="muscle-base" />
                                <path id="back-lats" d="M34,38 L66,38 L60,72 L40,72 Z" class="muscle-base" />
                                
                                <!-- Lumbares -->
                                <path id="back-lower" d="M38,75 L62,75 L58,85 L42,85 Z" class="muscle-base" />
                                <path id="back-lower" d="M40,72 L60,72 L56,82 L44,82 Z" class="muscle-base" />
                                
                                <!-- Gl√∫teos -->
                                <path id="back-glutes" d="M26,85 L74,85 L70,110 L50,115 L30,110 Z" class="muscle-base" />
                                <path id="back-glutes" d="M28,82 L72,82 L68,107 L50,112 L32,107 Z" class="muscle-base" />
                                
                                <!-- Femorales -->
                                <path id="back-hams" d="M30,110 L50,115 L48,150 L28,145 Z M70,110 L50,115 L52,150 L72,145 Z" class="muscle-base" />
                                <path id="back-hams" d="M32,107 L50,112 L48,147 L28,142 Z M68,107 L50,112 L52,147 L72,142 Z" class="muscle-base" />
                                
                                <!-- Gemelos -->
                                <path id="back-calves" d="M28,145 L48,150 L46,190 L32,185 Z M72,145 L52,150 L54,190 L68,185 Z" class="muscle-base" />
                                <path id="back-calves" d="M28,142 L48,147 L46,187 L32,182 Z M72,142 L52,147 L54,187 L68,182 Z" class="muscle-base" />
                                
                                <!-- Pies -->
                                <path d="M32,185 L46,190 L46,200 L32,200 Z M68,185 L54,190 L54,200 L68,200 Z" class="muscle-base" />
                                <path d="M32,182 L46,187 L46,197 L32,197 Z M68,182 L54,187 L54,197 L68,197 Z" class="muscle-base" />
                            </g>
                        </g>
                    </svg>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-5">
                <div class="card p-5 border-b-4 border-blue-400 card-clickable cursor-pointer" onclick="showDetails('water')" id="water-home-card">
                    <div class="flex justify-between mb-2">
                        <p class="text-[10px] text-gray-400 font-bold uppercase">Hidrataci√≥n</p>
                        <i class="fas fa-info-circle text-blue-100 text-xs"></i>
                    </div>
                    <div class="flex items-end justify-between mb-3">
                        <div class="leading-none">
                            <span class="text-2xl font-bold text-slate-700 block" id="home-water">0</span>
                            <span class="text-[10px] text-gray-400 font-medium">/ <span id="home-water-goal">0</span> ml</span>
                        </div>
                        <i class="fas fa-glass-water text-blue-500 text-xl"></i>
                    </div>
                    <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                        <div id="mini-bar-water" class="bg-blue-400 h-full w-0 transition-all duration-500 rounded-full"></div>
                    </div>
                </div>

                <div class="card p-5 border-b-4 border-study card-clickable cursor-pointer" onclick="showDetails('study')">
                    <div class="flex justify-between mb-2">
                        <p class="text-[10px] text-gray-400 font-bold uppercase">Productividad</p>
                        <i class="fas fa-info-circle text-purple-100 text-xs"></i>
                    </div>
                    <div class="flex items-end justify-between mb-3">
                        <div class="leading-none">
                            <span class="text-2xl font-bold text-slate-700 block"><span id="home-study">0</span>h</span>
                            <span class="text-[10px] text-gray-400 font-medium" id="home-mobile">0h M√≥vil</span>
                        </div>
                        <i class="fas fa-brain text-study text-xl"></i>
                    </div>
                    <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                         <div id="mini-bar-study" class="bg-study h-full w-0 transition-all duration-500 rounded-full"></div>
                    </div>
                </div>
            </div>

            <div class="card p-5 mb-5 border-l-4 border-orange-500 card-clickable cursor-pointer" onclick="showDetails('sport')">
                <div class="flex justify-between mb-2">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Deporte & Actividad</p>
                    <i class="fas fa-dumbbell text-orange-400 text-xs"></i>
                </div>
                <div class="flex items-end justify-between mb-3">
                    <div class="leading-none">
                        <span class="text-2xl font-bold text-slate-700 block"><span id="home-sport-km">0</span> <span class="text-base font-normal text-gray-400">km</span></span>
                        <span class="text-[10px] text-gray-400 font-medium"><span id="home-steps">0</span> pasos</span>
                    </div>
                    <i class="fas fa-running text-orange-500 text-xl"></i>
                </div>
                <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                    <div id="bar-sport-home" class="bg-orange-500 h-full w-0 transition-all duration-500 rounded-full"></div>
                </div>
            </div>
            
            <div class="card p-6 card-clickable cursor-pointer" onclick="showDetails('nutrition')" id="food-home-card">
                <div class="flex justify-between items-center mb-5">
                    <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2"><i class="fas fa-fire text-orange-500"></i> Combustible (<span id="profile-weight-display">60</span>kg)</h3>
                    <span class="text-[10px] bg-orange-50 text-orange-600 px-3 py-1 rounded-full font-bold">Meta: <span id="goal-cals">2400</span> kcal</span>
                </div>

                <div class="space-y-5">
                    <div>
                        <div class="flex justify-between text-xs mb-1 font-bold text-slate-600">
                            <span>Energ√≠a Total</span>
                            <span><span id="val-cals">0</span> kcal</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden">
                            <div id="bar-cals" class="bg-slate-800 h-full rounded-full transition-all duration-700" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-[10px] text-gray-400 font-bold block mb-1">Prote√≠na</span>
                            <div class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden mb-1">
                                <div id="bar-prot" class="h-full bg-green-500 w-0 rounded-full"></div>
                            </div>
                            <span class="text-[10px] text-right block font-mono text-slate-600"><span id="val-prot">0</span>/<span id="goal-prot">0</span>g</span>
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-400 font-bold block mb-1">Carbos</span>
                            <div class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden mb-1">
                                <div id="bar-carbs" class="h-full bg-red-400 w-0 rounded-full"></div>
                            </div>
                            <span class="text-[10px] text-right block font-mono text-slate-600"><span id="val-carbs">0</span>/<span id="goal-carbs">0</span>g</span>
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-400 font-bold block mb-1">Grasas</span>
                            <div class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden mb-1">
                                <div id="bar-fat" class="h-full bg-yellow-400 w-0 rounded-full"></div>
                            </div>
                            <span class="text-[10px] text-right block font-mono text-slate-600"><span id="val-fat">0</span>/<span id="goal-fat">0</span>g</span>
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-400 font-bold block mb-1">G. Saturadas</span>
                            <div class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden mb-1">
                                <div id="bar-sat" class="h-full bg-yellow-600 w-0 rounded-full"></div>
                            </div>
                            <span class="text-[10px] text-right block font-mono text-slate-600"><span id="val-sat">0</span>/<span id="goal-sat">0</span>g</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="comida" class="page-section">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800 tracking-tight">Registro de Dieta</h2>
                <button onclick="openCustomFoodModal()" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-xs font-bold active:scale-95 transition shadow-lg shadow-slate-200">
                    + Crear Alimento
                </button>
            </div>
            
            <div class="relative mb-6">
                <input type="text" id="globalSearch" onkeyup="searchGlobal(this.value)" placeholder="üîç Buscar alimento..." class="w-full bg-white p-4 pl-12 rounded-2xl border border-gray-100 shadow-sm text-sm focus:ring-2 focus:ring-primary/20 outline-none transition">
                <div id="searchResults" class="absolute z-20 w-full bg-white shadow-xl rounded-xl mt-2 hidden max-h-60 overflow-y-auto border border-gray-100 px-2 py-2"></div>
            </div>

            <div id="foodCategoriesContainer" class="space-y-4 pb-8"></div>

            <div class="mt-6 pt-6 border-t border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Consumido Hoy</h3>
                    <span id="total-consumed-kcal" class="text-xs font-bold text-slate-800 bg-slate-100 px-2 py-1 rounded">0 kcal</span>
                </div>
                <div id="addedFoodsList" class="space-y-2 pb-24"></div>
            </div>
        </div>

        <div id="agua" class="page-section">
            <h2 class="text-2xl font-bold text-center text-slate-800 mb-1">Monitor de Hidrataci√≥n</h2>
            <div id="water-goal-text" class="text-center text-xs text-blue-600 font-bold bg-blue-50 py-1.5 px-4 rounded-full mx-auto w-max mb-8 border border-blue-100 shadow-sm">Meta din√°mica: Calculando...</div>
            
            <div class="flex flex-col items-center">
                <div class="relative w-64 h-64 mb-10 flex items-center justify-center">
                    <svg class="w-full h-full transform -rotate-90 filter drop-shadow-2xl">
                        <circle cx="128" cy="128" r="100" stroke="#f1f5f9" stroke-width="20" fill="transparent"/>
                        <circle id="water-circle" cx="128" cy="128" r="100" stroke="#3b82f6" stroke-width="20" fill="transparent" stroke-dasharray="628" stroke-dashoffset="628" stroke-linecap="round" class="transition-all duration-1000 ease-out"/>
                    </svg>
                    <div class="absolute text-center">
                        <i class="fas fa-droplet text-blue-400 text-3xl mb-2 animate-bounce"></i>
                        <span id="water-display-lg" class="text-5xl font-black text-slate-800 block tracking-tighter">0</span>
                        <span class="text-sm text-gray-400 font-medium">ml bebidos</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 w-full px-2">
                    <div class="flex flex-col gap-2">
                        <button onclick="addWater(250)" class="bg-white py-6 rounded-3xl shadow-lg shadow-blue-50 border border-blue-50 hover:border-blue-300 active:scale-95 transition flex flex-col items-center justify-center gap-2 group w-full">
                            <div class="bg-blue-50 w-14 h-14 rounded-full flex items-center justify-center group-hover:bg-blue-500 transition-colors"><i class="fas fa-glass-water text-blue-500 group-hover:text-white transition-colors text-xl"></i></div>
                            <span class="font-bold text-slate-600 text-sm">Vaso<br><span class="text-xs text-gray-400 font-normal">250 ml</span></span>
                        </button>
                        <button onclick="removeWater(250)" class="text-[10px] text-red-400 font-bold bg-red-50 py-2 rounded-xl hover:bg-red-100 transition">
                            <i class="fas fa-minus mr-1"></i> Quitar (-250ml)
                        </button>
                    </div>

                    <div class="flex flex-col gap-2">
                        <button onclick="addWater(1000)" class="bg-white py-6 rounded-3xl shadow-lg shadow-blue-50 border border-blue-50 hover:border-blue-300 active:scale-95 transition flex flex-col items-center justify-center gap-2 group w-full">
                            <div class="bg-blue-50 w-14 h-14 rounded-full flex items-center justify-center group-hover:bg-blue-500 transition-colors"><i class="fas fa-bottle-water text-blue-600 group-hover:text-white transition-colors text-xl"></i></div>
                            <span class="font-bold text-slate-600 text-sm">Garrafa<br><span class="text-xs text-gray-400 font-normal">1000 ml</span></span>
                        </button>
                        <button onclick="removeWater(1000)" class="text-[10px] text-red-400 font-bold bg-red-50 py-2 rounded-xl hover:bg-red-100 transition">
                            <i class="fas fa-minus mr-1"></i> Quitar (-1000ml)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="estudio" class="page-section">
            <h2 class="text-2xl font-bold mb-6 text-slate-800 tracking-tight">Carga Cognitiva</h2>
            
            <div class="card p-6 mb-6">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-mobile-alt text-slate-500"></i> Uso del M√≥vil</h3>
                <div class="mb-2">
                    <div class="flex justify-between text-xs font-bold text-gray-500 mb-2">
                        <span>Horas de pantalla hoy</span>
                        <span class="text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded"><span id="val-mobile">0</span> horas</span>
                    </div>
                    <input type="range" min="0" max="12" step="0.5" value="0" id="range-mobile" oninput="updateMobile()">
                    <p class="text-[10px] text-gray-400 mt-2 italic">*Cada hora de m√≥vil suma un 5% a tu carga mental.</p>
                </div>
            </div>

            <div class="card p-6 mb-6">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-clock text-study"></i> Nueva Sesi√≥n Estudio</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">Duraci√≥n (Horas)</label>
                        <input type="number" id="session-hours" placeholder="ej: 4" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-3 font-bold text-slate-700 outline-none focus:border-study">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">Foco</label>
                        <select id="session-focus" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-3 font-bold text-slate-700 outline-none focus:border-study">
                            <option value="1">Bajo / Distra√≠do</option>
                            <option value="2" selected>Medio / Normal</option>
                            <option value="3">Alto / Deep Work</option>
                        </select>
                    </div>
                </div>
                <button onclick="addStudySession()" class="w-full bg-study text-white font-bold py-3 rounded-xl shadow-lg shadow-purple-100 active:scale-95 transition">
                    + A√±adir Sesi√≥n
                </button>
            </div>

            <div class="card p-6 mb-24">
                <div class="flex justify-between items-center mb-4">
                     <h3 class="font-bold text-slate-700 text-sm">Sesiones Hoy</h3>
                     <span class="text-xs font-bold text-study bg-purple-50 px-2 py-1 rounded" id="total-study-hours-display">0 horas</span>
                </div>
                <div id="studySessionsList" class="space-y-3">
                    <p class="text-center text-gray-300 text-xs italic py-4">No hay sesiones registradas hoy.</p>
                </div>
            </div>
        </div>

        <div id="deporte" class="page-section">
            <h2 class="text-2xl font-bold mb-6 text-slate-800 tracking-tight">Actividad & Gym</h2>

            <div class="card p-6 mb-6 border-l-4 border-green-500">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-shoe-prints text-green-500"></i> Actividad de Hoy</h3>
                <div class="space-y-5">
                    <div>
                        <div class="flex justify-between text-xs font-bold text-gray-500 mb-2">
                            <span>Pasos Totales</span>
                            <span class="text-green-600 bg-green-50 px-2 py-0.5 rounded"><span id="val-steps">0</span></span>
                        </div>
                        <input type="range" min="0" max="30000" step="100" value="0" id="range-steps" oninput="updateSport()">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs font-bold text-gray-500 mb-2">
                            <span>Horas de pie</span>
                            <span class="text-slate-600 bg-slate-50 px-2 py-0.5 rounded"><span id="val-standing">0</span> h</span>
                        </div>
                        <input type="range" min="0" max="16" step="0.5" value="0" id="range-standing" oninput="updateSport()">
                    </div>
                </div>
            </div>
            
            <div class="card p-6 mb-6 border-l-4 border-orange-500">
                <div class="flex items-center gap-4 mb-6">
                    <div class="bg-orange-100 p-3 rounded-xl text-orange-600 shadow-sm"><i class="fas fa-running text-2xl"></i></div>
                    <div>
                        <h3 class="font-bold text-slate-700 text-lg">Running</h3>
                        <p class="text-[10px] text-gray-400 font-bold uppercase">Cardio / Quema Grasa</p>
                    </div>
                </div>
                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between text-xs font-bold text-gray-500 mb-2">
                            <span>Distancia</span>
                            <span class="text-orange-600 bg-orange-50 px-2 py-0.5 rounded"><span id="val-run-km">0</span> km</span>
                        </div>
                        <input type="range" min="0" max="30" step="0.5" value="0" id="range-run-km" oninput="updateSport()">
                    </div>
                    
                    <div class="flex gap-4">
                        <div class="w-1/2 p-3 bg-gray-50 rounded-xl text-center">
                            <label class="text-[10px] font-bold text-gray-400 uppercase block mb-2">Ritmo (min/km)</label>
                            <input type="range" min="3" max="8" step="0.1" value="5.5" id="range-run-pace" oninput="updateSport()">
                            <div class="text-sm font-black text-slate-700 mt-1"><span id="val-run-pace">5:30</span></div>
                        </div>
                        <div class="w-1/2 p-3 bg-gray-50 rounded-xl text-center">
                            <label class="text-[10px] font-bold text-gray-400 uppercase block mb-2">Intensidad</label>
                            <input type="range" min="1" max="3" step="1" value="2" id="range-run-int" oninput="updateSport()">
                            <div class="text-sm font-black text-slate-700 mt-1" id="val-run-int-text">Normal</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-6 mb-6 border-l-4 border-indigo-500">
                <div class="flex items-center gap-4 mb-6">
                    <div class="bg-indigo-100 p-3 rounded-xl text-indigo-600 shadow-sm"><i class="fas fa-bicycle text-2xl"></i></div>
                    <div>
                        <h3 class="font-bold text-slate-700 text-lg">Ciclismo</h3>
                        <p class="text-[10px] text-gray-400 font-bold uppercase">Resistencia / Pierna</p>
                    </div>
                </div>
                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between text-xs font-bold text-gray-500 mb-2">
                            <span>Distancia</span>
                            <span class="text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded"><span id="val-bike-km">0</span> km</span>
                        </div>
                        <input type="range" min="0" max="100" step="1" value="0" id="range-bike-km" oninput="updateSport()">
                    </div>
                    <div class="p-3 bg-gray-50 rounded-xl text-center">
                        <label class="text-[10px] font-bold text-gray-400 uppercase block mb-2">Intensidad</label>
                        <input type="range" min="1" max="3" step="1" value="2" id="range-bike-int" oninput="updateSport()">
                        <div class="text-sm font-black text-slate-700 mt-1" id="val-bike-int-text">Normal</div>
                    </div>
                </div>
            </div>

            <div class="card p-6 mb-24 border-l-4 border-slate-800">
                <div class="flex items-center gap-4 mb-6">
                    <div class="bg-slate-800 p-3 rounded-xl text-white shadow-sm"><i class="fas fa-dumbbell text-2xl"></i></div>
                    <div>
                        <h3 class="font-bold text-slate-700 text-lg">Sesiones de Gym</h3>
                        <p class="text-[10px] text-gray-400 font-bold uppercase">Hipertrofia & Fuerza</p>
                    </div>
                </div>
                
                <!-- Formulario Nueva Sesi√≥n Gym -->
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-4">
                    <label class="text-[10px] font-bold text-gray-400 uppercase block mb-2">A√±adir Ejercicio</label>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <select id="gym-muscle-select" class="w-full bg-white border border-gray-200 rounded-lg p-2 text-xs font-bold text-slate-700">
                            <option value="pecho">Pectoral</option>
                            <option value="espalda">Espalda</option>
                            <option value="pierna">Pierna</option>
                            <option value="brazos">Brazos (B√≠ceps/Tr√≠ceps)</option>
                            <option value="hombro">Hombro</option>
                            <option value="abs">Abdomen</option>
                            <option value="cardio">Cardio Gym</option>
                        </select>
                        <input type="number" id="gym-session-time" placeholder="Minutos" class="w-full bg-white border border-gray-200 rounded-lg p-2 text-xs font-bold text-slate-700">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">Intensidad</label>
                        <input type="range" min="1" max="3" step="1" value="2" id="gym-session-int" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-[10px] text-gray-400 px-1"><span>Suave</span><span>Media</span><span>Fallo</span></div>
                    </div>
                    <button onclick="addGymSession()" class="w-full mt-3 bg-slate-800 text-white text-xs font-bold py-2 rounded-lg hover:bg-slate-700 transition">+ A√±adir Sesi√≥n</button>
                </div>

                <!-- Lista de Sesiones -->
                <div id="gymSessionsList" class="space-y-2"></div>
                
                <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center">
                    <span class="text-xs font-bold text-gray-500">Total Tiempo:</span>
                    <span class="text-sm font-black text-slate-800" id="total-gym-time-display">0 min</span>
                </div>
                <div class="mt-1 flex justify-between items-center">
                    <span class="text-xs font-bold text-gray-500">Kcal Aprox:</span>
                    <input type="number" id="gym-cals" placeholder="Manual" oninput="updateSport()" class="w-20 text-right bg-transparent border-b border-gray-300 text-xs font-bold text-slate-700 focus:outline-none">
                </div>
            </div>

        </div>

        <div id="registro" class="page-section">
            <h2 class="text-2xl font-bold mb-6 text-slate-800 tracking-tight">Historial de Informes</h2>
            <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 mb-6">
                <p class="text-xs text-yellow-700"><i class="fas fa-mobile-alt mr-1"></i> <b>Nota:</b> Si la guardas por error, usa el bot√≥n de "flecha" para devolverla al d√≠a de hoy.</p>
            </div>
            <div id="historyList" class="space-y-4 pb-24"></div>
        </div>

    </main>

    <div id="info-modal" class="fixed inset-0 z-[60] bg-slate-900/60 backdrop-blur-sm modal-overlay items-center justify-center p-5" onclick="closeModal(event)">
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl modal-content overflow-hidden" onclick="event.stopPropagation()">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-black text-slate-800">Detalles</h3>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-white text-gray-400 hover:text-red-500 shadow-sm flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            <div id="modal-body" class="p-6 max-h-[70vh] overflow-y-auto space-y-4">
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 w-full bg-white/95 backdrop-blur-lg border-t border-gray-100 py-3 px-2 flex justify-between items-center z-50 pb-safe-area pb-6">
        <button onclick="navigateTo('inicio')" class="nav-item active flex flex-col items-center w-1/5 group" id="nav-inicio">
            <i class="fas fa-home text-xl mb-1 group-active:scale-90 transition"></i><span class="text-[10px] font-bold">Inicio</span>
        </button>
        <button onclick="navigateTo('comida')" class="nav-item flex flex-col items-center w-1/5 group" id="nav-comida">
            <i class="fas fa-apple-whole text-xl mb-1 group-active:scale-90 transition"></i><span class="text-[10px] font-bold">Dieta</span>
        </button>
        <button onclick="navigateTo('agua')" class="nav-item flex flex-col items-center w-1/5 group" id="nav-agua">
            <i class="fas fa-droplet text-xl mb-1 group-active:scale-90 transition"></i><span class="text-[10px] font-bold">Agua</span>
        </button>
        <button onclick="navigateTo('estudio')" class="nav-item flex flex-col items-center w-1/5 group" id="nav-estudio">
            <i class="fas fa-book-open text-xl mb-1 group-active:scale-90 transition"></i><span class="text-[10px] font-bold">Estudio</span>
        </button>
        <button onclick="navigateTo('deporte')" class="nav-item flex flex-col items-center w-1/5 group" id="nav-deporte">
            <i class="fas fa-dumbbell text-xl mb-1 group-active:scale-90 transition"></i><span class="text-[10px] font-bold">Gym</span>
        </button>
    </nav>

    <script>
        // ==========================================================================================
        // üß¨ CONFIGURACI√ìN: PERFIL BIOL√ìGICO REACTIVO
        // ==========================================================================================
        
        let USER_BIO = JSON.parse(localStorage.getItem('user_bio_config')) || {
            nombre: "Atleta",
            genero: "hombre",
            edad: 18,
            altura: 168,
            peso: 60,
            grasa: 12,
            masaMuscular: 50,
            ubicacion: "Petrer",
            maxRunKm: 5,     // Personal Record Running
            maxGymTime: 60,  // Personal Record Gym Time
            maxBikeKm: 25    // Personal Record Bike
        };

        const MONTH_NAMES = ["ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV", "DIC"];

        // ==========================================================================================
        // üå°Ô∏è DATASET CLIMATOL√ìGICO - Temperaturas reales por mes
        // ==========================================================================================
        const CLIMA_PETRER = [
            { t: 16, h: 65, icon: '‚ùÑÔ∏è' }, // Enero - Fr√≠o
            { t: 17, h: 62, icon: '‚ùÑÔ∏è' }, // Febrero - Fr√≠o
            { t: 20, h: 58, icon: 'üå∏' }, // Marzo - Primavera
            { t: 22, h: 55, icon: 'üå∏' }, // Abril - Primavera
            { t: 26, h: 52, icon: '‚òÄÔ∏è' }, // Mayo - C√°lido
            { t: 30, h: 50, icon: '‚òÄÔ∏è' }, // Junio - Calor
            { t: 33, h: 48, icon: 'üî•' }, // Julio - Muy caluroso
            { t: 34, h: 55, icon: 'üî•' }, // Agosto - Muy caluroso
            { t: 29, h: 60, icon: '‚òÄÔ∏è' }, // Septiembre - C√°lido
            { t: 24, h: 65, icon: 'üçÇ' }, // Octubre - Oto√±o
            { t: 19, h: 68, icon: 'üçÇ' }, // Noviembre - Oto√±o
            { t: 16, h: 70, icon: '‚ùÑÔ∏è' }  // Diciembre - Fr√≠o
        ];

        // ==========================================================================================
        // üß¨ MATRIZ BIOL√ìGICA DE ALTA PRECISI√ìN (DR. AI)
        // ==========================================================================================
        const BIO_DATABASE = {
            hombre: [
                { min: 18, max: 20, sleep: [8.5, 10], water: 45, meta: 1.15, mobileTol: 'dopamine', msg: "Sensibilidad Dopamina: MAX. M√≥vil >3h destroza la motivaci√≥n." },
                { min: 21, max: 23, sleep: [8, 9],    water: 42, meta: 1.10, mobileTol: 'insomnia', msg: "Corteza Prefrontal cerr√°ndose. M√≥vil nocturno causa insomnio severo." },
                { min: 24, max: 26, sleep: [7.5, 9],  water: 40, meta: 1.05, mobileTol: 'focus',    msg: "Foco m√°ximo. El Deep Work consume mucha glucosa." },
                { min: 27, max: 29, sleep: [7.5, 8.5],water: 38, meta: 0.97, mobileTol: 'stress',   msg: "Estr√©s laboral inicia. Cortisol sube. Desconexi√≥n necesaria." },
                { min: 30, max: 33, sleep: [7, 8],    water: 35, meta: 0.95, mobileTol: 'blue',     msg: "Recuperaci√≥n lenta. Luz azul afecta m√°s al sue√±o profundo." },
                { min: 34, max: 37, sleep: [7, 8],    water: 35, meta: 0.95, mobileTol: 'sedentary',msg: "Si duermes mal, testosterona cae 15%. Sedentarismo mata cerebro." },
                { min: 38, max: 41, sleep: [7, 8],    water: 33, meta: 0.92, mobileTol: 'memory',   msg: "Riesgo apnea. Memoria corto plazo falla con estr√©s." },
                { min: 42, max: 45, sleep: [7, 7.5],  water: 33, meta: 0.90, mobileTol: 'vision',   msg: "Visi√≥n cansada. El m√≥vil cansa la vista el triple." },
                { min: 46, max: 50, sleep: [7, 7.5],  water: 33, meta: 0.88, mobileTol: 'rigidity', msg: "Alerta Muscular. Si no entrenas fuerza, pierdes 0.5kg m√∫sculo/a√±o." },
                { min: 50, max: 60, sleep: [6.5, 7.5],water: 30, meta: 0.85, mobileTol: 'prostate', msg: "Menor sed. Beber por horario. Prioridad salud √≥sea." },
                { min: 60, max: 120,sleep: [6, 7],    water: 30, meta: 0.80, mobileTol: 'confusion',msg: "Deshidrataci√≥n causa confusi√≥n mental inmediata." }
            ],
            mujer: [
                { min: 18, max: 20, sleep: [9, 10],   water: 40, meta: 1.10, mobileTol: 'social',   msg: "Alta necesidad sue√±o. Ansiedad social por RRSS afecta ciclo." },
                { min: 21, max: 23, sleep: [8, 9],    water: 38, meta: 1.08, mobileTol: 'migraine', msg: "Pico fertilidad. Hidrataci√≥n clave para migra√±as." },
                { min: 24, max: 26, sleep: [8, 9],    water: 36, meta: 1.05, mobileTol: 'skin',     msg: "Estr√©s afecta piel/pelo inmediatamente. Vigila B12." },
                { min: 27, max: 29, sleep: [7.5, 8.5],water: 35, meta: 0.98, mobileTol: 'pms',      msg: "Sensibilidad emocional PMS. Metabolismo desciende levemente." },
                { min: 30, max: 33, sleep: [7.5, 8.5],water: 33, meta: 0.95, mobileTol: 'collagen', msg: "Calidad sue√±o vital para col√°geno. Masa muscular dif√≠cil de ganar." },
                { min: 34, max: 37, sleep: [7, 8],    water: 33, meta: 0.92, mobileTol: 'adrenal',  msg: "Riesgo hipotiroidismo si sue√±o <6h. Fatiga suprarrenal." },
                { min: 38, max: 41, sleep: [7, 8],    water: 31, meta: 0.90, mobileTol: 'fog',      msg: "Niebla mental por progesterona. Cardio solo no funciona." },
                { min: 42, max: 45, sleep: [7, 7.5],  water: 31, meta: 0.88, mobileTol: 'anxiety',  msg: "Perimenopausia posible. M√≥vil noche empeora ansiedad." },
                { min: 46, max: 50, sleep: [7, 7.5],  water: 31, meta: 0.85, mobileTol: 'estrogen', msg: "Bajada estr√≥genos. Colesterol puede subir solo." },
                { min: 50, max: 60, sleep: [6.5, 7.5],water: 30, meta: 0.82, mobileTol: 'dry',      msg: "Piel seca indica falta agua. Riesgo Alzheimer > hombres." },
                { min: 60, max: 120,sleep: [6, 7],    water: 30, meta: 0.78, mobileTol: 'thirst',   msg: "La sed desaparece. Programar alarmas para beber." }
            ]
        };

        // üß† BIO-ENGINE
        // ==========================================================================================
        class BioEngine {
            constructor() {
                this.weights = JSON.parse(localStorage.getItem('bio_weights')) || {
                    fatigueSensitivity: 1.2,
                    sleepEfficiency: 1.0,
                    recoveryFatigueFactor: 1.0 
                };
            }

            getBioProfile(age, gender) {
                const g = gender.toLowerCase() === 'mujer' ? 'mujer' : 'hombre';
                const list = BIO_DATABASE[g];
                // Buscar rango exacto o devolver el √∫ltimo (m√°s viejo) por defecto
                return list.find(r => age >= r.min && age <= r.max) || list[list.length - 1];
            }

            recalculateBiologicalProfile() {
                const profile = this.getBioProfile(USER_BIO.edad, USER_BIO.genero);
                
                // Factor de recuperaci√≥n (0.5 lento - 1.5 r√°pido)
                let recoveryFactor = (100 - USER_BIO.edad) / 80; 
                if (USER_BIO.masaMuscular > 40) recoveryFactor += 0.2; // M√°s m√∫sculo ayuda metab√≥licamente
                
                return { sleepNeed: profile.sleep, recoveryFactor, profileData: profile };
            }

            getBMR() {
                let base = (10 * USER_BIO.peso) + (6.25 * USER_BIO.altura) - (5 * USER_BIO.edad);
                if (USER_BIO.genero === "hombre") base += 5;
                else base -= 161;
                
                if(USER_BIO.masaMuscular > 0 && USER_BIO.grasa < 15) {
                    base *= 1.1; // Bonus muscular
                }
                
                const profile = this.getBioProfile(USER_BIO.edad, USER_BIO.genero);
                return base * profile.meta; // Ajuste metab√≥lico por edad
            }

            getClimateStress() {
                const month = new Date().getMonth();
                const data = CLIMA_PETRER[month];
                let waterFactor = 1.0;
                let thermalFatigue = 0;

                if (data.t > 25) { 
                    let extraDegrees = data.t - 25;
                    waterFactor += (extraDegrees * 0.05); 
                    thermalFatigue = 10;
                }
                
                let termogenesis = (data.t < 15) ? 100 : 0;
                return { waterFactor, termogenesisKcal: termogenesis, temp: data.t, thermalFatigue, icon: data.icon };
            }

            analyzeBodyComposition() {
                // An√°lisis f√≠sico basado en datos del usuario
                const { peso, altura, grasa, masaMuscular, edad, genero, maxRunKm, maxGymTime, maxBikeKm } = USER_BIO;
                const heightM = altura / 100;
                const bmi = peso / (heightM * heightM);
                
                // 1. Calcular Nivel Atl√©tico (Ignorando valores a 0)
                let performanceScore = 0;
                let activeStats = 0;
                
                // Running: >10km es avanzado
                if (maxRunKm > 0) { 
                    activeStats++; 
                    performanceScore += Math.min(maxRunKm / 10, 1.5); 
                }
                // Gym: >90min es volumen alto
                if (maxGymTime > 0) { 
                    activeStats++; 
                    performanceScore += Math.min(maxGymTime / 90, 1.5); 
                }
                // Bici: >40km es avanzado
                if (maxBikeKm > 0) { 
                    activeStats++; 
                    performanceScore += Math.min(maxBikeKm / 40, 1.5); 
                }

                const fitnessLevel = activeStats > 0 ? (performanceScore / activeStats) : 0; // 0 a 1.5

                let status = "Normal";
                let advice = "Mant√©n tu rutina.";
                let colorClass = "text-slate-600";

                // L√≠mites de grasa seg√∫n g√©nero
                const fatLimitHigh = genero === 'hombre' ? 25 : 32;
                const fatLimitMid = genero === 'hombre' ? 20 : 28;
                const fatAthletic = genero === 'hombre' ? 15 : 22;
                const muscleRatio = masaMuscular / peso; // % de peso que es m√∫sculo

                // --- L√ìGICA DE DIAGN√ìSTICO ---

                // 1. OBESIDAD / SOBREPESO (Prioridad Alta)
                if (bmi > 30 && grasa > fatLimitHigh) {
                    status = "‚ö†Ô∏è OBESIDAD (Nivel Alto)";
                    colorClass = "text-red-600";
                    advice = "ALERTA: Riesgo cardiovascular. Prioridad absoluta: D√©ficit cal√≥rico agresivo y caminar (evita correr por impacto).";
                } 
                else if (bmi > 27 && grasa > fatLimitHigh) {
                    status = "‚ö†Ô∏è OBESIDAD (Nivel Medio)";
                    colorClass = "text-red-500";
                    advice = "Necesitas perder grasa urgentemente. Reduce carbohidratos y elimina az√∫cares ya.";
                }
                else if ((bmi > 25 || grasa > fatLimitMid) && muscleRatio < 0.35) {
                    status = "üü† SOBREPESO / SEDENTARIO";
                    colorClass = "text-orange-500";
                    advice = "Tienes exceso de energ√≠a acumulada. Aumenta el cardio y reduce la cena.";
                }
                // 2. FALSO DELGADO (Peso normal, pero mucha grasa y poco m√∫sculo)
                else if (bmi < 25 && grasa > fatLimitMid && muscleRatio < 0.35) {
                    status = "üü° FALSO DELGADO (Skinny Fat)";
                    colorClass = "text-yellow-600";
                    advice = "Tu peso est√° bien, pero te falta tono muscular y te sobra grasa. Haz pesas y come prote√≠na.";
                }
                // 3. DELGADO / ECTOMORFO
                else if (bmi < 19 || (grasa < 10 && muscleRatio < 0.4)) {
                    status = "üîµ ECTOMORFO / DELGADO";
                    colorClass = "text-blue-500";
                    advice = "Metabolismo muy r√°pido. Necesitas super√°vit cal√≥rico (comer m√°s) y levantar pesado para crecer.";
                }
                // 4. FUERTE PERO CON GRASA (Endomorfo fuerte / Powerlifter)
                else if (muscleRatio > 0.4 && grasa > fatAthletic) {
                    status = "üü§ ENDOMORFO FUERTE";
                    colorClass = "text-amber-700";
                    advice = `Tienes mucha fuerza (Nivel Fit: ${(fitnessLevel*100).toFixed(0)}%), pero la grasa tapa tu definici√≥n. Haz cardio post-pesas.`;
                }
                // 5. ATL√âTICO / EST√âTICO
                else if (muscleRatio > 0.42 && grasa <= fatAthletic) {
                    status = "üü¢ CUERPO EST√âTICO / ATL√âTICO";
                    colorClass = "text-green-600";
                    advice = `Excelente composici√≥n (${edad} a√±os). Est√°s en el top f√≠sico. Mant√©n rendimiento y define detalles.`;
                }
                // 6. NORMAL
                else {
                    status = "‚öñÔ∏è COMPOSICI√ìN NORMAL";
                    colorClass = "text-slate-600";
                    advice = "Est√°s saludable. Para verte mejor, sube ligeramente la prote√≠na y entrena fuerza.";
                }
                
                // Ajuste por edad
                if (edad > 50 && status.includes("NORMAL")) {
                    advice += " A tu edad, prioriza la masa muscular para proteger huesos.";
                }
                
                return { status, advice, bmi: bmi.toFixed(1), colorClass };
            }

            calculateSleepScore(hours, quality = 100) {
                const profile = this.getBioProfile(USER_BIO.edad, USER_BIO.genero);
                const [minSleep, maxSleep] = profile.sleep;
                
                // Correcci√≥n Dr. AI: Sue√±o Real = Horas * (Calidad/100)
                // Si no hay dato de calidad (0), asumimos 80% por defecto para no penalizar tanto
                const qFactor = quality > 0 ? (quality / 100) : 0.85;
                const realSleep = hours * qFactor;

                if (realSleep < minSleep) {
                    // Falta de sue√±o (Penalizaci√≥n exponencial)
                    // Ejemplo: Necesita 8, duerme 6 reales -> deficit 2 -> -40 pts
                    return Math.max(0, 100 - ((minSleep - realSleep) * 20)); 
                } else if (realSleep > maxSleep + 1.5) {
                    // Letargo
                    const optimalMax = maxSleep;
                    return Math.max(50, 100 - ((realSleep - optimalMax) * 15));
                }
                return 100; // Zona √ìptima
            }

            analyzeHormones(fatIntake, sleepHours) {
                const minFat = USER_BIO.peso * 0.8;
                if (fatIntake < minFat) {
                    return { status: 'ALERTA', advice: `‚ö†Ô∏è Grasa baja. Peligro testosterona baja.` };
                }
                return { status: 'OPTIMO', advice: "" };
            }

            predictTomorrow(lastDayData, climateData) {
                const { recoveryFactor } = this.recalculateBiologicalProfile();
                const scores = lastDayData.stressScores || { physical: 50, mental: 30 };
                const lastMood = lastDayData.subjective ? lastDayData.subjective.mood : 'NEUTRAL';
                
                // Recuperaci√≥n basada en edad y m√∫sculo
                const physicalPenalty = (scores.physical * 0.6 * this.weights.fatigueSensitivity) / recoveryFactor;
                const mentalPenalty = (scores.mental * 0.3) / recoveryFactor;
                const sleepRecovery = (lastDayData.sleepHours / 8) * 100;
                
                let moodPenalty = 0;
                if (lastMood === 'SAD') moodPenalty = 20;
                if (lastMood === 'STRESSED') moodPenalty = 15;

                let battery = sleepRecovery; 
                battery -= physicalPenalty;
                battery -= mentalPenalty;
                battery -= moodPenalty;
                battery -= (climateData.thermalFatigue || 0);

                const result = Math.min(Math.max(Math.round(battery), 10), 100);
                return isNaN(result) ? 50 : result; // Evitar NaN
            }

            predictMentalPerformance(lastDayData) {
                const scores = lastDayData.stressScores || { mental: 30 };
                const sleepHours = lastDayData.sleepHours || 7;
                
                // Si la carga mental de ayer fue alta, hoy rindes menos
                let mentalScore = 100 - (scores.mental * 0.4);
                
                // Ajuste por sue√±o
                if (sleepHours < 6) mentalScore -= 25;
                else if (sleepHours < 7) mentalScore -= 15;
                else if (sleepHours > 8) mentalScore += 5;
                
                return Math.min(Math.max(Math.round(mentalScore), 10), 100);
            }

            predictPhysicalPerformance(lastDayData) {
                const scores = lastDayData.stressScores || { physical: 50 };
                const sleepHours = lastDayData.sleepHours || 7;
                
                let physicalScore = 100 - (scores.physical * 0.5);
                
                if (sleepHours < 6) physicalScore -= 25;
                else if (sleepHours < 7) physicalScore -= 15;
                
                return Math.min(Math.max(Math.round(physicalScore), 10), 100);
            }

            learn(predicted, actual) {
                const error = actual - predicted;
                if (error < -20) this.weights.fatigueSensitivity += 0.1;
                else if (error > 20) this.weights.fatigueSensitivity -= 0.05;
                localStorage.setItem('bio_weights', JSON.stringify(this.weights));
            }

            generateDailyAdvice(history) {
                if (!history || history.length === 0) return "Bienvenido. Registra tu primer d√≠a para calibrar el motor.";
                
                const yesterday = history[0];
                const sessions = yesterday.data.gymSessions || [];
                const runIntensity = (yesterday.data.runKm / USER_BIO.maxRunKm) * 100;
                const { recoveryFactor, profileData } = this.recalculateBiologicalProfile();

                let advice = `<b>${profileData.msg}</b> `;
                const hasLegs = sessions.some(s => s.muscle === 'pierna');

                if (hasLegs && runIntensity > 80) {
                    advice += "Ayer machacaste piernas y corriste fuerte. Hoy el tren inferior est√° en zona roja. Descanso activo o tren superior.";
                } else if (yesterday.stressScores.mental > 80) {
                    advice += "Detectada alta carga cognitiva ayer. Hoy prioriza sue√±o y grasas saludables.";
                } else {
                    advice += "Sistemas estables. Puedes buscar un PR hoy.";
                }
                return advice;
            }
        }

        const ENGINE = new BioEngine();

        // ==========================================================================================
        // üì¶ BASE DE DATOS
        // ==========================================================================================
        const foodDatabase = {
            'Desayuno': [ { name: 'Cafe con leche', cal: 68.8, prot: 8, fat: 0.8, sat: 0.48, carb: 12, weight: 200 }, { name: 'Cafe con leche + proteina', cal: 127.8, prot: 19.5, fat: 1.7, sat: 1.03, carb: 15, weight: 200 }, { name: '1 panecillo', cal: 27.03, prot: 3.75, fat: 0.89, sat: 0.21, carb: 5, weight: 50 }, { name: 'Tortilla (3 claras + 1 yema)', cal: 145, prot: 16, fat: 5, sat: 1.5, carb: 1, weight: 150 }, { name: 'Avena con Leche', cal: 220, prot: 10, fat: 4, sat: 1, carb: 35, weight: 250 } ],
            'Almuerzo': [ { name: 'Bocadillo de jam√≥n', cal: 400, prot: 25, fat: 15, sat: 5, carb: 45, weight: 150 }, { name: 'Fruta gen√©rica', cal: 200, prot: 10, fat: 8, sat: 3, carb: 25, weight: 100 } ],
            'Comida': [ { name: 'Cafe con leche', cal: 68.8, prot: 8, fat: 0.8, sat: 0.48, carb: 12, weight: 200 }, { name: 'Cafe con leche + proteina', cal: 127.8, prot: 19.5, fat: 1.7, sat: 1.03, carb: 15, weight: 200 } ],
            'Merienda': [ { name: 'Frutos secos', cal: 200, prot: 10, fat: 5, sat: 2, carb: 20, weight: 50 }, { name: 'Yogur natural', cal: 150, prot: 8, fat: 3, sat: 1, carb: 18, weight: 125 } ],
            'Cena': [ { name: '1 panecillo', cal: 27.03, prot: 3.75, fat: 0.89, sat: 0.21, carb: 5, weight: 50 } ],
            'Frutas': [ { name: 'Manzana', cal: 52, prot: 0.3, fat: 0.2, sat: 0.03, carb: 13.8, weight: 150 }, { name: 'Pl√°tano', cal: 89, prot: 1.1, fat: 0.3, sat: 0.11, carb: 22.8, weight: 120 }, { name: 'Fresa', cal: 32, prot: 0.7, fat: 0.3, sat: 0.02, carb: 7.7, weight: 50 }, { name: 'Sand√≠a', cal: 30, prot: 0.6, fat: 0.2, sat: 0.02, carb: 7.6, weight: 200 }, { name: 'Mel√≥n', cal: 34, prot: 0.8, fat: 0.2, sat: 0.05, carb: 8.2, weight: 150 }, { name: 'Uvas', cal: 69, prot: 0.7, fat: 0.2, sat: 0.07, carb: 18.1, weight: 100 }, { name: 'Pera', cal: 57, prot: 0.4, fat: 0.1, sat: 0.02, carb: 15.2, weight: 170 }, { name: 'Pi√±a', cal: 50, prot: 0.5, fat: 0.1, sat: 0.01, carb: 13.1, weight: 200 }, { name: 'Kiwi', cal: 61, prot: 1.1, fat: 0.5, sat: 0.03, carb: 14.7, weight: 75 }, { name: 'Mango', cal: 60, prot: 0.8, fat: 0.4, sat: 0.09, carb: 15, weight: 200 }, { name: 'Naranja', cal: 47, prot: 0.9, fat: 0.1, sat: 0.02, carb: 11.8, weight: 150 }, { name: 'Lim√≥n', cal: 29, prot: 1.1, fat: 0.3, sat: 0.04, carb: 9.3, weight: 100 }, { name: 'Cereza', cal: 63, prot: 1.1, fat: 0.2, sat: 0.04, carb: 16, weight: 50 }, { name: 'Melocot√≥n', cal: 39, prot: 0.9, fat: 0.3, sat: 0.02, carb: 9.5, weight: 150 }, { name: 'Albaricoque', cal: 48, prot: 1.4, fat: 0.4, sat: 0.03, carb: 11.1, weight: 60 }, { name: 'Granada', cal: 83, prot: 1.7, fat: 1.2, sat: 0.12, carb: 18.7, weight: 200 }, { name: 'Papaya', cal: 43, prot: 0.5, fat: 0.3, sat: 0.08, carb: 11, weight: 200 }, { name: 'Higo', cal: 74, prot: 0.8, fat: 0.3, sat: 0.06, carb: 19.2, weight: 50 }, { name: 'Ciruela', cal: 46, prot: 0.7, fat: 0.3, sat: 0.02, carb: 11.4, weight: 60 } ],
            'Verduras': [ { name: 'Tomate', cal: 18, prot: 0.9, fat: 0.2, sat: 0.03, carb: 3.9, weight: 120 }, { name: 'Lechuga', cal: 15, prot: 1.4, fat: 0.2, sat: 0.03, carb: 2.9, weight: 50 }, { name: 'Espinaca', cal: 23, prot: 2.9, fat: 0.4, sat: 0.06, carb: 3.6, weight: 30 }, { name: 'Br√≥coli', cal: 34, prot: 2.8, fat: 0.4, sat: 0.04, carb: 6.6, weight: 150 }, { name: 'Calabac√≠n', cal: 17, prot: 1.2, fat: 0.3, sat: 0.05, carb: 3.1, weight: 200 }, { name: 'Zanahoria', cal: 41, prot: 0.9, fat: 0.2, sat: 0.03, carb: 9.6, weight: 75 }, { name: 'Pepino', cal: 16, prot: 0.7, fat: 0.1, sat: 0.02, carb: 3.6, weight: 200 }, { name: 'Cebolla', cal: 40, prot: 1.1, fat: 0.1, sat: 0.02, carb: 9.3, weight: 100 }, { name: 'Ajo', cal: 149, prot: 6.4, fat: 0.5, sat: 0.09, carb: 33.1, weight: 5 }, { name: 'Pimiento rojo', cal: 31, prot: 1, fat: 0.3, sat: 0.03, carb: 6, weight: 120 }, { name: 'Pimiento verde', cal: 20, prot: 0.9, fat: 0.2, sat: 0.03, carb: 4.6, weight: 100 }, { name: 'Berenjena', cal: 25, prot: 1, fat: 0.2, sat: 0.03, carb: 5.9, weight: 200 }, { name: 'Alcachofa', cal: 47, prot: 3.3, fat: 0.2, sat: 0.04, carb: 10.5, weight: 120 }, { name: 'Coliflor', cal: 25, prot: 1.9, fat: 0.3, sat: 0.05, carb: 5, weight: 100 }, { name: 'Apio', cal: 16, prot: 0.7, fat: 0.2, sat: 0.04, carb: 3, weight: 40 }, { name: 'Remolacha', cal: 43, prot: 1.6, fat: 0.2, sat: 0.03, carb: 9.6, weight: 100 }, { name: 'Esp√°rrago', cal: 20, prot: 2.2, fat: 0.1, sat: 0.03, carb: 3.9, weight: 50 }, { name: 'Col de Bruselas', cal: 43, prot: 3.4, fat: 0.3, sat: 0.06, carb: 8.9, weight: 20 } ],
            'Frutos Secos': [ { name: 'Almendras', cal: 579, prot: 21.2, fat: 49.9, sat: 3.8, carb: 21.6, weight: 30 }, { name: 'Nueces', cal: 654, prot: 15.2, fat: 65.2, sat: 6.1, carb: 13.7, weight: 30 }, { name: 'Avellanas', cal: 628, prot: 15, fat: 60.8, sat: 4.5, carb: 16.7, weight: 30 }, { name: 'Pistachos', cal: 562, prot: 20.6, fat: 45.4, sat: 5.6, carb: 27.2, weight: 30 }, { name: 'Anacardos', cal: 553, prot: 18.2, fat: 43.9, sat: 7.8, carb: 30.2, weight: 30 }, { name: 'Cacahuetes', cal: 567, prot: 25.8, fat: 49.2, sat: 6.8, carb: 16.1, weight: 30 }, { name: 'Nueces de Macadamia', cal: 718, prot: 7.9, fat: 75.8, sat: 12.1, carb: 13.8, weight: 30 }, { name: 'Nueces de Brasil', cal: 659, prot: 14.3, fat: 67.1, sat: 16.1, carb: 11.7, weight: 30 }, { name: 'Pi√±ones', cal: 673, prot: 13.7, fat: 68.4, sat: 4.9, carb: 13.1, weight: 30 } ],
            'Carnes': [ { name: 'Pechuga de pollo', cal: 165, prot: 31, fat: 3.6, sat: 1, carb: 0, weight: 150 }, { name: 'Muslo de pollo', cal: 209, prot: 26, fat: 10.9, sat: 3, carb: 0, weight: 150 }, { name: 'Pollo entero', cal: 190, prot: 28, fat: 8, sat: 2.3, carb: 0, weight: 1000 }, { name: 'Carne de ternera', cal: 250, prot: 26, fat: 17, sat: 7, carb: 0, weight: 150 }, { name: 'Carne de ternera magra', cal: 220, prot: 26, fat: 12, sat: 5, carb: 0, weight: 150 }, { name: 'Carne de cerdo', cal: 242, prot: 21, fat: 17, sat: 7, carb: 0, weight: 150 }, { name: 'Lomo de cerdo', cal: 211, prot: 23, fat: 12, sat: 4.5, carb: 0, weight: 150 }, { name: 'Entrecot lomo iberico marinado', cal: 137, prot: 18, fat: 7, sat: 2.5, carb: 0.5, weight: 70 }, { name: 'Flamenquines', cal: 167, prot: 11.1, fat: 5.3, sat: 1.9, carb: 18.5, weight: 45 }, { name: 'Costillas de cerdo', cal: 291, prot: 25, fat: 21, sat: 8, carb: 0, weight: 150 }, { name: 'Cordero', cal: 294, prot: 25, fat: 21, sat: 9, carb: 0, weight: 150 }, { name: 'Cordero magro', cal: 236, prot: 26, fat: 14, sat: 6, carb: 0, weight: 150 }, { name: 'Pavo chuletas', cal: 85, prot: 16.4, fat: 1.8, sat: 0.6, carb: 0.8, weight: 120 }, { name: 'Pavo molido', cal: 150, prot: 26, fat: 5, sat: 1, carb: 0, weight: 150 }, { name: 'Conejo', cal: 173, prot: 32, fat: 4, sat: 1, carb: 0, weight: 150 }, { name: 'Salchich√≥n', cal: 460, prot: 27, fat: 38, sat: 14, carb: 1, weight: 50 }, { name: 'Jam√≥n serrano', cal: 247.8, prot: 33.5, fat: 12.2, sat: 4.6, carb: 1, weight: 100 }, { name: 'Jam√≥n cocido extra', cal: 98, prot: 19, fat: 2.5, sat: 1, carb: 0.5, weight: 15 }, { name: 'Salchichas', cal: 222, prot: 14, fat: 18, sat: 6, carb: 1, weight: 31 }, { name: 'Pelota', cal: 225, prot: 20, fat: 16, sat: 6, carb: 4, weight: 100 }, { name: 'Longaniza', cal: 245, prot: 15.9, fat: 19.4, sat: 7.8, carb: 1.7, weight: 30 } ],
            'Pescados': [ { name: 'Merluza', cal: 94, prot: 20, fat: 1, sat: 0.2, carb: 0, weight: 300 }, { name: 'Dorada', cal: 96, prot: 18, fat: 2.5, sat: 0.6, carb: 0, weight: 500 }, { name: 'Lubina', cal: 98, prot: 19, fat: 2, sat: 0.4, carb: 0, weight: 300 }, { name: 'Salm√≥n (salvaje)', cal: 180, prot: 20, fat: 10, sat: 2, carb: 0, weight: 200 }, { name: 'Sardinas', cal: 118, prot: 20, fat: 5, sat: 1.2, carb: 0, weight: 100 }, { name: 'Gallineta n√≥rdica', cal: 79, prot: 20, fat: 1, sat: 0.2, carb: 0, weight: 380 }, { name: 'Trucha', cal: 103, prot: 20, fat: 3, sat: 0.6, carb: 0, weight: 250 }, { name: 'Pez espada', cal: 117, prot: 20, fat: 4, sat: 1, carb: 0, weight: 200 }, { name: 'Pulpo', cal: 81, prot: 15, fat: 1, sat: 0.2, carb: 2, weight: 100 }, { name: 'Mejillones', cal: 171, prot: 24, fat: 4, sat: 0.8, carb: 7, weight: 100 } ],
            'Bebidas': [ { name: 'Agua mineral', cal: 0, prot: 0, fat: 0, sat: 0, carb: 0, weight: 250 }, { name: 'Agua con gas', cal: 0, prot: 0, fat: 0, sat: 0, carb: 0, weight: 250 }, { name: 'Batido de chocolate', cal: 110, prot: 3, fat: 3.5, sat: 2, carb: 17, weight: 250 }, { name: 'Limonada casera', cal: 50, prot: 0, fat: 0, sat: 0, carb: 12, weight: 250 }, { name: 'T√© helado', cal: 40, prot: 0, fat: 0, sat: 0, carb: 10, weight: 250 }, { name: 'Bebida de soja', cal: 33, prot: 3, fat: 1.8, sat: 0.2, carb: 1, weight: 250 }, { name: 'Cerveza rubia', cal: 43, prot: 0.5, fat: 0, sat: 0, carb: 3.6, weight: 330 }, { name: 'Cerveza sin alcohol', cal: 20, prot: 0.2, fat: 0, sat: 0, carb: 4.5, weight: 330 }, { name: 'Vino tinto', cal: 85, prot: 0.1, fat: 0, sat: 0, carb: 2.6, weight: 125 }, { name: 'Vino blanco', cal: 82, prot: 0.1, fat: 0, sat: 0, carb: 2.3, weight: 125 } ],
            'Burger King': [ { name: 'Whopper', cal: 657, prot: 28, fat: 37, sat: 10, carb: 49, weight: 300 }, { name: 'Chicken Royale', cal: 500, prot: 22, fat: 24, sat: 3, carb: 48, weight: 200 }, { name: 'Patatas fritas peque√±as', cal: 230, prot: 3, fat: 11, sat: 1, carb: 32, weight: 90 }, { name: 'Aros de cebolla', cal: 270, prot: 2, fat: 18, sat: 2, carb: 25, weight: 100 }, { name: 'McFlurry Oreo', cal: 400, prot: 5, fat: 22, sat: 13, carb: 42, weight: 200 } ],
            'Panes': [ { name: 'Pan blanco', cal: 265, prot: 8.5, fat: 1.2, sat: 0.2, carb: 55, weight: 125 }, { name: 'Pan integral carrefour', cal: 221, prot: 9.1, fat: 1.7, sat: 0.9, carb: 45, weight: 125 }, { name: 'Pan de centeno', cal: 259, prot: 8.5, fat: 3.3, sat: 0.4, carb: 48.3, weight: 30 }, { name: 'Pan de molde', cal: 265, prot: 8, fat: 3.5, sat: 0.8, carb: 49, weight: 25 }, { name: 'Pan tostado', cal: 350, prot: 10, fat: 5, sat: 1, carb: 60, weight: 20 } ],
            'Cereales Grano': [ { name: 'Arroz blanco (cocido)', cal: 365, prot: 7.1, fat: 0.7, sat: 0.2, carb: 80, weight: 180 }, { name: 'Arroz integral (cocido)', cal: 370, prot: 7.9, fat: 2.7, sat: 0.5, carb: 77, weight: 180 }, { name: 'Quinoa (cocida)', cal: 368, prot: 14, fat: 6, sat: 0.7, carb: 64, weight: 185 }, { name: 'Avena (cruda)', cal: 389, prot: 17, fat: 7, sat: 1.2, carb: 66, weight: 40 } ],
            'Pastas': [ { name: 'Espaguetis (cocidos)', cal: 371, prot: 13, fat: 1.5, sat: 0.3, carb: 75, weight: 140 }, { name: 'Macarrones (cocidos)', cal: 371, prot: 13, fat: 1.5, sat: 0.3, carb: 75, weight: 140 }, { name: 'Fideos de arroz (cocidos)', cal: 109, prot: 0.9, fat: 0.2, sat: 0.02, carb: 24.9, weight: 180 } ],
            'Leches': [ { name: 'Leche entera', cal: 61, prot: 3.1, fat: 3.3, sat: 2.1, carb: 4.7, weight: 200 }, { name: 'Leche semidesnatada (Central Lechera Asturiana)', cal: 45, prot: 3.15, fat: 1.55, sat: 1, carb: 4.65, weight: 200 }, { name: 'Leche desnatada Puleva proteina', cal: 43, prot: 5, fat: 0.5, sat: 0.3, carb: 4.8, weight: 200 } ],
            'Quesos': [ { name: 'Queso fresco', cal: 145, prot: 11, fat: 10, sat: 6.5, carb: 2, weight: 100 }, { name: 'Queso semicurado', cal: 421, prot: 25, fat: 35, sat: 25, carb: 1.6, weight: 20 }, { name: 'Queso curado', cal: 452, prot: 30, fat: 37, sat: 24, carb: 1, weight: 30 }, { name: 'Queso cauda viejo', cal: 325, prot: 29.4, fat: 23, sat: 16, carb: 0, weight: 4 }, { name: 'Queso havarti', cal: 418, prot: 18.9, fat: 38, sat: 24.2, carb: 0.1, weight: 32 } ],
            'Yogures': [ { name: 'Yogur natural entero', cal: 61, prot: 3.5, fat: 3, sat: 2, carb: 4.7, weight: 125 }, { name: 'Yogur natural desnatado', cal: 36, prot: 4.3, fat: 0.1, sat: 0.1, carb: 5, weight: 125 }, { name: 'Yogur griego', cal: 115, prot: 9, fat: 5, sat: 3.5, carb: 3.5, weight: 125 } ],
            'Legumbres Secas': [ { name: 'Lentejas (crudas)', cal: 353, prot: 25, fat: 1.1, sat: 0.2, carb: 60, weight: 10 }, { name: 'Garbanzos (crudos)', cal: 364, prot: 19, fat: 6, sat: 0.6, carb: 61, weight: 12 }, { name: 'Jud√≠as blancas (crudas)', cal: 335, prot: 21, fat: 1.6, sat: 0.3, carb: 60, weight: 10 } ],
            'Legumbres Cocidas': [ { name: 'Lentejas cocidas', cal: 116, prot: 9, fat: 0.4, sat: 0.1, carb: 20, weight: 200 }, { name: 'Tortitas de arroz', cal: 389, prot: 8, fat: 2.1, sat: 0.4, carb: 83, weight: 7 }, { name: 'Garbanzos cocidos', cal: 164, prot: 9, fat: 2.6, sat: 0.3, carb: 27, weight: 200 } ],
            'Huevos': [ { name: 'Huevo de gallina (entero)', cal: 143, prot: 12.6, fat: 10, sat: 3.1, carb: 0.7, weight: 60 }, { name: 'Clara de huevo', cal: 52, prot: 11, fat: 0.2, sat: 0, carb: 0.7, weight: 33 }, { name: 'Yema de huevo', cal: 322, prot: 16, fat: 27, sat: 9.6, carb: 3.6, weight: 17 }, { name: 'Huevo cocido', cal: 155, prot: 12.6, fat: 10.6, sat: 3.3, carb: 1.1, weight: 50 }, { name: 'Huevo frito', cal: 196, prot: 13, fat: 15, sat: 4.2, carb: 1.1, weight: 60 } ],
            'Bolleria': [ { name: 'Croissant', cal: 406, prot: 8.2, fat: 21, sat: 12, carb: 46, weight: 60 }, { name: 'Donut', cal: 452, prot: 5.3, fat: 25, sat: 12, carb: 51, weight: 70 } ],
            'Dulces': [ { name: 'Chocolate negro', cal: 546, prot: 4.9, fat: 31, sat: 19, carb: 61, weight: 30 }, { name: 'Galletas tipo Mar√≠a', cal: 409, prot: 6.8, fat: 8.1, sat: 2.5, carb: 82.3, weight: 6 } ],
            'Hamburguesas': [ { name: 'Big Mac', cal: 550, prot: 25, fat: 30, sat: 10, carb: 45, weight: 200 }, { name: 'McChicken', cal: 420, prot: 23, fat: 20, sat: 3, carb: 35, weight: 180 } ],
            'Acompa√±amientos': [ { name: 'Patatas fritas medianas', cal: 340, prot: 3, fat: 17, sat: 1, carb: 44, weight: 115 } ],
            'Salsas': [ { name: 'Ketchup', cal: 60, prot: 1.3, fat: 0.5, sat: 0.1, carb: 13, weight: 100 }, { name: 'Salsa de Yogur', cal: 120, prot: 3, fat: 10, sat: 2, carb: 5, weight: 100 }, { name: 'Salsa de Curry', cal: 150, prot: 2, fat: 12, sat: 3, carb: 10, weight: 100 }, { name: 'Salsa de Mostaza', cal: 133, prot: 7, fat: 9, sat: 0.5, carb: 5, weight: 100 }, { name: 'Salsa de Queso', cal: 250, prot: 10, fat: 22, sat: 14, carb: 5, weight: 100 }, { name: 'Salsa de Ajo', cal: 180, prot: 2, fat: 16, sat: 2.5, carb: 6, weight: 100 }, { name: 'Salsa de Chile', cal: 40, prot: 1, fat: 0.5, sat: 0.1, carb: 10, weight: 100 }, { name: 'Salsa de Miel y Mostaza', cal: 200, prot: 2, fat: 12, sat: 1.5, carb: 20, weight: 100 }, { name: 'Salsa de Soja Dulce', cal: 100, prot: 5, fat: 0.5, sat: 0.1, carb: 20, weight: 100 } ]
        };

        const INITIAL_STATE = {
            wakeTime: '', sleepHours: 0, sleepQuality: 0,
            water: 0,
            studySessions: [],
            mobileHours: 0, 
            steps: 0, 
            standingHours: 0, 
            runKm: 0, runPace: 5.5, runInt: 2,
            bikeKm: 0, bikeInt: 2, 
            gymCals: 0, gymTime: 0, gymInt: 2,
            foodLog: [],
            gymSessions: [] // Array de objetos {muscle, time, int}
        };

        let todayData = JSON.parse(JSON.stringify(INITIAL_STATE));
        let BASE_GOALS = { cals: 0, prot: 160, fat: 70, sat: 20, carbs: 300, water: 2500 }; 
        let currentGoals = { ...BASE_GOALS };
        let history = JSON.parse(localStorage.getItem('fitTrackerHistory_MD')) || [];
        
        let mentalLoad = 0;
        let physicalLoad = 0;
        let fatigue7d = 0;
        let stressDetails = []; 
        let waterDetails = [];
        let nutritionAdvice = "";
        let studyAdvice = "";
        let mentalExplanation = "";
        let physicalExplanation = "";

        let todayAlerts = [];

        // Variables para predicci√≥n diaria
        let predictedMental = 50;
        let predictedPhysical = 50;

        // ==========================================================================================
        // üöÄ INICIALIZACI√ìN
        // ==========================================================================================
        window.onload = function() {
            loadDay();
            renderFoodCategories();
            calculateStressBar();
            updateDay();
            updateHistoryUI();
            startRealTimeClock();
            startSmartMonitor();
            calculateDailyPrediction();
            updateBodyMap(); // Inicializar SVG
        };

        function startRealTimeClock() {
            setInterval(() => {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const day = now.getDate();
                const month = MONTH_NAMES[now.getMonth()];
                
                const climate = ENGINE.getClimateStress();
                
                document.getElementById('season-indicator').innerHTML = `${hours}:${minutes} ¬∑ ${day} ${month} ${climate.icon} ${climate.temp}¬∞C`;
            }, 1000);
        }

        function calculateDailyPrediction() {
            if (history.length > 0) {
                const lastDay = history[0];
                const climate = ENGINE.getClimateStress();
                
                predictedMental = ENGINE.predictMentalPerformance(lastDay);
                predictedPhysical = ENGINE.predictPhysicalPerformance(lastDay);
                
                if (climate.temp > 28) {
                    predictedPhysical -= 10;
                }
                if (climate.temp < 10) {
                    predictedMental -= 5;
                }

                // Inyectar consejo natural
                const advice = ENGINE.generateDailyAdvice(history);
                // Lo mostramos sutilmente en el header o consola por ahora, o en un alert al inicio
                console.log("Consejo Bio-Motor:", advice);
            }
        }

        // ==========================================================================================
        // üîî SISTEMA DE ALERTAS INTELIGENTE
        // ==========================================================================================
        function startSmartMonitor() {
            setInterval(() => {
                checkAlerts();
            }, 300000);
            
            setTimeout(checkAlerts, 2000);
        }

        function checkAlerts() {
            const h = new Date().getHours();
            const waterPct = (todayData.water / currentGoals.water) * 100;
            const foodPct = (todayData.foodLog.reduce((a,b)=>a+b.cal, 0) / currentGoals.cals) * 100;
            
            const totalCarbs = todayData.foodLog.reduce((a,b)=>a+b.carb, 0);
            const totalProt = todayData.foodLog.reduce((a,b)=>a+b.prot, 0);
            const totalStudy = todayData.studySessions.reduce((a,b)=>a+b.hours, 0);

            todayAlerts = [];

            // ALERTAS DE AGUA
            if (h >= 12 && waterPct < 30) {
                todayAlerts.push({ type: 'water', severity: 'low', message: '¬°Alerta! Muy poca agua. Bebe ahora.' });
            } else if (h < 14 && waterPct > 100) {
                todayAlerts.push({ type: 'water', severity: 'high', message: 'Vas muy r√°pido. Has bebido toda el agua antes de comer.' });
            } else if (todayData.runKm > 5 && waterPct < 50) {
                todayAlerts.push({ type: 'water', severity: 'low', message: `Has corrido ${todayData.runKm}km y no has bebido suficiente agua. Necesitas reponer.` });
            }

            // ALERTAS DE COMBUSTIBLE
            if (totalCarbs < currentGoals.carbs * 0.5 && todayData.runKm > 5) {
                todayAlerts.push({ type: 'nutrition', severity: 'carbs', message: 'Te faltan carbohidratos para recuperar del entrenamiento.' });
            } else if (totalCarbs < currentGoals.carbs * 0.3) {
                todayAlerts.push({ type: 'nutrition', severity: 'carbs', message: 'Muy pocos carbohidratos. Afectar√° tu energ√≠a.' });
            }
            
            if (totalProt < currentGoals.prot * 0.5) {
                todayAlerts.push({ type: 'nutrition', severity: 'prot', message: 'Prote√≠na baja. Tus m√∫sculos necesitan recuperarse.' });
            }

            // ALERTA DE GIMNASIO
            if (todayData.gymTime > USER_BIO.maxGymTime * 1.5) {
                todayAlerts.push({ type: 'physical', severity: 'high', message: 'Volumen de entreno excesivo. Riesgo de sobreentrenamiento.' });
            }

            // ALERTAS COGNITIVAS
            if (totalStudy > 6) {
                todayAlerts.push({ type: 'cognitive', severity: 'high', message: `Has estudiado ${totalStudy}h. Necesitas carbohidratos y omega-3 para recuperar.` });
                studyAdvice = `üß† Alta carga cognitiva (${totalStudy}h). Toma frutos secos, pescado o aguacate.`;
            } else if (totalStudy > 3) {
                studyAdvice = `üìö Has estudiado ${totalStudy}h. Mant√©n una buena hidrataci√≥n.`;
            } else {
                studyAdvice = "‚úÖ Carga cognitiva nominal.";
            }

            // ALERTA DE COMIDA GENERAL
            if (h >= 15 && foodPct < 30) {
                todayAlerts.push({ type: 'food', severity: 'low', message: 'Has comido muy poco. El cuerpo entrar√° en reserva.' });
            }

            updateAlertCards();
        }

        function updateAlertCards() {
            const waterCard = document.getElementById('water-home-card');
            const foodCard = document.getElementById('food-home-card');

            waterCard.classList.remove('alert-water-low', 'alert-water-high', 'border-b-4', 'border-blue-400');
            foodCard.classList.remove('alert-food-low', 'alert-nutrition', 'border-b-4', 'border-orange-500');

            let waterAlert = todayAlerts.find(a => a.type === 'water');
            if (waterAlert) {
                if (waterAlert.severity === 'low') {
                    waterCard.classList.add('alert-water-low');
                } else if (waterAlert.severity === 'high') {
                    waterCard.classList.add('alert-water-high');
                }
            } else {
                waterCard.classList.add('border-b-4', 'border-blue-400');
            }

            let nutritionAlert = todayAlerts.find(a => a.type === 'nutrition');
            let foodAlert = todayAlerts.find(a => a.type === 'food');
            let cognitiveAlert = todayAlerts.find(a => a.type === 'cognitive');
            
            if (nutritionAlert || foodAlert || cognitiveAlert) {
                foodCard.classList.add('alert-nutrition');
            } else {
                foodCard.classList.add('border-b-4', 'border-orange-500');
            }
        }

        function getWaterAdvice() {
            const h = new Date().getHours();
            const waterPct = (todayData.water / currentGoals.water) * 100;
            const remaining = currentGoals.water - todayData.water;
            
            let expectedPct = 0;
            if (h < 10) expectedPct = 20;
            else if (h < 14) expectedPct = 40;
            else if (h < 18) expectedPct = 60;
            else if (h < 22) expectedPct = 80;
            else expectedPct = 100;
            
            if (h >= 20) {
                if (waterPct < 50) {
                    return `üåô Son las ${h}:00, has bebido solo ${todayData.water}ml de ${Math.round(currentGoals.water)}ml. Te quedan ${Math.round(remaining)}ml por beber antes de dormir. ¬°Bebe ahora!`;
                } else if (waterPct >= 90) {
                    return `üåô Son las ${h}:00, has bebido ${todayData.water}ml. ¬°Bien! Ya casi llegas a la meta.`;
                } else {
                    return `üåô Son las ${h}:00, llevas ${todayData.water}ml. Te quedan ${Math.round(remaining)}ml para hoy.`;
                }
            } else if (h >= 12) {
                if (waterPct < 40) {
                    return `‚òÄÔ∏è Son las ${h}:00 y solo has bebido ${todayData.water}ml. Deber√≠as llevar al menos ${Math.round(currentGoals.water * 0.5)}ml a estas horas. ¬°Hidr√°tate!`;
                } else if (todayData.runKm > 0 && waterPct < 60) {
                    return `üèÉ Has hecho deporte y solo llevas ${todayData.water}ml. Necesitas m√°s agua para recuperar.`;
                } else if (waterPct > 80) {
                    return `‚òÄÔ∏è Son las ${h}:00 y ya has bebido ${todayData.water}ml. Vas muy bien, pero no te pases.`;
                } else {
                    return `‚òÄÔ∏è Son las ${h}:00, llevas ${todayData.water}ml. Objetivo: ${Math.round(currentGoals.water)}ml. Sigue as√≠.`;
                }
            } else {
                if (waterPct === 0) {
                    return `üåÖ Son las ${h}:00 y a√∫n no has bebido agua. Empieza el d√≠a hidrat√°ndote.`;
                } else {
                    return `üåÖ Son las ${h}:00, buen comienzo con ${todayData.water}ml. Sigue bebiendo a lo largo del d√≠a.`;
                }
            }
        }

        function editUserProfile() {
            Swal.fire({
                title: 'Editar Perfil Biol√≥gico',
                html: `
                    <div class="grid grid-cols-2 gap-3 text-left">
                        <div>
                            <label class="text-xs font-bold text-gray-500">G√©nero</label>
                            <select id="swal-user-gen" class="w-full border p-2 rounded mb-2">
                                <option value="hombre" ${USER_BIO.genero === 'hombre' ? 'selected' : ''}>Hombre</option>
                                <option value="mujer" ${USER_BIO.genero === 'mujer' ? 'selected' : ''}>Mujer</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">Edad</label>
                            <input id="swal-user-age" type="number" class="w-full border p-2 rounded mb-2" value="${USER_BIO.edad}">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">Peso (kg)</label>
                            <input id="swal-user-w" type="number" class="w-full border p-2 rounded mb-2" value="${USER_BIO.peso}">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">Altura (cm)</label>
                            <input id="swal-user-h" type="number" class="w-full border p-2 rounded mb-2" value="${USER_BIO.altura}">
                        </div>
                         <div>
                            <label class="text-xs font-bold text-gray-500">% Grasa</label>
                            <input id="swal-user-f" type="number" class="w-full border p-2 rounded mb-2" value="${USER_BIO.grasa}">
                        </div>
                         <div>
                            <label class="text-xs font-bold text-gray-500">M√∫sculo (kg)</label>
                            <input id="swal-user-m" type="number" class="w-full border p-2 rounded mb-2" value="${USER_BIO.masaMuscular}">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">Max Run (km)</label>
                            <input id="swal-user-maxrun" type="number" class="w-full border p-2 rounded mb-2" value="${USER_BIO.maxRunKm}">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">Max Gym (min)</label>
                            <input id="swal-user-maxgym" type="number" class="w-full border p-2 rounded mb-2" value="${USER_BIO.maxGymTime}">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">Max Bici (km)</label>
                            <input id="swal-user-maxbike" type="number" class="w-full border p-2 rounded mb-2" value="${USER_BIO.maxBikeKm}">
                        </div>
                    </div>
                `,
                confirmButtonText: 'Guardar y Recalcular',
                preConfirm: () => {
                    return {
                        genero: document.getElementById('swal-user-gen').value,
                        edad: Number(document.getElementById('swal-user-age').value),
                        peso: Number(document.getElementById('swal-user-w').value),
                        altura: Number(document.getElementById('swal-user-h').value),
                        grasa: Number(document.getElementById('swal-user-f').value),
                        masaMuscular: Number(document.getElementById('swal-user-m').value),
                        maxRunKm: Number(document.getElementById('swal-user-maxrun').value),
                        maxGymTime: Number(document.getElementById('swal-user-maxgym').value),
                        maxBikeKm: Number(document.getElementById('swal-user-maxbike').value)
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    USER_BIO = { ...USER_BIO, ...result.value };
                    localStorage.setItem('user_bio_config', JSON.stringify(USER_BIO));
                    updateDay();
                    Swal.fire('Perfil Actualizado', 'Las metas de agua y calor√≠as se han ajustado a tu nueva biolog√≠a.', 'success');
                }
            });
        }

        function triggerMorningPrediction() {
            updateDay(); 
            const sleep = parseFloat(document.getElementById('sleepHours').value);
            const wake = document.getElementById('wakeTime').value;
            
            if (sleep > 0 && wake && history.length > 0) {
                const lastDay = history[0];
                const climate = ENGINE.getClimateStress();
                
                const predictedEnergy = ENGINE.predictTomorrow(lastDay, climate, sleep);
                const mentalPrediction = ENGINE.predictMentalPerformance(lastDay);
                const physicalPrediction = ENGINE.predictPhysicalPerformance(lastDay);
                
                let msg = `<div class="text-3xl font-black text-center mb-2 ${predictedEnergy > 70 ? 'text-green-500' : 'text-orange-500'}">${predictedEnergy}%</div>`;
                msg += `<p class="text-sm text-center text-gray-600 mb-4">Bater√≠a estimada para hoy</p>`;
                
                msg += `<div class="grid grid-cols-2 gap-3 mb-4">`;
                msg += `<div class="bg-indigo-50 p-3 rounded-xl text-center"><span class="text-xs text-indigo-600">üß† Mental</span><div class="text-xl font-bold text-indigo-700">${mentalPrediction}%</div></div>`;
                msg += `<div class="bg-orange-50 p-3 rounded-xl text-center"><span class="text-xs text-orange-600">üí™ F√≠sica</span><div class="text-xl font-bold text-orange-700">${physicalPrediction}%</div></div>`;
                msg += `</div>`;
                
                const scores = lastDay.stressScores || { physical: 0, mental: 0 };
                
                if (scores.physical > 80) msg += `<div class="bg-red-50 p-2 rounded text-xs text-red-600 mb-2">üõë <b>Ayer te pasaste:</b> Tus m√∫sculos est√°n rotos. Hoy es d√≠a de descanso activo obligatorio.</div>`;
                else if (scores.physical > 50) msg += `<div class="bg-orange-50 p-2 rounded text-xs text-orange-600 mb-2">‚ö†Ô∏è <b>Carga Media:</b> Ayer entrenaste duro. T√≥malo con calma.</div>`;
                else msg += `<div class="bg-green-50 p-2 rounded text-xs text-green-600 mb-2">‚úÖ <b>F√≠sico Ok:</b> Ayer fue suave. Hoy puedes apretar.</div>`;

                if (scores.mental > 80) msg += `<div class="bg-red-50 p-2 rounded text-xs text-red-600 mb-2">üß† <b>Carga mental alta ayer:</b> Tu cerebro necesita descanso.</div>`;
                else if (scores.mental > 50) msg += `<div class="bg-orange-50 p-2 rounded text-xs text-orange-600 mb-2">üìö <b>Estudiaste mucho ayer:</b> Recuperaci√≥n cognitiva necesaria.</div>`;

                if (climate.temp > 28) msg += `<div class="bg-orange-50 p-2 rounded text-xs text-orange-600 mb-2">üî• <b>Calor (${climate.temp}¬∞C):</b> Rendimiento -10%</div>`;
                else if (climate.temp < 15) msg += `<div class="bg-blue-50 p-2 rounded text-xs text-blue-600 mb-2">‚ùÑÔ∏è <b>Fr√≠o (${climate.temp}¬∞C):</b> Quemas m√°s calor√≠as.</div>`;
                
                if (predictedEnergy < 40) msg += `<div class="bg-slate-100 p-2 rounded text-xs text-slate-700">üõå <b>Sistema Cr√≠tico:</b> Solo dormir y comer hoy.</div>`;

                Swal.fire({ title: 'Buenos d√≠as ‚òÄÔ∏è', html: msg, confirmButtonText: 'Entendido' });
            }
        }

        function updateDay() {
            const wakeEl = document.getElementById('wakeTime');
            if(wakeEl) todayData.wakeTime = wakeEl.value;
            const sleepHEl = document.getElementById('sleepHours');
            if(sleepHEl) todayData.sleepHours = Number(sleepHEl.value) || 0;
            const sleepQEl = document.getElementById('sleepQuality');
            if(sleepQEl) todayData.sleepQuality = Number(sleepQEl.value) || 0;

            calculateDynamicGoals();
            calculateStressBar(); 
            saveDay();
            updateBodyMap();
            updateUI();
            checkAlerts();
        }

        function updateMobile() {
            todayData.mobileHours = parseFloat(document.getElementById('range-mobile').value) || 0;
            document.getElementById('val-mobile').innerText = todayData.mobileHours;
            document.getElementById('home-mobile').innerText = `${todayData.mobileHours}h M√≥vil`;
            updateDay();
        }

        function calculateDynamicGoals() {
            const BMR = ENGINE.getBMR();
            const climate = ENGINE.getClimateStress();
            const profile = ENGINE.getBioProfile(USER_BIO.edad, USER_BIO.genero) || { water: 35, min: 18, max: 99 };
            
            let g = { 
                cals: BMR + climate.termogenesisKcal, 
                prot: (USER_BIO.masaMuscular > 0 ? 2.2 : 1.8) * USER_BIO.peso,
                fat: 0.9 * USER_BIO.peso, 
                sat: 25, 
                carbs: 0, 
                // BUG FIX: Usar ml/kg espec√≠fico de la tabla m√©dica
                water: (USER_BIO.peso * (profile.water || 35)) 
            };

            // Ajuste por temperatura > 25¬∞C (Dr. AI Rule)
            if (climate.temp > 25) {
                g.water = g.water * 1.15;
            }

            if(USER_BIO.genero === 'mujer') {
                g.fat = 1.0 * USER_BIO.peso;
                g.prot = 1.8 * USER_BIO.peso;
            }

            waterDetails = [];
            waterDetails.push({ txt: `Base (${USER_BIO.peso}kg)`, val: `${Math.round(USER_BIO.peso * 35)}ml` });
            waterDetails.push({ txt: `Bio-Rango (${profile.min}-${profile.max})`, val: `${profile.water} ml/kg` });
            if(climate.waterFactor > 1) waterDetails.push({ txt: `Calor (${climate.temp}¬∞C)`, val: `+${Math.round((climate.waterFactor-1)*100)}%` });

            if (todayData.steps > 0) {
                const neatCals = todayData.steps * 0.045; 
                g.cals += neatCals;
                g.water += (todayData.steps * 0.05); 
            }

            let activityCals = 0;
            if(todayData.runKm > 0) {
                const cost = todayData.runKm * USER_BIO.peso * 1.03;
                activityCals += cost;
                g.water += (todayData.runKm * 80 * climate.waterFactor);
                waterDetails.push({ txt: `Run (${todayData.runKm}km)`, val: `+${Math.round(todayData.runKm * 80 * climate.waterFactor)}ml` });
            }
            if(todayData.gymCals > 0) {
                activityCals += parseFloat(todayData.gymCals) || 0;
                g.water += (todayData.gymTime * 10);
                waterDetails.push({ txt: `Gym (${todayData.gymTime}min)`, val: `${todayData.gymTime * 10}ml` });
            }

            // Ajuste Neuro (Carga Cognitiva)
            let studyWaterNeed = 0;
            if (todayData.studySessions) {
                todayData.studySessions.forEach(s => {
                    // Foco 1: 50ml/h, Foco 2: 100ml/h, Foco 3: 150ml/h
                    studyWaterNeed += s.hours * (s.focus * 50);
                });
            }

            if (studyWaterNeed > 0) {
                g.water += studyWaterNeed;
                const totalHours = todayData.studySessions.reduce((a,b)=>a+b.hours, 0);
                waterDetails.push({ txt: `Estudio (${totalHours}h)`, val: `+${Math.round(studyWaterNeed)}ml` });
            }

            g.cals += activityCals;

            const remainingCals = g.cals - ((g.prot * 4) + (g.fat * 9));
            g.carbs = Math.max(remainingCals / 4, 150); 

            // NUTRICI√ìN ADVICE
            nutritionAdvice = "";
            const totalCarbs = todayData.foodLog.reduce((a,b)=>a+b.carb, 0);
            const totalProt = todayData.foodLog.reduce((a,b)=>a+b.prot, 0);
            const totalStudy = todayData.studySessions.reduce((a,b)=>a+b.hours, 0);
            
            if (todayData.runKm > 10 && totalCarbs < g.carbs * 0.6) {
                nutritionAdvice += "<li class='text-orange-600'>üèÉ <b>Recuperaci√≥n:</b> A√∫n te faltan carbohidratos para reponer gluc√≥geno.</li>";
            } else if (todayData.runKm > 5 && totalCarbs < g.carbs * 0.4) {
                nutritionAdvice += "<li class='text-orange-600'>‚ö†Ô∏è <b>Bajos de carbos:</b> Despu√©s de correr necesitas reponer energ√≠a.</li>";
            }
            
            if (todayData.gymTime > 30 && totalProt < g.prot * 0.5) {
                nutritionAdvice += "<li class='text-orange-600'>üí™ <b>Prote√≠na baja:</b> Tus m√∫sculos necesitan prote√≠na para repararse.</li>";
            }
            
            if (totalStudy > 6) {
                nutritionAdvice += "<li class='text-purple-600'>üß† <b>Alta carga mental:</b> Toma frutos secos, pescado o aguacate para el cerebro.</li>";
            } else if (totalStudy > 3) {
                nutritionAdvice += "<li class='text-purple-600'>üìö <b>Estudio moderado:</b> Mant√©n hidrataci√≥n y snacks saludables.</li>";
            }
            
            if (totalProt >= g.prot * 0.8 && totalCarbs >= g.carbs * 0.8) {
                nutritionAdvice = "<li class='text-green-600'>‚úÖ <b>Combustible √≥ptimo:</b> Tus macros est√°n equilibrados.</li>";
            }
            
            if (nutritionAdvice === "") {
                nutritionAdvice = "<li class='text-gray-600'>Mant√©n una alimentaci√≥n equilibrada.</li>";
            }

            currentGoals = g;
        }

        function calculatePhysicalStressScore() {
            let score = 0;
            // Esfuerzo Relativo (Porcentaje de Capacidad)
            const runLoad = (todayData.runKm / USER_BIO.maxRunKm) * 100; // Si corro mi maximo = 100 puntos base
            score += runLoad * (todayData.runInt === 3 ? 1.2 : 1.0); // Multiplicador de intensidad
            
            const gymLoad = (todayData.gymTime / (USER_BIO.maxGymTime || 60)) * 100;
            score += gymLoad * (todayData.gymInt === 3 ? 1.2 : 1.0);
            // Pasos: 1 punto por cada 1000 pasos
            score += (todayData.steps / 1000) * 1.5;
            // Ciclismo: Relativo al maximo
            const bikeLoad = (todayData.bikeKm / (USER_BIO.maxBikeKm || 25)) * 100;
            score += bikeLoad * (todayData.bikeInt === 3 ? 1.2 : 1.0);
            
            return score;
        }

        function calculateStressBar() {
            stressDetails = [];
            
            // C√ÅLCULO DE CARGA MENTAL
            let mLoad = 0;
            const profile = ENGINE.getBioProfile(USER_BIO.edad, USER_BIO.genero);
            
            // Sue√±o Parab√≥lico
            const sleepScore = ENGINE.calculateSleepScore(todayData.sleepHours, todayData.sleepQuality);
            if(sleepScore < 100) {
                mLoad += (100 - sleepScore);
                stressDetails.push({cat:'mental', text: `Sue√±o Ineficiente`, type:'bad'});
                mentalExplanation = `Sue√±o Real: ${(todayData.sleepHours * (todayData.sleepQuality/100 || 0.85)).toFixed(1)}h (Meta: ${profile.sleep[0]}h).`;
            } else {
                mentalExplanation = `Has dormido ${todayData.sleepHours}h. ¬°Perfecto!`;
            }

            // Estudio: 5 puntos por hora * foco
            const studyLoad = todayData.studySessions.reduce((a,b) => a + (b.hours * (b.focus * 4)), 0);
            mLoad += studyLoad;
            if(studyLoad > 0) {
                mentalExplanation += ` Has estudiado ${todayData.studySessions.reduce((a,b)=>a+b.hours,0)}h (${Math.round(studyLoad)} puntos).`;
            }
            
            // M√≥vil: Penalizaci√≥n din√°mica seg√∫n edad (Dr. AI)
            let mobilePenaltyFactor = 4;
            if (profile.mobileTol === 'dopamine' || profile.mobileTol === 'social') mobilePenaltyFactor = 6; // J√≥venes
            if (profile.mobileTol === 'vision' || profile.mobileTol === 'blue') mobilePenaltyFactor = 5; // Mayores
            
            const mobileLoad = todayData.mobileHours * mobilePenaltyFactor;
            mLoad += mobileLoad;

            if(todayData.mobileHours > 3) {
                let msg = `Uso excesivo m√≥vil (${todayData.mobileHours}h)`;
                if (profile.mobileTol === 'dopamine') msg += " - Dopamina agotada";
                if (profile.mobileTol === 'insomnia') msg += " - Riesgo insomnio";
                stressDetails.push({cat:'mental', text: msg, type:'bad'});
                mentalExplanation += ` M√≥vil: ${todayData.mobileHours}h (Factor: x${mobilePenaltyFactor}).`;
            }
            
            // Grasa saturada baja afecta al cerebro
            const satFat = todayData.foodLog.reduce((a,b)=>a+(b.sat||0), 0);
            if (satFat < 8 && todayData.mobileHours > 2) {
                mLoad += 15;
                stressDetails.push({cat:'mental', text: "Cerebro Inflamado (Poca Grasa)", type:'bad'});
                mentalExplanation += " Poca grasa saturada afecta a la funci√≥n cognitiva.";
            }
            
            mentalLoad = Math.min(Math.round(mLoad), 100);

            // C√ÅLCULO DE CARGA F√çSICA
            let pLoad = calculatePhysicalStressScore();
            
            // Ajuste por edad y m√∫sculo (Menos m√∫sculo = m√°s da√±o relativo)
            if (USER_BIO.masaMuscular < 40) pLoad *= 1.1;
            
            if(pLoad > 100) {
                stressDetails.push({cat:'physical', text: `Sobrecarga (${Math.round(pLoad)}%)`, type:'bad'});
                physicalExplanation = `Has superado tu capacidad m√°xima te√≥rica. Riesgo de lesi√≥n.`;
            } else if(todayData.runKm > 0) {
                stressDetails.push({cat:'physical', text: `Running (${Math.round((todayData.runKm/USER_BIO.maxRunKm)*100)}% Max)`, type:'neutral'});
                physicalExplanation = `Has corrido ${todayData.runKm}km. Carga moderada-alta.`;
            } else {
                physicalExplanation = `Actividad f√≠sica: ${Math.round(pLoad)} puntos.`;
            }

            if(currentGoals.water > 0 && todayData.water < currentGoals.water * 0.5) {
                pLoad += 20;
                stressDetails.push({cat:'physical', text: "Deshidrataci√≥n severa", type:'bad'});
                physicalExplanation += " Est√°s deshidratado, afecta al rendimiento.";
            }
            
            if(todayData.gymTime > 90) {
                physicalExplanation += ` Gimnasio: ${todayData.gymTime}min (alta intensidad).`;
            }
            
            physicalLoad = Math.min(Math.round(pLoad), 100);
            fatigue7d = getFatigue7Days();

            updateBar('mental', mentalLoad);
            updateBar('physical', physicalLoad);
            updateBar('fatigue', fatigue7d);
        }

        function updateBodyMap() {
            // 1. Mostrar texto de an√°lisis
            const comp = ENGINE.analyzeBodyComposition();
            const analysisDiv = document.getElementById('body-analysis-text');
            if(analysisDiv) {
                analysisDiv.innerHTML = `${comp.status} <span class="text-gray-300">|</span> <span class="text-[10px] font-normal text-gray-500">${comp.advice}</span>`;
                analysisDiv.innerHTML = `<span class="${comp.colorClass} font-black uppercase tracking-tight">${comp.status}</span><br><span class="text-[10px] font-medium text-slate-500 leading-tight block mt-1">${comp.advice}</span>`;
            }

            // 2. Resetear todos los m√∫sculos a gris
            const allMuscles = [
                'front-traps', 'front-delts', 'front-pecs', 'front-biceps', 'front-forearms', 'front-abs', 'front-obliques', 'front-quads', 'front-calves',
                'back-traps', 'back-delts', 'back-triceps', 'back-forearms', 'back-lats', 'back-lower', 'back-glutes', 'back-hams', 'back-calves'
            ];
            
            allMuscles.forEach(id => {
                // FIX: Usar querySelectorAll para manejar IDs duplicados en el SVG (izquierda/derecha)
                const elements = document.querySelectorAll(`[id="${id}"]`);
                elements.forEach(el => el.setAttribute('class', 'muscle-base'));
            });

            // Funci√≥n auxiliar para pintar
            // Nivel 3 = Rojo (Primario), Nivel 2 = Amarillo (Secundario), Nivel 1 = Verde
            const paint = (id, level) => {
                // FIX: Usar querySelectorAll para pintar ambos lados
                const elements = document.querySelectorAll(`[id="${id}"]`);
                if(elements.length === 0) return;
                
                let cls = 'muscle-base';
                if (level >= 3) cls = 'muscle-active-max';      // Rojo
                else if (level === 2) cls = 'muscle-active-mid'; // Amarillo
                else if (level === 1) cls = 'muscle-active-low'; // Verde
                
                elements.forEach(el => {
                    const current = el.getAttribute('class');
                    // No sobrescribir si ya tiene un color m√°s intenso
                    if (current.includes('max')) return; 
                    if (current.includes('mid') && level < 3) return;

                    el.setAttribute('class', `muscle-base ${cls}`);
                });
            };

            // --- L√ìGICA DE MAPEO (Igualando la imagen de referencia) ---

            // 1. Running / Bici (Impacto en piernas)
            if (todayData.runKm > 0 || todayData.bikeKm > 0) {
                const int = Math.max(todayData.runInt, todayData.bikeInt);
                // Cu√°driceps y Gemelos como primarios
                paint('front-quads', int >= 2 ? 3 : 2);
                paint('back-calves', int >= 2 ? 3 : 2);
                paint('front-calves', int >= 2 ? 3 : 2);
                // Femorales y Gl√∫teos como secundarios (estabilidad)
                paint('back-hams', 2);
                paint('back-glutes', 2);
            }

            // 2. Gym Sessions
            if (todayData.gymSessions) {
                todayData.gymSessions.forEach(s => {
                    const int = s.int; // 1 (Suave), 2 (Media), 3 (Fallo)
                    const primaryColor = int === 3 ? 3 : (int === 2 ? 3 : 2); // Si es media/alta, ponlo rojo
                    const secondaryColor = 2; // Amarillo

                    if (s.muscle === 'pecho') { 
                        paint('front-pecs', primaryColor); 
                        paint('front-delts', secondaryColor); // Hombro frontal asiste
                        paint('back-triceps', secondaryColor); // Tr√≠ceps asiste empuje
                    }
                    if (s.muscle === 'espalda') { 
                        paint('back-lats', primaryColor); 
                        paint('back-traps', primaryColor);
                        paint('back-lower', secondaryColor);
                        paint('front-biceps', secondaryColor); // B√≠ceps asiste tracci√≥n
                        paint('back-delts', secondaryColor);
                    }
                    if (s.muscle === 'pierna') { 
                        paint('front-quads', primaryColor); 
                        paint('back-hams', primaryColor); 
                        paint('back-glutes', primaryColor); 
                        paint('back-calves', primaryColor);
                    }
                    if (s.muscle === 'brazos') { 
                        paint('front-biceps', primaryColor); 
                        paint('back-triceps', primaryColor); 
                        paint('front-forearms', secondaryColor);
                    }
                    if (s.muscle === 'hombro') { 
                        paint('front-delts', primaryColor); 
                        paint('back-delts', primaryColor);
                        paint('front-traps', secondaryColor);
                        paint('back-traps', secondaryColor);
                    }
                    if (s.muscle === 'abs') { 
                        paint('front-abs', primaryColor); 
                        paint('front-obliques', primaryColor); 
                    }
                });
            }
        }

        function finishDay() {
            Swal.fire({
                title: 'Informe Realidad',
                html: `
                    <label class="block text-xs font-bold uppercase mb-1">Energ√≠a Real (1-10)</label>
                    <div class="flex items-center gap-3">
                        <input type="range" id="swal-energy" min="1" max="10" value="5" class="w-full" oninput="document.getElementById('energy-val-disp').innerText = this.value">
                        <span id="energy-val-disp" class="font-bold text-2xl text-blue-600">5</span>
                    </div>
                    <label class="block text-xs font-bold uppercase mb-1 mt-4">Estado An√≠mico</label>
                    <select id="swal-mood" class="w-full p-2 border rounded mb-2">
                        <option value="NEUTRAL">Normal</option>
                        <option value="MOTIVATED">Motivado / Bestia</option>
                        <option value="TIRED">Cansado / Roto</option>
                        <option value="STRESSED">Estresado / Ansioso</option>
                        <option value="SAD">Triste / Baj√≥n</option>
                    </select>
                `,
                confirmButtonText: 'Aprender y Guardar',
                preConfirm: () => ({ energy: parseInt(document.getElementById('swal-energy').value), mood: document.getElementById('swal-mood').value })
            }).then((result) => {
                if (result.isConfirmed) {
                    const actualScore = result.value.energy * 10;
                    const predicted = parseFloat(localStorage.getItem('today_prediction_score')) || 50;
                    
                    if (Math.abs(actualScore - predicted) > 25) {
                        Swal.fire({
                            title: '¬øPor qu√© fall√©?',
                            text: `Predije ${predicted} pero sientes ${actualScore}.`,
                            input: 'select',
                            inputOptions: { 'UNKNOWN': 'No lo s√© (Ajustar Motor)', 'TIRED_TRAINING': 'Entreno muy duro', 'EXTERNAL': 'Problema Externo (Vida)' },
                            confirmButtonText: 'Corregir IA'
                        }).then((cause) => {
                            if(cause.value) ENGINE.learn(predicted, actualScore, cause.value);
                            saveAndClose(actualScore, result.value.mood);
                        });
                    } else {
                        saveAndClose(actualScore, result.value.mood);
                    }
                }
            });
        }

        function saveAndClose(actualEnergy, mood) {
            const record = { 
                date: new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }), 
                data: { ...todayData }, 
                goals: { ...currentGoals },
                stress: Math.round((mentalLoad + physicalLoad) / 2),
                stressScores: { mental: mentalLoad, physical: physicalLoad },
                subjective: { energy: actualEnergy, mood: mood },
                alerts: [...todayAlerts],
                mentalExplanation: mentalExplanation,
                physicalExplanation: physicalExplanation
            };
            
            const todayStr = record.date;
            const existingIdx = history.findIndex(h => h.date === todayStr);
            if (existingIdx >= 0) history[existingIdx] = record;
            else history.unshift(record);
            
            localStorage.setItem('fitTrackerHistory_MD', JSON.stringify(history));
            todayData = JSON.parse(JSON.stringify(INITIAL_STATE));
            todayAlerts = [];
            saveDay();
            window.location.reload();
        }

        // ==========================================================================================
        // üõ†Ô∏è UTILIDADES UI
        // ==========================================================================================
        function updateBar(type, val) { 
            const bar = document.getElementById(`bar-${type}`); 
            const txt = document.getElementById(type === 'fatigue' ? 'fatigue-val' : (type === 'mental' ? 'mental-val' : 'phys-val')); 
            if(bar && txt) { 
                bar.style.width = val + '%'; 
                txt.innerText = val + '%'; 
                if(type === 'fatigue') { 
                    bar.className = `h-full rounded-full transition-all duration-700 ${val < 40 ? 'bg-green-500' : (val < 70 ? 'bg-yellow-400' : 'bg-red-500')}`; 
                } 
            } 
        }
        
        function getFatigue7Days() { 
            if (history.length === 0) return 0; 
            const last7 = history.slice(0, 7); 
            let total = 0; 
            last7.forEach(h => { 
                total += (h.stress || 0); 
            }); 
            return Math.round(total / last7.length); 
        }
        
        function addStudySession() { 
            const hInput = document.getElementById('session-hours'); 
            const fInput = document.getElementById('session-focus'); 
            const hours = parseFloat(hInput.value); 
            const focus = parseInt(fInput.value); 
            if (!hours || hours <= 0) { 
                Swal.fire('Error', 'Indica las horas', 'error'); 
                return; 
            } 
            todayData.studySessions.push({ hours, focus, id: Date.now() }); 
            hInput.value = ''; 
            updateDay(); 
            Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 }).fire({ icon: 'success', title: 'A√±adido' }); 
        }
        
        function removeStudySession(index) { 
            todayData.studySessions.splice(index, 1); 
            updateDay(); 
        }
        
        function renderStudySessions() { 
            const list = document.getElementById('studySessionsList'); 
            const totalDisplay = document.getElementById('total-study-hours-display'); 
            let total = 0; 
            const focusLabels = {1: 'Bajo', 2: 'Medio', 3: 'Deep Work'}; 
            const focusColors = {1: 'text-gray-400', 2: 'text-blue-500', 3: 'text-purple-600 font-black'}; 
            if (todayData.studySessions.length === 0) { 
                list.innerHTML = '<p class="text-center text-gray-300 text-xs italic py-4">No hay sesiones registradas hoy.</p>'; 
                totalDisplay.innerText = "0 horas"; 
                document.getElementById('home-study').innerText = "0"; 
                document.getElementById('mini-bar-study').style.width = "0%"; 
                return; 
            } 
            list.innerHTML = todayData.studySessions.map((s, i) => `<div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl border border-gray-100"><div><div class="font-bold text-slate-700 text-sm">${s.hours} horas</div><div class="text-[10px] uppercase ${focusColors[s.focus]}">${focusLabels[s.focus]}</div></div><button onclick="removeStudySession(${i})" class="w-6 h-6 rounded-full bg-white text-red-300 hover:text-red-500 flex items-center justify-center shadow-sm"><i class="fas fa-times text-xs"></i></button></div>`).join(''); 
            todayData.studySessions.forEach(s => total += s.hours); 
            totalDisplay.innerText = total + " horas"; 
            document.getElementById('home-study').innerText = total; 
            document.getElementById('mini-bar-study').style.width = Math.min((total/10)*100, 100) + '%'; 
        }
        
        function updateUI() { 
            renderStudySessions(); 
            document.getElementById('range-mobile').value = todayData.mobileHours; 
            document.getElementById('val-mobile').innerText = todayData.mobileHours; 
            document.getElementById('home-mobile').innerText = `${todayData.mobileHours}h M√≥vil`; 
            document.getElementById('range-steps').value = todayData.steps; 
            document.getElementById('val-steps').innerText = todayData.steps; 
            document.getElementById('home-steps').innerText = todayData.steps; 
            document.getElementById('range-standing').value = todayData.standingHours; 
            document.getElementById('val-standing').innerText = todayData.standingHours; 
            
            renderGymSessions();

            let sum = { cal:0, prot:0, fat:0, sat:0, carb:0 }; 
            todayData.foodLog.forEach(f => { 
                sum.cal+=f.cal; 
                sum.prot+=f.prot; 
                sum.fat+=f.fat; 
                sum.carb+=f.carb; 
                if(f.sat) sum.sat+=f.sat; 
            }); 
            
            const setBar = (id, val, max) => { 
                const p = Math.min((val/max)*100, 100); 
                const el = document.getElementById(`bar-${id}`); 
                if(el) el.style.width = p+'%'; 
                document.getElementById(`val-${id}`).innerText = (val % 1 !== 0 && val < 10) ? val.toFixed(1) : Math.round(val); 
                document.getElementById(`goal-${id}`).innerText = Math.round(max); 
            }; 
            
            setBar('cals', sum.cal, currentGoals.cals); 
            setBar('prot', sum.prot, currentGoals.prot); 
            setBar('fat', sum.fat, currentGoals.fat); 
            setBar('carbs', sum.carb, currentGoals.carbs); 
            setBar('sat', sum.sat, currentGoals.sat); 
            
            document.getElementById('total-consumed-kcal').innerText = Math.round(sum.cal) + ' kcal'; 
            document.getElementById('home-water').innerText = todayData.water; 
            document.getElementById('home-water-goal').innerText = Math.round(currentGoals.water); 
            document.getElementById('mini-bar-water').style.width = Math.min((todayData.water/currentGoals.water)*100, 100) + '%'; 
            
            const wp = Math.min(todayData.water / currentGoals.water, 1); 
            document.getElementById('water-circle').style.strokeDashoffset = 628 - (wp * 628); 
            document.getElementById('water-display-lg').innerText = todayData.water; 
            document.getElementById('water-goal-text').innerText = `Meta din√°mica: ${Math.round(currentGoals.water)} ml`; 
            
            document.getElementById('home-sport-km').innerText = todayData.runKm + todayData.bikeKm; 
            const sportProgress = Math.min(((todayData.runKm + (todayData.bikeKm*0.4)) / 10) * 100, 100); 
            document.getElementById('bar-sport-home').style.width = sportProgress + '%'; 
            document.getElementById('profile-weight-display').innerText = Math.round(USER_BIO.peso); 
            
            document.getElementById('addedFoodsList').innerHTML = todayData.foodLog.map((f, i) => `<div class="flex justify-between items-center text-sm py-3 border-b border-gray-100 last:border-0 bg-white p-3 rounded-xl mb-2 shadow-sm"><div><div class="text-slate-700 font-bold">${f.name} <span class="text-xs text-gray-400 font-normal">(${f.weight}g)</span></div><div class="text-[10px] text-gray-400">P: ${Math.round(f.prot)}g | C: ${Math.round(f.carb)}g | G: ${Math.round(f.fat)}g | S: ${f.sat ? f.sat.toFixed(1) : 0}g</div></div><div class="flex items-center gap-3"><span class="font-bold text-xs text-slate-500 bg-gray-100 px-2 py-1 rounded">${Math.round(f.cal)} kcal</span><button onclick="removeFood(${i})" class="text-red-300 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-red-50 transition"><i class="fas fa-times"></i></button></div></div>`).join('') || '<p class="text-center text-gray-300 text-xs py-4">No has a√±adido comidas a√∫n.</p>'; 
        }
        
        function addGymSession() {
            const muscle = document.getElementById('gym-muscle-select').value;
            const time = parseFloat(document.getElementById('gym-session-time').value);
            const int = parseInt(document.getElementById('gym-session-int').value);
            
            if(!time || time <= 0) { Swal.fire('Error', 'Indica el tiempo', 'error'); return; }
            
            if(!todayData.gymSessions) todayData.gymSessions = [];
            todayData.gymSessions.push({ muscle, time, int });
            
            document.getElementById('gym-session-time').value = '';
            updateSport(); // Recalcula totales
        }

        function removeGymSession(index) {
            todayData.gymSessions.splice(index, 1);
            updateSport();
        }

        function renderGymSessions() {
            const list = document.getElementById('gymSessionsList');
            if(!todayData.gymSessions || todayData.gymSessions.length === 0) {
                list.innerHTML = '<p class="text-xs text-gray-400 text-center italic">Sin sesiones hoy.</p>';
                return;
            }
            
            const intLabels = {1: 'Suave', 2: 'Media', 3: 'Fallo'};
            const intColors = {1: 'text-green-500', 2: 'text-yellow-600', 3: 'text-red-600'};
            
            list.innerHTML = todayData.gymSessions.map((s, i) => `
                <div class="flex justify-between items-center bg-white p-2 rounded-lg border border-gray-100 shadow-sm">
                    <div>
                        <span class="block text-xs font-bold text-slate-700 capitalize">${s.muscle}</span>
                        <span class="text-[10px] text-gray-400">${s.time} min - <span class="${intColors[s.int]} font-bold">${intLabels[s.int]}</span></span>
                    </div>
                    <button onclick="removeGymSession(${i})" class="text-red-300 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }

        function updateSport() { 
            todayData.runKm = parseFloat(document.getElementById('range-run-km').value) || 0; 
            todayData.runPace = parseFloat(document.getElementById('range-run-pace').value) || 5.5; 
            todayData.runInt = parseInt(document.getElementById('range-run-int').value) || 2; 
            todayData.bikeKm = parseFloat(document.getElementById('range-bike-km').value) || 0; 
            todayData.bikeInt = parseInt(document.getElementById('range-bike-int').value) || 2; 
            todayData.steps = parseInt(document.getElementById('range-steps').value) || 0; 
            todayData.standingHours = parseFloat(document.getElementById('range-standing').value) || 0; 
            
            // Calcular Gym Time desde sesiones
            let totalGymTime = 0;
            let maxInt = 1;
            if(todayData.gymSessions) {
                todayData.gymSessions.forEach(s => { totalGymTime += s.time; if(s.int > maxInt) maxInt = s.int; });
            }
            todayData.gymTime = totalGymTime;
            todayData.gymInt = maxInt;
            
            todayData.gymCals = parseFloat(document.getElementById('gym-cals').value) || 0; 
            
            document.getElementById('val-run-km').innerText = todayData.runKm; 
            let min = Math.floor(todayData.runPace); 
            let sec = Math.round((todayData.runPace - min) * 60); 
            document.getElementById('val-run-pace').innerText = `${min}:${sec < 10 ? '0' : ''}${sec}`; 
            
            const ints = ['--', 'Suave', 'Normal', 'Alta']; 
            document.getElementById('val-run-int-text').innerText = ints[todayData.runInt] || '--'; 
            document.getElementById('val-bike-km').innerText = todayData.bikeKm; 
            document.getElementById('val-bike-int-text').innerText = ints[todayData.bikeInt] || '--'; 
            document.getElementById('total-gym-time-display').innerText = todayData.gymTime + ' min';
            
            updateDay(); 
        }
        
        function showDetails(type) { 
            const modal = document.getElementById('info-modal'); 
            const title = document.getElementById('modal-title'); 
            const body = document.getElementById('modal-body'); 
            
            if(type === 'stress') { 
                title.innerText = "Diagn√≥stico Integral"; 
                
                const mentalItems = stressDetails.filter(d => d.cat === 'mental').map(d => `<li class="text-xs ${d.type === 'bad' ? 'text-red-500 font-bold' : 'text-slate-600'}">‚Ä¢ ${d.text}</li>`).join(''); 
                const physItems = stressDetails.filter(d => d.cat === 'physical').map(d => `<li class="text-xs ${d.type === 'bad' ? 'text-red-500 font-bold' : 'text-slate-600'}">‚Ä¢ ${d.text}</li>`).join(''); 
                
                let fatigueMsg = ""; 
                if(fatigue7d < 40) fatigueMsg = "Est√°s fresco/a (Zona Verde). Puedes entrenar duro."; 
                else if(fatigue7d < 70) fatigueMsg = "Fatiga acumulada moderada (Zona Amarilla). Vigila el sue√±o."; 
                else fatigueMsg = "<b>ALERTA ROJA:</b> Sobrecarga sist√©mica. Necesitas un d√≠a de descarga total."; 
                
                body.innerHTML = `<div class="space-y-4">
                    <div class="bg-indigo-50 p-3 rounded-xl border border-indigo-100">
                        <h4 class="font-bold text-indigo-700 text-sm mb-2">üß† Carga Mental (${mentalLoad}%)</h4>
                        <p class="text-xs text-slate-600 mb-2">${mentalExplanation || 'Sin datos'}</p>
                        <ul class="mb-2 space-y-1">${mentalItems || '<li class="text-xs text-gray-400">Sin carga significativa</li>'}</ul>
                    </div>
                    <div class="bg-orange-50 p-3 rounded-xl border border-orange-100">
                        <h4 class="font-bold text-orange-700 text-sm mb-2">üí™ Carga F√≠sica (${physicalLoad}%)</h4>
                        <p class="text-xs text-slate-600 mb-2">${physicalExplanation || 'Sin datos'}</p>
                        <ul class="mb-2 space-y-1">${physItems || '<li class="text-xs text-gray-400">Sin carga significativa</li>'}</ul>
                    </div>
                    <div class="bg-teal-50 p-3 rounded-xl border border-teal-100">
                        <h4 class="font-bold text-teal-700 text-sm mb-2">üìÖ Fatiga Cr√≥nica (7 d√≠as: ${fatigue7d}%)</h4>
                        <p class="text-xs text-teal-800">${fatigueMsg}</p>
                    </div>
                </div>`; 
            } else if (type === 'water') { 
                title.innerText = "Hidrataci√≥n"; 
                body.innerHTML = waterDetails.map(d => `<div class="flex justify-between items-center bg-white border border-gray-100 p-3 rounded-xl mb-2"><span class="text-sm text-slate-600">${d.txt}</span><span class="text-sm font-bold text-blue-500">${d.val}</span></div>`).join('') +
                `<div class="mt-4 p-4 bg-blue-50 rounded-xl border border-blue-100">
                    <p class="text-sm text-slate-700">${getWaterAdvice()}</p>
                </div>`; 
            } else if (type === 'study') { 
                title.innerText = "Detalle Cognitivo"; 
                const focusLabels = {1: 'Bajo', 2: 'Medio', 3: 'Deep Work'}; 
                let content = `<div class="bg-purple-50 p-4 rounded-2xl border border-purple-100 text-sm text-slate-700 mb-4">${studyAdvice}</div>`; 
                content += todayData.studySessions.length ? todayData.studySessions.map(s => `<div class="bg-gray-50 p-3 rounded-xl mb-2 flex justify-between"><span class="font-bold text-slate-700">${s.hours} horas</span><span class="text-xs text-purple-500 font-bold uppercase">${focusLabels[s.focus]}</span></div>`).join('') : '<p class="text-gray-400 text-center italic">Sin sesiones.</p>'; 
                body.innerHTML = content; 
            } else if (type === 'nutrition') { 
                title.innerText = "Control de Dieta"; 
                body.innerHTML = `<p class="text-xs font-bold text-gray-400 uppercase mb-2">Recomendaciones</p><div class="bg-orange-50 p-4 rounded-2xl border border-orange-100 text-sm text-slate-600 mb-4"><ul class="list-disc pl-4 space-y-1">${nutritionAdvice || "<li>Mant√©n una alimentaci√≥n equilibrada.</li>"}</ul></div>`; 
            } else if (type === 'sport') { 
                title.innerText = "Detalle Actividad"; 
                body.innerHTML = `<div class="grid grid-cols-2 gap-3 mb-4"><div class="bg-green-50 p-3 rounded-2xl text-center"><i class="fas fa-shoe-prints text-green-500 text-2xl mb-1"></i><div class="font-bold text-slate-700">${todayData.steps}</div><div class="text-[10px] text-gray-400">Pasos</div></div><div class="bg-orange-50 p-3 rounded-2xl text-center"><i class="fas fa-running text-orange-500 text-2xl mb-1"></i><div class="font-bold text-slate-700">${todayData.runKm} km</div><div class="text-[10px] text-gray-400">Running</div></div></div>`; 
            } 
            modal.classList.add('open'); 
        }
        
        function closeModal(e) { 
            if (e && !e.target.classList.contains('modal-overlay')) return; 
            document.getElementById('info-modal').classList.remove('open'); 
        }
        
        function renderFoodCategories() { 
            const container = document.getElementById('foodCategoriesContainer'); 
            container.innerHTML = ''; 
            const mainMealsConfig = [ 
                { id: 'Desayuno', icon: 'fa-sun', color: 'yellow' }, 
                { id: 'Almuerzo', icon: 'fa-bread-slice', color: 'orange' }, 
                { id: 'Comida', icon: 'fa-utensils', color: 'red' }, 
                { id: 'Merienda', icon: 'fa-cookie-bite', color: 'pink' }, 
                { id: 'Cena', icon: 'fa-moon', color: 'indigo' } 
            ]; 
            
            const mealContainer = document.createElement('div'); 
            mealContainer.className = "mb-6 space-y-3"; 
            mealContainer.innerHTML = '<h3 class="font-bold text-slate-700 text-sm uppercase tracking-wider mb-3 ml-1">üçΩÔ∏è Tiempos de Comida</h3>'; 
            
            mainMealsConfig.forEach(cfg => { 
                if(foodDatabase[cfg.id]) { 
                    mealContainer.appendChild(createSuperGroupStyle( 
                        cfg.id, 
                        cfg.icon, 
                        `bg-${cfg.color}-50`, 
                        `text-${cfg.color}-600`, 
                        `border-${cfg.color}-200`, 
                        [cfg.id] 
                    )); 
                } 
            }); 
            container.appendChild(mealContainer); 
            
            const pantryKeys = ['Frutas', 'Verduras', 'Carnes', 'Pescados', 'Huevos', 'Frutos Secos', 'Legumbres Secas', 'Legumbres Cocidas', 'Cereales Grano', 'Pastas', 'Panes', 'Leches', 'Quesos', 'Yogures', 'Bebidas']; 
            container.appendChild(createSuperGroup('üçé Despensa / Otros', 'bg-green-50', 'text-green-800', 'border-green-100', pantryKeys)); 
            
            const fastFoodKeys = ['Burger King', 'Hamburguesas', 'Acompa√±amientos']; 
            container.appendChild(createSuperGroup('üçî Comida R√°pida', 'bg-orange-50', 'text-orange-800', 'border-orange-100', fastFoodKeys)); 
            
            const sweetKeys = ['Bolleria', 'Dulces']; 
            container.appendChild(createSuperGroup('üç© Boller√≠a y Dulces', 'bg-purple-50', 'text-purple-800', 'border-purple-100', sweetKeys)); 
            
            const sauceKeys = ['Salsas']; 
            container.appendChild(createSuperGroup('ü•´ Salsas', 'bg-red-50', 'text-red-800', 'border-red-100', sauceKeys)); 
        }
        
        function createSuperGroupStyle(title, iconClass, bgClass, textClass, borderClass, keys) { 
            const groupDiv = document.createElement('div'); 
            groupDiv.className = `border ${borderClass} rounded-2xl ${bgClass} overflow-hidden shadow-sm transition hover:shadow-md`; 
            
            const header = document.createElement('div'); 
            header.className = `p-4 font-bold ${textClass} cursor-pointer flex justify-between items-center group-header`; 
            header.innerHTML = `<span class="flex items-center gap-3"><i class="fas ${iconClass} text-lg"></i> ${title}</span> <i class="fas fa-chevron-down opacity-50 transition-transform duration-300"></i>`; 
            header.onclick = function() { 
                this.nextElementSibling.classList.toggle('open'); 
                this.querySelector('.fa-chevron-down').classList.toggle('rotate-180'); 
            }; 
            
            const contentDiv = document.createElement('div'); 
            contentDiv.className = "group-content bg-white"; 
            
            if(keys.length === 1 && foodDatabase[keys[0]]) { 
                contentDiv.innerHTML = renderFoodList(keys[0]); 
            } else { 
                keys.forEach(key => { 
                    if(foodDatabase[key]) { 
                        contentDiv.innerHTML += renderFoodList(key); 
                    } 
                }); 
            } 
            
            groupDiv.appendChild(header); 
            groupDiv.appendChild(contentDiv); 
            return groupDiv; 
        }
        
        function createSuperGroup(title, bgClass, textClass, borderClass, keys) { 
            const groupDiv = document.createElement('div'); 
            groupDiv.className = `border ${borderClass} rounded-2xl ${bgClass} overflow-hidden shadow-sm mb-3`; 
            
            const header = document.createElement('div'); 
            header.className = `p-4 font-bold ${textClass} cursor-pointer flex justify-between items-center group-header`; 
            header.innerHTML = `<span>${title}</span> <i class="fas fa-layer-group opacity-50"></i>`; 
            header.onclick = function() { 
                this.nextElementSibling.classList.toggle('open'); 
            }; 
            
            const contentDiv = document.createElement('div'); 
            contentDiv.className = "group-content bg-white px-2 py-2 space-y-2"; 
            
            keys.forEach(key => { 
                if(foodDatabase[key]) { 
                    const subCat = createAccordion(key, 'bg-gray-50', 'text-gray-600', 'border-gray-200'); 
                    contentDiv.appendChild(subCat); 
                } 
            }); 
            
            groupDiv.appendChild(header); 
            groupDiv.appendChild(contentDiv); 
            return groupDiv; 
        }
        
        function createAccordion(cat, bgClass, textClass, borderClass) { 
            const div = document.createElement('div'); 
            div.className = `border ${borderClass} rounded-2xl ${bgClass} overflow-hidden shadow-sm transition hover:shadow-md`; 
            div.innerHTML = `<div class="p-4 font-bold ${textClass} cursor-pointer flex justify-between items-center group-header" onclick="this.nextElementSibling.classList.toggle('open')"><span class="flex items-center gap-2">${cat}</span> <i class="fas fa-chevron-down text-xs opacity-50"></i></div><div class="meal-content bg-slate-50">${renderFoodList(cat)}</div>`; 
            return div; 
        }
        
        function renderFoodList(cat) { 
            if(!foodDatabase[cat]) return ''; 
            return foodDatabase[cat].map((f, i) => `<div class="p-3 border-t border-gray-100 flex items-center justify-between hover:bg-blue-50/30 transition px-4 gap-2 search-item bg-white"><div class="flex-1"><div class="font-bold text-sm text-slate-700 item-name">${f.name}</div><div class="text-[10px] text-gray-400 font-mono mt-0.5">Base: ${f.cal} kcal / ${f.weight}g</div></div><div class="flex items-center gap-2"><input type="number" id="weight-${cat.replace(/\s+/g, '')}-${i}" value="${f.weight}" class="w-14 bg-white border border-gray-200 rounded-lg text-xs font-bold text-center py-2 focus:border-blue-500 outline-none shadow-sm" placeholder="g"><span class="text-[10px] text-gray-400">g</span></div><div class="flex gap-2 ml-1"><button onclick="viewCalculatedDetails('${cat}', ${i})" class="w-8 h-8 rounded-full bg-white border border-gray-200 text-gray-400 hover:text-blue-500 shadow-sm flex items-center justify-center"><i class="fas fa-search text-xs"></i></button><button onclick="addCalculatedFood('${cat}', ${i})" class="w-8 h-8 rounded-full bg-primary text-white shadow-sm active:scale-90 transition flex items-center justify-center"><i class="fas fa-plus text-xs"></i></button></div></div>`).join(''); 
        }
        
        function searchGlobal(query) { 
            const results = document.getElementById('searchResults'); 
            if (query.length < 2) { 
                results.classList.add('hidden'); 
                return; 
            } 
            results.classList.remove('hidden'); 
            results.innerHTML = ''; 
            let count = 0; 
            for (const cat in foodDatabase) { 
                foodDatabase[cat].forEach((f, i) => { 
                    if (f.name.toLowerCase().includes(query.toLowerCase()) && count < 10) { 
                        count++; 
                        const div = document.createElement('div'); 
                        div.className = 'p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 flex justify-between items-center'; 
                        div.innerHTML = `<span class="text-sm font-bold text-slate-700">${f.name}</span> <span class="text-xs text-gray-400">${f.cal} kcal</span>`; 
                        div.onclick = () => { 
                            viewCalculatedDetails(cat, i, true); 
                            results.classList.add('hidden'); 
                            document.getElementById('globalSearch').value = ''; 
                        }; 
                        results.appendChild(div); 
                    } 
                }); 
            } 
            if(count === 0) results.innerHTML = '<div class="p-3 text-xs text-gray-400">No encontrado</div>'; 
        }
        
        function getCalculatedFood(cat, idx) { 
            const base = foodDatabase[cat][idx]; 
            const catId = cat.replace(/\s+/g, ''); 
            const inputEl = document.getElementById(`weight-${catId}-${idx}`); 
            const inputVal = inputEl ? inputEl.value : base.weight; 
            const newWeight = parseFloat(inputVal) || base.weight; 
            const ratio = newWeight / base.weight; 
            return { name: base.name, weight: newWeight, cal: base.cal * ratio, prot: base.prot * ratio, fat: base.fat * ratio, carb: base.carb * ratio, sat: (base.sat || 0) * ratio }; 
        }
        
        function viewCalculatedDetails(cat, idx, fromSearch = false) { 
            const base = foodDatabase[cat][idx]; 
            let initialWeight = base.weight; 
            if (!fromSearch) { 
                const catId = cat.replace(/\s+/g, ''); 
                const listInput = document.getElementById(`weight-${catId}-${idx}`); 
                if (listInput) initialWeight = parseFloat(listInput.value) || base.weight; 
            } 
            
            Swal.fire({ 
                title: base.name, 
                html: `<div class="mb-4"><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Cantidad (Gramos)</label><input id="swal-grams" type="number" value="${initialWeight}" class="w-full bg-gray-100 border border-gray-200 rounded-xl p-3 text-center text-xl font-bold text-slate-700 focus:border-blue-500 outline-none"></div><div id="swal-stats" class="grid grid-cols-2 gap-3 text-center mb-2 transition-all"></div>`, 
                confirmButtonText: 'A√±adir a Dieta', 
                confirmButtonColor: '#3b82f6', 
                showCancelButton: true, 
                cancelButtonText: 'Cancelar', 
                didOpen: () => { 
                    const input = document.getElementById('swal-grams'); 
                    const stats = document.getElementById('swal-stats'); 
                    const updateStats = () => { 
                        const w = parseFloat(input.value) || 0; 
                        const ratio = w / base.weight; 
                        const satVal = (base.sat || 0) * ratio; 
                        const displaySat = (satVal % 1 !== 0 && satVal < 10) ? satVal.toFixed(1) : Math.round(satVal); 
                        stats.innerHTML = `<div class="bg-gray-50 p-2 rounded-lg"><span class="block text-xs text-gray-400">Energ√≠a</span><span class="font-bold text-slate-700">${Math.round(base.cal * ratio)} kcal</span></div><div class="bg-gray-50 p-2 rounded-lg"><span class="block text-xs text-green-500">Prote√≠na</span><span class="font-bold text-green-600">${Math.round(base.prot * ratio)}g</span></div><div class="bg-gray-50 p-2 rounded-lg"><span class="block text-xs text-yellow-500">Grasas</span><span class="font-bold text-yellow-600">${Math.round(base.fat * ratio)}g</span></div><div class="bg-gray-50 p-2 rounded-lg"><span class="block text-xs text-red-500">Carbos</span><span class="font-bold text-red-600">${Math.round(base.carb * ratio)}g</span></div><div class="bg-gray-50 p-2 rounded-lg col-span-2"><span class="block text-xs text-yellow-700">G. Saturadas</span><span class="font-bold text-yellow-800">${displaySat}g</span></div>`; 
                    }; 
                    input.addEventListener('input', updateStats); 
                    updateStats(); 
                }, 
                preConfirm: () => { 
                    const finalWeight = parseFloat(document.getElementById('swal-grams').value) || base.weight; 
                    const ratio = finalWeight / base.weight; 
                    return { name: base.name, weight: finalWeight, cal: base.cal * ratio, prot: base.prot * ratio, fat: base.fat * ratio, carb: base.carb * ratio, sat: (base.sat || 0) * ratio }; 
                } 
            }).then((result) => { 
                if (result.isConfirmed) { 
                    todayData.foodLog.push(result.value); 
                    updateDay(); 
                    Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 }).fire({ icon: 'success', title: 'A√±adido' }); 
                } 
            }); 
        }
        
        function addCalculatedFood(cat, idx) { 
            const f = getCalculatedFood(cat, idx); 
            todayData.foodLog.push(f); 
            updateDay(); 
            Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 }).fire({ icon: 'success', title: 'A√±adido' }); 
        }
        
        function removeFood(i) { 
            todayData.foodLog.splice(i, 1); 
            updateDay(); 
        }
        
        function addWater(ml) { 
            todayData.water += ml; 
            updateDay(); 
        }
        
        function removeWater(ml) { 
            if(todayData.water >= ml) { 
                todayData.water -= ml; 
                updateDay(); 
            } 
        }
        
        function openCustomFoodModal() { 
            Swal.fire({ 
                title: 'Crear Alimento', 
                html: `<input id="swal-n" class="swal2-input" placeholder="Nombre"><div class="grid grid-cols-2 gap-2"><input id="swal-k" type="number" class="swal2-input" placeholder="Kcal"><input id="swal-p" type="number" class="swal2-input" placeholder="Prot"><input id="swal-c" type="number" class="swal2-input" placeholder="Carb"><input id="swal-f" type="number" class="swal2-input" placeholder="Fat"><input id="swal-s" type="number" class="swal2-input" placeholder="Sat. Fat"><input id="swal-w" type="number" class="swal2-input" placeholder="Gramos (ref)"></div>`, 
                confirmButtonColor: '#1e293b', 
                confirmButtonText: 'Guardar', 
                preConfirm: () => ({ 
                    name: document.getElementById('swal-n').value, 
                    cal: Number(document.getElementById('swal-k').value), 
                    prot: Number(document.getElementById('swal-p').value), 
                    fat: Number(document.getElementById('swal-f').value), 
                    carb: Number(document.getElementById('swal-c').value), 
                    sat: Number(document.getElementById('swal-s').value), 
                    weight: Number(document.getElementById('swal-w').value) || 100 
                }) 
            }).then(r => { 
                if(r.value) { 
                    todayData.foodLog.push(r.value); 
                    updateDay(); 
                } 
            }); 
        }
        
        function saveDay() { 
            localStorage.setItem('fitTrackerToday_MD', JSON.stringify(todayData)); 
        }
        
        function loadDay() { 
            const s = localStorage.getItem('fitTrackerToday_MD'); 
            if(s) { 
                const loaded = JSON.parse(s); 
                todayData = { ...INITIAL_STATE, ...loaded }; 
                if (!Array.isArray(todayData.studySessions)) todayData.studySessions = []; 
                if(document.getElementById('wakeTime')) document.getElementById('wakeTime').value = todayData.wakeTime; 
                if(document.getElementById('sleepHours')) document.getElementById('sleepHours').value = todayData.sleepHours || ''; 
                if(document.getElementById('sleepQuality')) document.getElementById('sleepQuality').value = todayData.sleepQuality || ''; 
                
                document.getElementById('range-run-km').value = todayData.runKm || 0; 
                document.getElementById('range-run-pace').value = todayData.runPace || 5.5; 
                document.getElementById('range-run-int').value = todayData.runInt || 2; 
                document.getElementById('range-bike-km').value = todayData.bikeKm || 0; 
                document.getElementById('range-bike-int').value = todayData.bikeInt || 2; 
                document.getElementById('gym-cals').value = todayData.gymCals || ''; 
                document.getElementById('range-mobile').value = todayData.mobileHours || 0; 
                document.getElementById('range-steps').value = todayData.steps || 0; 
                document.getElementById('range-standing').value = todayData.standingHours || 0; 
                if (!todayData.gymSessions) todayData.gymSessions = [];
            } 
        }
        
        function navigateTo(id) { 
            document.querySelectorAll('.page-section').forEach(e=>e.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); 
            document.getElementById('nav-'+id).classList.add('active'); 
            window.scrollTo(0,0); 
        }
        
        function updateHistoryUI() { 
            const list = document.getElementById('historyList'); 
            if(history.length === 0) { 
                list.innerHTML = '<div class="text-center text-gray-400 mt-10"><i class="fas fa-history text-4xl mb-3 opacity-30"></i><p>Sin historial</p></div>'; 
                return; 
            } 
            list.innerHTML = history.map((h, i) => `<div class="card p-5 flex justify-between items-center shadow-sm hover:shadow-md transition"><div><div class="font-bold text-slate-800 capitalize text-sm">${h.date}</div><div class="text-[10px] text-gray-400 mt-1">Carga Global: <b>${h.stress || 0}%</b></div></div><div class="flex gap-2"><button onclick="restoreDay(${i})" class="w-10 h-10 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center hover:bg-orange-200 transition"><i class="fas fa-undo-alt text-sm"></i></button><button onclick="generateBeautifulPDF(${i})" class="bg-slate-800 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition"><i class="fas fa-file-pdf text-sm"></i></button><button onclick="deleteDay(${i})" class="w-10 h-10 rounded-full bg-red-100 text-red-500 flex items-center justify-center hover:bg-red-200 transition"><i class="fas fa-trash-alt text-sm"></i></button></div></div>`).join(''); 
        }
        
        function restoreDay(index) { 
            Swal.fire({ 
                title: '¬øRestaurar este d√≠a?', 
                text: "Esto sobreescribir√° lo que lleves registrado hoy.", 
                icon: 'question', 
                showCancelButton: true, 
                confirmButtonText: 'S√≠, restaurar', 
                confirmButtonColor: '#f59e0b' 
            }).then((result) => { 
                if(result.isConfirmed) { 
                    todayData = history[index].data; 
                    history.splice(index, 1); 
                    localStorage.setItem('fitTrackerHistory_MD', JSON.stringify(history)); 
                    saveDay(); 
                    window.location.reload(); 
                } 
            }); 
        }
        
        function deleteDay(index) { 
            Swal.fire({ 
                title: '¬øEliminar registro?', 
                text: "No se podr√° recuperar.", 
                icon: 'warning', 
                showCancelButton: true, 
                confirmButtonText: 'S√≠, eliminar', 
                confirmButtonColor: '#ef4444' 
            }).then((result) => { 
                if(result.isConfirmed) { 
                    history.splice(index, 1); 
                    localStorage.setItem('fitTrackerHistory_MD', JSON.stringify(history)); 
                    updateHistoryUI(); 
                    Swal.fire('Eliminado', '', 'success'); 
                } 
            }); 
        }
        
        function generateBeautifulPDF(index) {
            const rec = history[index];
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const dark = [30, 41, 59];
            
            doc.setFillColor(...dark);
            doc.rect(0, 0, 210, 45, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("INFORME DE RENDIMIENTO", 105, 20, null, null, "center");
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(rec.date.toUpperCase(), 105, 32, null, null, "center");
            
            let y = 55;
            
            doc.setTextColor(0, 0, 0);
            doc.setFillColor(240, 240, 240);
            doc.rect(14, y-5, 180, 25, 'F');
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("RESUMEN DEL DIA", 20, y);
            y += 10;
            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            doc.text(`Carga Global: ${rec.stress}% | Energia Subjetiva: ${rec.subjective ? rec.subjective.energy : 'N/A'}/10 | Estado: ${rec.subjective ? rec.subjective.mood : 'N/A'}`, 20, y);
            y += 15;
            
            doc.setFillColor(79, 70, 229);
            doc.rect(14, y-3, (rec.stressScores.mental * 1.8), 6, 'F');
            doc.setFillColor(249, 115, 22);
            doc.rect(14, y+5, (rec.stressScores.physical * 1.8), 6, 'F');
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Mental: ${rec.stressScores.mental}%`, 160, y);
            doc.text(`Fisica: ${rec.stressScores.physical}%`, 160, y+8);
            y += 20;
            
            if (rec.mentalExplanation) {
                doc.setFontSize(10);
                doc.setTextColor(79, 70, 229);
                doc.text(`Mental: ${rec.mentalExplanation}`, 14, y);
                y += 6;
            }
            if (rec.physicalExplanation) {
                doc.setFontSize(10);
                doc.setTextColor(249, 115, 22);
                doc.text(`Fisica: ${rec.physicalExplanation}`, 14, y);
                y += 10;
            }
            
            const metricData = [
                ['Sue√±o', `${rec.data.sleepHours}h / ${rec.data.sleepQuality}%`, 'Pasos', `${rec.data.steps}`],
                ['Agua', `${rec.data.water} ml / ${Math.round(rec.goals.water)} ml`, 'Movil', `${rec.data.mobileHours}h`],
                ['Running', `${rec.data.runKm} km`, 'Ciclismo', `${rec.data.bikeKm} km`],
                ['Gym', `${rec.data.gymTime || 0} min / ${rec.data.gymCals || 0} kcal`, 'Horas Pie', `${rec.data.standingHours}h`]
            ];
            
            doc.autoTable({
                startY: y,
                head: [['Metrica', 'Valor', 'Metrica', 'Valor']],
                body: metricData,
                theme: 'grid',
                headStyles: { fillColor: dark, textColor: [255,255,255] },
                styles: { fontSize: 9, cellPadding: 3 },
                columnStyles: { 0: { cellWidth: 40 }, 1: { cellWidth: 35 }, 2: { cellWidth: 40 }, 3: { cellWidth: 35 } }
            });
            
            y = doc.lastAutoTable.finalY + 10;
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("SESIONES DE ESTUDIO", 14, y);
            y += 5;
            
            if (rec.data.studySessions && rec.data.studySessions.length > 0) {
                const studyRows = rec.data.studySessions.map(s => [
                    s.hours + 'h',
                    s.focus === 1 ? 'Bajo' : (s.focus === 2 ? 'Medio' : 'Alto')
                ]);
                doc.autoTable({
                    startY: y,
                    head: [['Duracion', 'Foco']],
                    body: studyRows,
                    theme: 'striped',
                    headStyles: { fillColor: [139, 92, 246] },
                    styles: { fontSize: 9 }
                });
                y = doc.lastAutoTable.finalY + 10;
            } else {
                doc.setFontSize(10);
                doc.setTextColor(150, 150, 150);
                doc.text("Sin sesiones de estudio registradas.", 14, y+5);
                y += 15;
            }
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("REGISTRO NUTRICIONAL", 14, y);
            y += 5;
            
            if (rec.data.foodLog && rec.data.foodLog.length > 0) {
                const foodBody = rec.data.foodLog.map(f => [
                    f.name.substring(0, 20),
                    Math.round(f.cal),
                    Math.round(f.prot),
                    Math.round(f.fat),
                    Math.round(f.carb),
                    f.sat ? f.sat.toFixed(1) : '0'
                ]);
                
                const totalCal = rec.data.foodLog.reduce((a,b)=>a+b.cal,0);
                const totalProt = rec.data.foodLog.reduce((a,b)=>a+b.prot,0);
                const totalFat = rec.data.foodLog.reduce((a,b)=>a+b.fat,0);
                const totalCarb = rec.data.foodLog.reduce((a,b)=>a+b.carb,0);
                const totalSat = rec.data.foodLog.reduce((a,b)=>a+(b.sat||0),0);
                
                foodBody.push(['TOTAL', Math.round(totalCal), Math.round(totalProt), Math.round(totalFat), Math.round(totalCarb), totalSat.toFixed(1)]);
                
                doc.autoTable({
                    startY: y,
                    head: [['Alimento', 'Kcal', 'Prot', 'Grasa', 'Carb', 'Sat']],
                    body: foodBody,
                    theme: 'grid',
                    headStyles: { fillColor: [34, 197, 94] },
                    styles: { fontSize: 8 },
                    columnStyles: { 0: { cellWidth: 60 } }
                });
                y = doc.lastAutoTable.finalY + 10;
            } else {
                doc.setFontSize(10);
                doc.setTextColor(150, 150, 150);
                doc.text("Sin alimentos registrados.", 14, y+5);
                y += 15;
            }
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("ALERTAS DEL DIA", 14, y);
            y += 5;
            
            if (rec.alerts && rec.alerts.length > 0) {
                const alertBody = rec.alerts.map(a => {
                    let typeText = a.type === 'water' ? 'Agua' : (a.type === 'nutrition' ? 'Nutricion' : 'Comida');
                    return [typeText, a.message];
                });
                doc.autoTable({
                    startY: y,
                    head: [['Tipo', 'Alerta']],
                    body: alertBody,
                    theme: 'grid',
                    headStyles: { fillColor: [239, 68, 68] },
                    styles: { fontSize: 9 }
                });
            } else {
                doc.setFontSize(10);
                doc.setTextColor(150, 150, 150);
                doc.text("No hubo alertas este dia.", 14, y+5);
            }
            
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`FitTracker AI - Informe generado el ${new Date().toLocaleDateString()}`, 105, 285, null, null, 'center');
            }
            
            const blob = doc.output('bloburl');
            window.open(blob, '_blank');
        }
    </script>
</body>
</html>
