<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitTracker Medical - Final Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', 
                        secondary: '#10b981',
                        danger: '#ef4444',
                        dark: '#1e293b',
                        light: '#f8fafc',
                        study: '#8b5cf6',
                        muscle: '#f59e0b'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9; 
            -webkit-tap-highlight-color: transparent; 
            padding-bottom: 140px;
        }
        
        .card { background: white; border-radius: 24px; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.08); transition: transform 0.2s; border: 1px solid #f1f5f9; }
        .card-clickable:active { transform: scale(0.98); background-color: #f8fafc; }
        
        .modal-overlay { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal-content { transform: scale(0.9); opacity: 0; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .modal-overlay.open .modal-content { transform: scale(1); opacity: 1; }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 28px; width: 28px; border-radius: 50%;
            background: white; border: 2px solid #3b82f6; cursor: pointer; margin-top: -12px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer; background: #e2e8f0; border-radius: 99px;
        }

        input[type="time"] { -webkit-appearance: none; appearance: none; background-color: #f9fafb; min-width: 95px; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .nav-item.active { color: #3b82f6; transform: translateY(-2px); }
        .nav-item.active i { transform: scale(1.1); }
        .nav-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: #94a3b8; }
        
        .page-section { display: none; opacity: 0; animation: fadeIn 0.4s ease-out forwards; }
        .page-section.active { display: block; opacity: 1; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .meal-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        .meal-content.open { max-height: 4000px; }

        .group-header { cursor: pointer; transition: background 0.2s; }
        .group-header:active { background-color: #f1f5f9; }
        .group-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease; }
        .group-content.open { max-height: 5000px; }

        .pb-safe-area { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>

    <header class="fixed top-0 w-full bg-white/90 backdrop-blur-xl z-40 border-b border-gray-100 px-6 py-4 flex justify-between items-center shadow-sm">
        <button onclick="navigateTo('registro')" class="text-gray-400 hover:text-primary transition"><i class="fas fa-history text-xl"></i></button>
        <div class="text-center">
            <h1 class="text-lg font-black text-slate-800 tracking-tighter italic">FIT<span class="text-primary">TRACKER</span></h1>
            <p id="season-indicator" class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Detectando...</p>
        </div>
        <button onclick="finishDay()" class="text-gray-400 hover:text-green-500 transition"><i class="fas fa-check-circle text-xl"></i></button>
    </header>

    <main class="container mx-auto px-5 mt-24 max-w-lg">

        <div id="inicio" class="page-section active">
            
            <div class="card p-5 mb-5 border-l-4 border-indigo-500 relative">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2"><i class="fas fa-moon text-indigo-500"></i> Recuperaci√≥n SNC</h3>
                    <span id="sleep-score" class="text-[10px] font-bold bg-indigo-50 text-indigo-600 px-2 py-1 rounded">--</span>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label class="text-[10px] text-gray-400 uppercase font-bold block mb-1">Hora Despertar</label>
                        <input type="time" id="wakeTime" onchange="updateDay()" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-3 text-sm focus:border-indigo-500 outline-none font-bold text-slate-600">
                    </div>
                    <div class="grid grid-cols-2 gap-3 sm:col-span-2">
                        <div>
                            <label class="text-[10px] text-gray-400 uppercase font-bold block mb-1">Horas</label>
                            <input type="number" id="sleepHours" placeholder="8" oninput="updateDay()" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-3 text-sm text-center focus:border-indigo-500 outline-none font-bold text-slate-600">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 uppercase font-bold block mb-1">Calidad (Watch)</label>
                            <input type="number" id="sleepQuality" placeholder="%" oninput="updateDay()" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-3 text-sm text-center focus:border-indigo-500 outline-none font-bold text-slate-600">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-5 mb-5 border-b-4 border-slate-400 card-clickable cursor-pointer" onclick="showDetails('stress')">
                <div class="flex justify-between mb-2">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Carga Fisiol√≥gica</p>
                    <i class="fas fa-heart-pulse text-red-400 text-xs"></i>
                </div>
                <div class="flex items-end justify-between mb-3">
                    <div class="leading-none">
                        <span id="stress-score-num" class="text-2xl font-black text-slate-700 block">0%</span>
                        <span id="stress-msg-mini" class="text-[10px] text-gray-400 font-medium">Reposo</span>
                    </div>
                    <i class="fas fa-bolt text-slate-300 text-xl" id="stress-icon"></i>
                </div>
                <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                    <div id="stress-bar" class="bg-slate-400 h-full w-0 transition-all duration-700 rounded-full"></div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-5">
                <div class="card p-5 border-b-4 border-blue-400 card-clickable cursor-pointer" onclick="showDetails('water')">
                    <div class="flex justify-between mb-2">
                        <p class="text-[10px] text-gray-400 font-bold uppercase">Hidrataci√≥n</p>
                        <i class="fas fa-info-circle text-blue-100 text-xs"></i>
                    </div>
                    <div class="flex items-end justify-between mb-3">
                        <div class="leading-none">
                            <span class="text-2xl font-bold text-slate-700 block" id="home-water">0</span>
                            <span class="text-[10px] text-gray-400 font-medium">/ <span id="home-water-goal">0</span> ml</span>
                        </div>
                        <i class="fas fa-glass-water text-blue-500 text-xl"></i>
                    </div>
                    <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                        <div id="mini-bar-water" class="bg-blue-400 h-full w-0 transition-all duration-500 rounded-full"></div>
                    </div>
                </div>

                <div class="card p-5 border-b-4 border-study card-clickable cursor-pointer" onclick="showDetails('study')">
                    <div class="flex justify-between mb-2">
                        <p class="text-[10px] text-gray-400 font-bold uppercase">Productividad</p>
                        <i class="fas fa-info-circle text-purple-100 text-xs"></i>
                    </div>
                    <div class="flex items-end justify-between mb-3">
                        <div class="leading-none">
                            <span class="text-2xl font-bold text-slate-700 block"><span id="home-study">0</span>h</span>
                            <span class="text-[10px] text-gray-400 font-medium" id="home-mobile">0h M√≥vil</span>
                        </div>
                        <i class="fas fa-brain text-study text-xl"></i>
                    </div>
                    <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                         <div id="mini-bar-study" class="bg-study h-full w-0 transition-all duration-500 rounded-full"></div>
                    </div>
                </div>
            </div>

            <div class="card p-5 mb-5 border-l-4 border-orange-500 card-clickable cursor-pointer" onclick="showDetails('sport')">
                <div class="flex justify-between mb-2">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Deporte & Actividad</p>
                    <i class="fas fa-dumbbell text-orange-400 text-xs"></i>
                </div>
                <div class="flex items-end justify-between mb-3">
                    <div class="leading-none">
                        <span class="text-2xl font-bold text-slate-700 block"><span id="home-sport-km">0</span> <span class="text-base font-normal text-gray-400">km</span></span>
                        <span class="text-[10px] text-gray-400 font-medium"><span id="home-steps">0</span> pasos</span>
                    </div>
                    <i class="fas fa-running text-orange-500 text-xl"></i>
                </div>
                <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                    <div id="bar-sport-home" class="bg-orange-500 h-full w-0 transition-all duration-500 rounded-full"></div>
                </div>
            </div>
            
            <div class="card p-6 card-clickable cursor-pointer" onclick="showDetails('nutrition')">
                <div class="flex justify-between items-center mb-5">
                    <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2"><i class="fas fa-fire text-orange-500"></i> Combustible (60kg)</h3>
                    <span class="text-[10px] bg-orange-50 text-orange-600 px-3 py-1 rounded-full font-bold">Meta: <span id="goal-cals">2400</span> kcal</span>
                </div>

                <div class="space-y-5">
                    <div>
                        <div class="flex justify-between text-xs mb-1 font-bold text-slate-600">
                            <span>Energ√≠a Total</span>
                            <span><span id="val-cals">0</span> kcal</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden">
                            <div id="bar-cals" class="bg-slate-800 h-full rounded-full transition-all duration-700" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <span class="text-[10px] text-gray-400 font-bold block mb-1">Prote√≠na</span>
                            <div class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden mb-1">
                                <div id="bar-prot" class="h-full bg-green-500 w-0 rounded-full"></div>
                            </div>
                            <span class="text-[10px] text-right block font-mono text-slate-600"><span id="val-prot">0</span>/<span id="goal-prot">0</span>g</span>
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-400 font-bold block mb-1">Grasas</span>
                            <div class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden mb-1">
                                <div id="bar-fat" class="h-full bg-yellow-400 w-0 rounded-full"></div>
                            </div>
                            <span class="text-[10px] text-right block font-mono text-slate-600"><span id="val-fat">0</span>/<span id="goal-fat">0</span>g</span>
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-400 font-bold block mb-1">Carbos</span>
                            <div class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden mb-1">
                                <div id="bar-carbs" class="h-full bg-red-400 w-0 rounded-full"></div>
                            </div>
                            <span class="text-[10px] text-right block font-mono text-slate-600"><span id="val-carbs">0</span>/<span id="goal-carbs">0</span>g</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="comida" class="page-section">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800 tracking-tight">Registro de Dieta</h2>
                <button onclick="openCustomFoodModal()" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-xs font-bold active:scale-95 transition shadow-lg shadow-slate-200">
                    + Crear Alimento
                </button>
            </div>
            
            <div class="relative mb-6">
                <input type="text" id="globalSearch" onkeyup="searchGlobal(this.value)" placeholder="üîç Buscar alimento..." class="w-full bg-white p-4 pl-12 rounded-2xl border border-gray-100 shadow-sm text-sm focus:ring-2 focus:ring-primary/20 outline-none transition">
                <div id="searchResults" class="absolute z-20 w-full bg-white shadow-xl rounded-xl mt-2 hidden max-h-60 overflow-y-auto border border-gray-100 px-2 py-2"></div>
            </div>

            <div id="foodCategoriesContainer" class="space-y-4 pb-8"></div>

            <div class="mt-6 pt-6 border-t border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Consumido Hoy</h3>
                    <span id="total-consumed-kcal" class="text-xs font-bold text-slate-800 bg-slate-100 px-2 py-1 rounded">0 kcal</span>
                </div>
                <div id="addedFoodsList" class="space-y-2 pb-24"></div>
            </div>
        </div>

        <div id="agua" class="page-section">
            <h2 class="text-2xl font-bold text-center text-slate-800 mb-1">Monitor de Hidrataci√≥n</h2>
            <div id="water-goal-text" class="text-center text-xs text-blue-600 font-bold bg-blue-50 py-1.5 px-4 rounded-full mx-auto w-max mb-8 border border-blue-100 shadow-sm">Meta din√°mica: Calculando...</div>
            
            <div class="flex flex-col items-center">
                <div class="relative w-64 h-64 mb-10 flex items-center justify-center">
                    <svg class="w-full h-full transform -rotate-90 filter drop-shadow-2xl">
                        <circle cx="128" cy="128" r="100" stroke="#f1f5f9" stroke-width="20" fill="transparent"/>
                        <circle id="water-circle" cx="128" cy="128" r="100" stroke="#3b82f6" stroke-width="20" fill="transparent" stroke-dasharray="628" stroke-dashoffset="628" stroke-linecap="round" class="transition-all duration-1000 ease-out"/>
                    </svg>
                    <div class="absolute text-center">
                        <i class="fas fa-droplet text-blue-400 text-3xl mb-2 animate-bounce"></i>
                        <span id="water-display-lg" class="text-5xl font-black text-slate-800 block tracking-tighter">0</span>
                        <span class="text-sm text-gray-400 font-medium">ml bebidos</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 w-full px-2">
                    <button onclick="addWater(250)" class="bg-white py-6 rounded-3xl shadow-lg shadow-blue-50 border border-blue-50 hover:border-blue-300 active:scale-95 transition flex flex-col items-center justify-center gap-2 group">
                        <div class="bg-blue-50 w-14 h-14 rounded-full flex items-center justify-center group-hover:bg-blue-500 transition-colors"><i class="fas fa-glass-water text-blue-500 group-hover:text-white transition-colors text-xl"></i></div>
                        <span class="font-bold text-slate-600 text-sm">Vaso<br><span class="text-xs text-gray-400 font-normal">250 ml</span></span>
                    </button>
                    <button onclick="addWater(1000)" class="bg-white py-6 rounded-3xl shadow-lg shadow-blue-50 border border-blue-50 hover:border-blue-300 active:scale-95 transition flex flex-col items-center justify-center gap-2 group">
                         <div class="bg-blue-50 w-14 h-14 rounded-full flex items-center justify-center group-hover:bg-blue-500 transition-colors"><i class="fas fa-bottle-water text-blue-600 group-hover:text-white transition-colors text-xl"></i></div>
                        <span class="font-bold text-slate-600 text-sm">Garrafa<br><span class="text-xs text-gray-400 font-normal">1000 ml</span></span>
                    </button>
                </div>
            </div>
        </div>

        <div id="estudio" class="page-section">
            <h2 class="text-2xl font-bold mb-6 text-slate-800 tracking-tight">Carga Cognitiva</h2>
            
            <div class="card p-6 mb-6">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-mobile-alt text-slate-500"></i> Uso del M√≥vil</h3>
                <div class="mb-2">
                    <div class="flex justify-between text-xs font-bold text-gray-500 mb-2">
                        <span>Horas de pantalla hoy</span>
                        <span class="text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded"><span id="val-mobile">0</span> horas</span>
                    </div>
                    <input type="range" min="0" max="12" step="0.5" value="0" id="range-mobile" oninput="updateStudy()">
                    <p class="text-[10px] text-gray-400 mt-2 italic">*El uso excesivo afecta a la carga fisiol√≥gica.</p>
                </div>
            </div>

            <div class="card p-6 mb-6">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-clock text-study"></i> Nueva Sesi√≥n Estudio</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">Duraci√≥n (Horas)</label>
                        <input type="number" id="session-hours" placeholder="ej: 4" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-3 font-bold text-slate-700 outline-none focus:border-study">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">Foco</label>
                        <select id="session-focus" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-3 font-bold text-slate-700 outline-none focus:border-study">
                            <option value="1">Bajo / Distra√≠do</option>
                            <option value="2" selected>Medio / Normal</option>
                            <option value="3">Alto / Deep Work</option>
                        </select>
                    </div>
                </div>
                <button onclick="addStudySession()" class="w-full bg-study text-white font-bold py-3 rounded-xl shadow-lg shadow-purple-100 active:scale-95 transition">
                    + A√±adir Sesi√≥n
                </button>
            </div>

            <div class="card p-6 mb-24">
                <div class="flex justify-between items-center mb-4">
                     <h3 class="font-bold text-slate-700 text-sm">Sesiones Hoy</h3>
                     <span class="text-xs font-bold text-study bg-purple-50 px-2 py-1 rounded" id="total-study-hours-display">0 horas</span>
                </div>
                <div id="studySessionsList" class="space-y-3">
                    <p class="text-center text-gray-300 text-xs italic py-4">No hay sesiones registradas hoy.</p>
                </div>
            </div>
        </div>

        <div id="deporte" class="page-section">
            <h2 class="text-2xl font-bold mb-6 text-slate-800 tracking-tight">Actividad & Gym</h2>

            <div class="card p-6 mb-6 border-l-4 border-green-500">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-shoe-prints text-green-500"></i> Actividad de Hoy</h3>
                <div class="space-y-5">
                    <div>
                        <div class="flex justify-between text-xs font-bold text-gray-500 mb-2">
                            <span>Pasos Totales</span>
                            <span class="text-green-600 bg-green-50 px-2 py-0.5 rounded"><span id="val-steps">0</span></span>
                        </div>
                        <input type="range" min="0" max="30000" step="100" value="0" id="range-steps" oninput="updateSport()">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs font-bold text-gray-500 mb-2">
                            <span>Horas de pie</span>
                            <span class="text-slate-600 bg-slate-50 px-2 py-0.5 rounded"><span id="val-standing">0</span> h</span>
                        </div>
                        <input type="range" min="0" max="16" step="0.5" value="0" id="range-standing" oninput="updateSport()">
                    </div>
                </div>
            </div>
            
            <div class="card p-6 mb-6 border-l-4 border-orange-500">
                <div class="flex items-center gap-4 mb-6">
                    <div class="bg-orange-100 p-3 rounded-xl text-orange-600 shadow-sm"><i class="fas fa-running text-2xl"></i></div>
                    <div>
                        <h3 class="font-bold text-slate-700 text-lg">Running</h3>
                        <p class="text-[10px] text-gray-400 font-bold uppercase">Cardio / Quema Grasa</p>
                    </div>
                </div>
                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between text-xs font-bold text-gray-500 mb-2">
                            <span>Distancia</span>
                            <span class="text-orange-600 bg-orange-50 px-2 py-0.5 rounded"><span id="val-run-km">0</span> km</span>
                        </div>
                        <input type="range" min="0" max="30" step="0.5" value="0" id="range-run-km" oninput="updateSport()">
                    </div>
                    
                    <div class="flex gap-4">
                        <div class="w-1/2 p-3 bg-gray-50 rounded-xl text-center">
                            <label class="text-[10px] font-bold text-gray-400 uppercase block mb-2">Ritmo (min/km)</label>
                            <input type="range" min="3" max="8" step="0.1" value="5.5" id="range-run-pace" oninput="updateSport()">
                            <div class="text-sm font-black text-slate-700 mt-1"><span id="val-run-pace">5:30</span></div>
                        </div>
                        <div class="w-1/2 p-3 bg-gray-50 rounded-xl text-center">
                            <label class="text-[10px] font-bold text-gray-400 uppercase block mb-2">Intensidad</label>
                            <input type="range" min="1" max="3" step="1" value="2" id="range-run-int" oninput="updateSport()">
                            <div class="text-sm font-black text-slate-700 mt-1" id="val-run-int-text">Normal</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-6 border-l-4 border-indigo-500 mb-24">
                <div class="flex items-center gap-4 mb-6">
                    <div class="bg-indigo-100 p-3 rounded-xl text-indigo-600 shadow-sm"><i class="fas fa-bicycle text-2xl"></i></div>
                    <div>
                        <h3 class="font-bold text-slate-700 text-lg">Ciclismo</h3>
                        <p class="text-[10px] text-gray-400 font-bold uppercase">Resistencia / Pierna</p>
                    </div>
                </div>
                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between text-xs font-bold text-gray-500 mb-2">
                            <span>Distancia</span>
                            <span class="text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded"><span id="val-bike-km">0</span> km</span>
                        </div>
                        <input type="range" min="0" max="100" step="1" value="0" id="range-bike-km" oninput="updateSport()">
                    </div>
                </div>
            </div>
        </div>

        <div id="registro" class="page-section">
            <h2 class="text-2xl font-bold mb-6 text-slate-800 tracking-tight">Historial de Informes</h2>
            <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 mb-6">
                <p class="text-xs text-yellow-700"><i class="fas fa-mobile-alt mr-1"></i> <b>Nota:</b> Si la guardas por error, usa el bot√≥n de "flecha" para devolverla al d√≠a de hoy.</p>
            </div>
            <div id="historyList" class="space-y-4 pb-24"></div>
        </div>

    </main>

    <div id="info-modal" class="fixed inset-0 z-[60] bg-slate-900/60 backdrop-blur-sm modal-overlay items-center justify-center p-5" onclick="closeModal(event)">
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl modal-content overflow-hidden" onclick="event.stopPropagation()">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-black text-slate-800">Detalles</h3>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-white text-gray-400 hover:text-red-500 shadow-sm flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            <div id="modal-body" class="p-6 max-h-[70vh] overflow-y-auto space-y-4">
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 w-full bg-white/95 backdrop-blur-lg border-t border-gray-100 py-3 px-2 flex justify-between items-center z-50 pb-safe-area pb-6">
        <button onclick="navigateTo('inicio')" class="nav-item active flex flex-col items-center w-1/5 group" id="nav-inicio">
            <i class="fas fa-home text-xl mb-1 group-active:scale-90 transition"></i><span class="text-[10px] font-bold">Inicio</span>
        </button>
        <button onclick="navigateTo('comida')" class="nav-item flex flex-col items-center w-1/5 group" id="nav-comida">
            <i class="fas fa-apple-whole text-xl mb-1 group-active:scale-90 transition"></i><span class="text-[10px] font-bold">Dieta</span>
        </button>
        <button onclick="navigateTo('agua')" class="nav-item flex flex-col items-center w-1/5 group" id="nav-agua">
            <i class="fas fa-droplet text-xl mb-1 group-active:scale-90 transition"></i><span class="text-[10px] font-bold">Agua</span>
        </button>
        <button onclick="navigateTo('estudio')" class="nav-item flex flex-col items-center w-1/5 group" id="nav-estudio">
            <i class="fas fa-book-open text-xl mb-1 group-active:scale-90 transition"></i><span class="text-[10px] font-bold">Estudio</span>
        </button>
        <button onclick="navigateTo('deporte')" class="nav-item flex flex-col items-center w-1/5 group" id="nav-deporte">
            <i class="fas fa-dumbbell text-xl mb-1 group-active:scale-90 transition"></i><span class="text-[10px] font-bold">Gym</span>
        </button>
    </nav>

    <script>
        // --- BASE DE DATOS COMPLETA ---
        const foodDatabase = {
            'Desayuno': [
                { name: 'Cafe con leche', cal: 68.8, prot: 8, fat: 0.8, sat: 0.48, carb: 12, weight: 200 },
                { name: 'Cafe con leche + proteina', cal: 127.8, prot: 19.5, fat: 1.7, sat: 1.03, carb: 15, weight: 200 },
                { name: '1 panecillo', cal: 27.03, prot: 3.75, fat: 0.89, sat: 0.21, carb: 5, weight: 50 },
                { name: 'Tortilla (3 claras + 1 yema)', cal: 145, prot: 16, fat: 5, sat: 1.5, carb: 1, weight: 150 },
                { name: 'Avena con Leche', cal: 220, prot: 10, fat: 4, sat: 1, carb: 35, weight: 250 }
            ],
            'Almuerzo': [
                { name: 'Bocadillo de jam√≥n', cal: 400, prot: 25, fat: 15, sat: 5, carb: 45, weight: 150 },
                { name: 'Fruta gen√©rica', cal: 200, prot: 10, fat: 8, sat: 3, carb: 25, weight: 100 }
            ],
            'Comida': [
                { name: 'Cafe con leche', cal: 68.8, prot: 8, fat: 0.8, sat: 0.48, carb: 12, weight: 200 },
                { name: 'Cafe con leche + proteina', cal: 127.8, prot: 19.5, fat: 1.7, sat: 1.03, carb: 15, weight: 200 }
            ],
            'Merienda': [
                { name: 'Frutos secos', cal: 200, prot: 10, fat: 5, sat: 2, carb: 20, weight: 50 },
                { name: 'Yogur natural', cal: 150, prot: 8, fat: 3, sat: 1, carb: 18, weight: 125 }
            ],
            'Cena': [
                { name: '1 panecillo', cal: 27.03, prot: 3.75, fat: 0.89, sat: 0.21, carb: 5, weight: 50 }
            ],
            'Frutas': [
                { name: 'Manzana', cal: 52, prot: 0.3, fat: 0.2, sat: 0.03, carb: 13.8, weight: 150 },
                { name: 'Pl√°tano', cal: 89, prot: 1.1, fat: 0.3, sat: 0.11, carb: 22.8, weight: 120 },
                { name: 'Fresa', cal: 32, prot: 0.7, fat: 0.3, sat: 0.02, carb: 7.7, weight: 50 },
                { name: 'Sand√≠a', cal: 30, prot: 0.6, fat: 0.2, sat: 0.02, carb: 7.6, weight: 200 },
                { name: 'Mel√≥n', cal: 34, prot: 0.8, fat: 0.2, sat: 0.05, carb: 8.2, weight: 150 },
                { name: 'Uvas', cal: 69, prot: 0.7, fat: 0.2, sat: 0.07, carb: 18.1, weight: 100 },
                { name: 'Pera', cal: 57, prot: 0.4, fat: 0.1, sat: 0.02, carb: 15.2, weight: 170 },
                { name: 'Pi√±a', cal: 50, prot: 0.5, fat: 0.1, sat: 0.01, carb: 13.1, weight: 200 },
                { name: 'Kiwi', cal: 61, prot: 1.1, fat: 0.5, sat: 0.03, carb: 14.7, weight: 75 },
                { name: 'Mango', cal: 60, prot: 0.8, fat: 0.4, sat: 0.09, carb: 15, weight: 200 },
                { name: 'Naranja', cal: 47, prot: 0.9, fat: 0.1, sat: 0.02, carb: 11.8, weight: 150 },
                { name: 'Lim√≥n', cal: 29, prot: 1.1, fat: 0.3, sat: 0.04, carb: 9.3, weight: 100 },
                { name: 'Cereza', cal: 63, prot: 1.1, fat: 0.2, sat: 0.04, carb: 16, weight: 50 },
                { name: 'Melocot√≥n', cal: 39, prot: 0.9, fat: 0.3, sat: 0.02, carb: 9.5, weight: 150 },
                { name: 'Albaricoque', cal: 48, prot: 1.4, fat: 0.4, sat: 0.03, carb: 11.1, weight: 60 },
                { name: 'Granada', cal: 83, prot: 1.7, fat: 1.2, sat: 0.12, carb: 18.7, weight: 200 },
                { name: 'Papaya', cal: 43, prot: 0.5, fat: 0.3, sat: 0.08, carb: 11, weight: 200 },
                { name: 'Higo', cal: 74, prot: 0.8, fat: 0.3, sat: 0.06, carb: 19.2, weight: 50 },
                { name: 'Ciruela', cal: 46, prot: 0.7, fat: 0.3, sat: 0.02, carb: 11.4, weight: 60 }
            ],
            'Verduras': [
                { name: 'Tomate', cal: 18, prot: 0.9, fat: 0.2, sat: 0.03, carb: 3.9, weight: 120 },
                { name: 'Lechuga', cal: 15, prot: 1.4, fat: 0.2, sat: 0.03, carb: 2.9, weight: 50 },
                { name: 'Espinaca', cal: 23, prot: 2.9, fat: 0.4, sat: 0.06, carb: 3.6, weight: 30 },
                { name: 'Br√≥coli', cal: 34, prot: 2.8, fat: 0.4, sat: 0.04, carb: 6.6, weight: 150 },
                { name: 'Calabac√≠n', cal: 17, prot: 1.2, fat: 0.3, sat: 0.05, carb: 3.1, weight: 200 },
                { name: 'Zanahoria', cal: 41, prot: 0.9, fat: 0.2, sat: 0.03, carb: 9.6, weight: 75 },
                { name: 'Pepino', cal: 16, prot: 0.7, fat: 0.1, sat: 0.02, carb: 3.6, weight: 200 },
                { name: 'Cebolla', cal: 40, prot: 1.1, fat: 0.1, sat: 0.02, carb: 9.3, weight: 100 },
                { name: 'Ajo', cal: 149, prot: 6.4, fat: 0.5, sat: 0.09, carb: 33.1, weight: 5 },
                { name: 'Pimiento rojo', cal: 31, prot: 1, fat: 0.3, sat: 0.03, carb: 6, weight: 120 },
                { name: 'Pimiento verde', cal: 20, prot: 0.9, fat: 0.2, sat: 0.03, carb: 4.6, weight: 100 },
                { name: 'Berenjena', cal: 25, prot: 1, fat: 0.2, sat: 0.03, carb: 5.9, weight: 200 },
                { name: 'Alcachofa', cal: 47, prot: 3.3, fat: 0.2, sat: 0.04, carb: 10.5, weight: 120 },
                { name: 'Coliflor', cal: 25, prot: 1.9, fat: 0.3, sat: 0.05, carb: 5, weight: 100 },
                { name: 'Apio', cal: 16, prot: 0.7, fat: 0.2, sat: 0.04, carb: 3, weight: 40 },
                { name: 'Remolacha', cal: 43, prot: 1.6, fat: 0.2, sat: 0.03, carb: 9.6, weight: 100 },
                { name: 'Esp√°rrago', cal: 20, prot: 2.2, fat: 0.1, sat: 0.03, carb: 3.9, weight: 50 },
                { name: 'Col de Bruselas', cal: 43, prot: 3.4, fat: 0.3, sat: 0.06, carb: 8.9, weight: 20 }
            ],
            'Frutos Secos': [
                { name: 'Almendras', cal: 579, prot: 21.2, fat: 49.9, sat: 3.8, carb: 21.6, weight: 30 },
                { name: 'Nueces', cal: 654, prot: 15.2, fat: 65.2, sat: 6.1, carb: 13.7, weight: 30 },
                { name: 'Avellanas', cal: 628, prot: 15, fat: 60.8, sat: 4.5, carb: 16.7, weight: 30 },
                { name: 'Pistachos', cal: 562, prot: 20.6, fat: 45.4, sat: 5.6, carb: 27.2, weight: 30 },
                { name: 'Anacardos', cal: 553, prot: 18.2, fat: 43.9, sat: 7.8, carb: 30.2, weight: 30 },
                { name: 'Cacahuetes', cal: 567, prot: 25.8, fat: 49.2, sat: 6.8, carb: 16.1, weight: 30 },
                { name: 'Nueces de Macadamia', cal: 718, prot: 7.9, fat: 75.8, sat: 12.1, carb: 13.8, weight: 30 },
                { name: 'Nueces de Brasil', cal: 659, prot: 14.3, fat: 67.1, sat: 16.1, carb: 11.7, weight: 30 },
                { name: 'Pi√±ones', cal: 673, prot: 13.7, fat: 68.4, sat: 4.9, carb: 13.1, weight: 30 }
            ],
            'Carnes': [
                { name: 'Pechuga de pollo', cal: 165, prot: 31, fat: 3.6, sat: 1, carb: 0, weight: 150 },
                { name: 'Muslo de pollo', cal: 209, prot: 26, fat: 10.9, sat: 3, carb: 0, weight: 150 },
                { name: 'Pollo entero', cal: 190, prot: 28, fat: 8, sat: 2.3, carb: 0, weight: 1000 },
                { name: 'Carne de ternera', cal: 250, prot: 26, fat: 17, sat: 7, carb: 0, weight: 150 },
                { name: 'Carne de ternera magra', cal: 220, prot: 26, fat: 12, sat: 5, carb: 0, weight: 150 },
                { name: 'Carne de cerdo', cal: 242, prot: 21, fat: 17, sat: 7, carb: 0, weight: 150 },
                { name: 'Lomo de cerdo', cal: 211, prot: 23, fat: 12, sat: 4.5, carb: 0, weight: 150 },
                { name: 'Entrecot lomo iberico marinado', cal: 137, prot: 18, fat: 7, sat: 2.5, carb: 0.5, weight: 70 },
                { name: 'Flamenquines', cal: 167, prot: 11.1, fat: 5.3, sat: 1.9, carb: 18.5, weight: 45 },
                { name: 'Costillas de cerdo', cal: 291, prot: 25, fat: 21, sat: 8, carb: 0, weight: 150 },
                { name: 'Cordero', cal: 294, prot: 25, fat: 21, sat: 9, carb: 0, weight: 150 },
                { name: 'Cordero magro', cal: 236, prot: 26, fat: 14, sat: 6, carb: 0, weight: 150 },
                { name: 'Pavo chuletas', cal: 85, prot: 16.4, fat: 1.8, sat: 0.6, carb: 0.8, weight: 120 },
                { name: 'Pavo molido', cal: 150, prot: 26, fat: 5, sat: 1, carb: 0, weight: 150 },
                { name: 'Conejo', cal: 173, prot: 32, fat: 4, sat: 1, carb: 0, weight: 150 },
                { name: 'Salchich√≥n', cal: 460, prot: 27, fat: 38, sat: 14, carb: 1, weight: 50 },
                { name: 'Jam√≥n serrano', cal: 247.8, prot: 33.5, fat: 12.2, sat: 4.6, carb: 1, weight: 100 },
                { name: 'Jam√≥n cocido extra', cal: 98, prot: 19, fat: 2.5, sat: 1, carb: 0.5, weight: 15 },
                { name: 'Salchichas', cal: 222, prot: 14, fat: 18, sat: 6, carb: 1, weight: 31 },
                { name: 'Pelota', cal: 225, prot: 20, fat: 16, sat: 6, carb: 4, weight: 100 },
                { name: 'Longaniza', cal: 245, prot: 15.9, fat: 19.4, sat: 7.8, carb: 1.7, weight: 30 }
            ],
            'Pescados': [
                { name: 'Merluza', cal: 94, prot: 20, fat: 1, sat: 0.2, carb: 0, weight: 300 },
                { name: 'Dorada', cal: 96, prot: 18, fat: 2.5, sat: 0.6, carb: 0, weight: 500 },
                { name: 'Lubina', cal: 98, prot: 19, fat: 2, sat: 0.4, carb: 0, weight: 300 },
                { name: 'Salm√≥n (salvaje)', cal: 180, prot: 20, fat: 10, sat: 2, carb: 0, weight: 200 },
                { name: 'Sardinas', cal: 118, prot: 20, fat: 5, sat: 1.2, carb: 0, weight: 100 },
                { name: 'Gallineta n√≥rdica', cal: 79, prot: 20, fat: 1, sat: 0.2, carb: 0, weight: 380 },
                { name: 'Trucha', cal: 103, prot: 20, fat: 3, sat: 0.6, carb: 0, weight: 250 },
                { name: 'Pez espada', cal: 117, prot: 20, fat: 4, sat: 1, carb: 0, weight: 200 },
                { name: 'Pulpo', cal: 81, prot: 15, fat: 1, sat: 0.2, carb: 2, weight: 100 },
                { name: 'Mejillones', cal: 171, prot: 24, fat: 4, sat: 0.8, carb: 7, weight: 100 }
            ],
            'Bebidas': [
                { name: 'Agua mineral', cal: 0, prot: 0, fat: 0, sat: 0, carb: 0, weight: 250 },
                { name: 'Agua con gas', cal: 0, prot: 0, fat: 0, sat: 0, carb: 0, weight: 250 },
                { name: 'Batido de chocolate', cal: 110, prot: 3, fat: 3.5, sat: 2, carb: 17, weight: 250 },
                { name: 'Limonada casera', cal: 50, prot: 0, fat: 0, sat: 0, carb: 12, weight: 250 },
                { name: 'T√© helado', cal: 40, prot: 0, fat: 0, sat: 0, carb: 10, weight: 250 },
                { name: 'Bebida de soja', cal: 33, prot: 3, fat: 1.8, sat: 0.2, carb: 1, weight: 250 },
                { name: 'Cerveza rubia', cal: 43, prot: 0.5, fat: 0, sat: 0, carb: 3.6, weight: 330 },
                { name: 'Cerveza sin alcohol', cal: 20, prot: 0.2, fat: 0, sat: 0, carb: 4.5, weight: 330 },
                { name: 'Vino tinto', cal: 85, prot: 0.1, fat: 0, sat: 0, carb: 2.6, weight: 125 },
                { name: 'Vino blanco', cal: 82, prot: 0.1, fat: 0, sat: 0, carb: 2.3, weight: 125 }
            ],
            'Burger King': [
                { name: 'Whopper', cal: 657, prot: 28, fat: 37, sat: 10, carb: 49, weight: 300 },
                { name: 'Chicken Royale', cal: 500, prot: 22, fat: 24, sat: 3, carb: 48, weight: 200 },
                { name: 'Patatas fritas peque√±as', cal: 230, prot: 3, fat: 11, sat: 1, carb: 32, weight: 90 },
                { name: 'Aros de cebolla', cal: 270, prot: 2, fat: 18, sat: 2, carb: 25, weight: 100 },
                { name: 'McFlurry Oreo', cal: 400, prot: 5, fat: 22, sat: 13, carb: 42, weight: 200 }
            ],
            'Panes': [
                { name: 'Pan blanco', cal: 265, prot: 8.5, fat: 1.2, sat: 0.2, carb: 55, weight: 125 },
                { name: 'Pan integral carrefour', cal: 221, prot: 9.1, fat: 1.7, sat: 0.9, carb: 45, weight: 125 },
                { name: 'Pan de centeno', cal: 259, prot: 8.5, fat: 3.3, sat: 0.4, carb: 48.3, weight: 30 },
                { name: 'Pan de molde', cal: 265, prot: 8, fat: 3.5, sat: 0.8, carb: 49, weight: 25 },
                { name: 'Pan tostado', cal: 350, prot: 10, fat: 5, sat: 1, carb: 60, weight: 20 }
            ],
            'Cereales Grano': [
                { name: 'Arroz blanco (cocido)', cal: 365, prot: 7.1, fat: 0.7, sat: 0.2, carb: 80, weight: 180 },
                { name: 'Arroz integral (cocido)', cal: 370, prot: 7.9, fat: 2.7, sat: 0.5, carb: 77, weight: 180 },
                { name: 'Quinoa (cocida)', cal: 368, prot: 14, fat: 6, sat: 0.7, carb: 64, weight: 185 },
                { name: 'Avena (cruda)', cal: 389, prot: 17, fat: 7, sat: 1.2, carb: 66, weight: 40 }
            ],
            'Pastas': [
                { name: 'Espaguetis (cocidos)', cal: 371, prot: 13, fat: 1.5, sat: 0.3, carb: 75, weight: 140 },
                { name: 'Macarrones (cocidos)', cal: 371, prot: 13, fat: 1.5, sat: 0.3, carb: 75, weight: 140 },
                { name: 'Fideos de arroz (cocidos)', cal: 109, prot: 0.9, fat: 0.2, sat: 0.02, carb: 24.9, weight: 180 }
            ],
            'Leches': [
                { name: 'Leche entera', cal: 61, prot: 3.1, fat: 3.3, sat: 2.1, carb: 4.7, weight: 200 },
                { name: 'Leche semidesnatada (Central Lechera Asturiana)', cal: 45, prot: 3.15, fat: 1.55, sat: 1, carb: 4.65, weight: 200 },
                { name: 'Leche desnatada Puleva proteina', cal: 43, prot: 5, fat: 0.5, sat: 0.3, carb: 4.8, weight: 200 }
            ],
            'Quesos': [
                { name: 'Queso fresco', cal: 145, prot: 11, fat: 10, sat: 6.5, carb: 2, weight: 100 },
                { name: 'Queso semicurado', cal: 421, prot: 25, fat: 35, sat: 25, carb: 1.6, weight: 20 },
                { name: 'Queso curado', cal: 452, prot: 30, fat: 37, sat: 24, carb: 1, weight: 30 },
                { name: 'Queso cauda viejo', cal: 325, prot: 29.4, fat: 23, sat: 16, carb: 0, weight: 4 },
                { name: 'Queso havarti', cal: 418, prot: 18.9, fat: 38, sat: 24.2, carb: 0.1, weight: 32 }
            ],
            'Yogures': [
                { name: 'Yogur natural entero', cal: 61, prot: 3.5, fat: 3, sat: 2, carb: 4.7, weight: 125 },
                { name: 'Yogur natural desnatado', cal: 36, prot: 4.3, fat: 0.1, sat: 0.1, carb: 5, weight: 125 },
                { name: 'Yogur griego', cal: 115, prot: 9, fat: 5, sat: 3.5, carb: 3.5, weight: 125 }
            ],
            'Legumbres Secas': [
                { name: 'Lentejas (crudas)', cal: 353, prot: 25, fat: 1.1, sat: 0.2, carb: 60, weight: 10 },
                { name: 'Garbanzos (crudos)', cal: 364, prot: 19, fat: 6, sat: 0.6, carb: 61, weight: 12 },
                { name: 'Jud√≠as blancas (crudas)', cal: 335, prot: 21, fat: 1.6, sat: 0.3, carb: 60, weight: 10 }
            ],
            'Legumbres Cocidas': [
                { name: 'Lentejas cocidas', cal: 116, prot: 9, fat: 0.4, sat: 0.1, carb: 20, weight: 200 },
                { name: 'Tortitas de arroz', cal: 389, prot: 8, fat: 2.1, sat: 0.4, carb: 83, weight: 7 },
                { name: 'Garbanzos cocidos', cal: 164, prot: 9, fat: 2.6, sat: 0.3, carb: 27, weight: 200 }
            ],
            'Huevos': [
                { name: 'Huevo de gallina (entero)', cal: 143, prot: 12.6, fat: 10, sat: 3.1, carb: 0.7, weight: 60 },
                { name: 'Clara de huevo', cal: 52, prot: 11, fat: 0.2, sat: 0, carb: 0.7, weight: 33 },
                { name: 'Yema de huevo', cal: 322, prot: 16, fat: 27, sat: 9.6, carb: 3.6, weight: 17 },
                { name: 'Huevo cocido', cal: 155, prot: 12.6, fat: 10.6, sat: 3.3, carb: 1.1, weight: 50 },
                { name: 'Huevo frito', cal: 196, prot: 13, fat: 15, sat: 4.2, carb: 1.1, weight: 60 }
            ],
            'Bolleria': [
                { name: 'Croissant', cal: 406, prot: 8.2, fat: 21, sat: 12, carb: 46, weight: 60 },
                { name: 'Donut', cal: 452, prot: 5.3, fat: 25, sat: 12, carb: 51, weight: 70 }
            ],
            'Dulces': [
                { name: 'Chocolate negro', cal: 546, prot: 4.9, fat: 31, sat: 19, carb: 61, weight: 30 },
                { name: 'Galletas tipo Mar√≠a', cal: 409, prot: 6.8, fat: 8.1, sat: 2.5, carb: 82.3, weight: 6 }
            ],
            'Hamburguesas': [
                { name: 'Big Mac', cal: 550, prot: 25, fat: 30, sat: 10, carb: 45, weight: 200 },
                { name: 'McChicken', cal: 420, prot: 23, fat: 20, sat: 3, carb: 35, weight: 180 }
            ],
            'Acompa√±amientos': [
                { name: 'Patatas fritas medianas', cal: 340, prot: 3, fat: 17, sat: 1, carb: 44, weight: 115 }
            ],
            'Salsas': [
                { name: 'Ketchup', cal: 60, prot: 1.3, fat: 0.5, sat: 0.1, carb: 13, weight: 100 },
                { name: 'Salsa de Yogur', cal: 120, prot: 3, fat: 10, sat: 2, carb: 5, weight: 100 },
                { name: 'Salsa de Curry', cal: 150, prot: 2, fat: 12, sat: 3, carb: 10, weight: 100 },
                { name: 'Salsa de Mostaza', cal: 133, prot: 7, fat: 9, sat: 0.5, carb: 5, weight: 100 },
                { name: 'Salsa de Queso', cal: 250, prot: 10, fat: 22, sat: 14, carb: 5, weight: 100 },
                { name: 'Salsa de Ajo', cal: 180, prot: 2, fat: 16, sat: 2.5, carb: 6, weight: 100 },
                { name: 'Salsa de Chile', cal: 40, prot: 1, fat: 0.5, sat: 0.1, carb: 10, weight: 100 },
                { name: 'Salsa de Miel y Mostaza', cal: 200, prot: 2, fat: 12, sat: 1.5, carb: 20, weight: 100 },
                { name: 'Salsa de Soja Dulce', cal: 100, prot: 5, fat: 0.5, sat: 0.1, carb: 20, weight: 100 }
            ]
        };

        const INITIAL_STATE = {
            wakeTime: '', sleepHours: 0, sleepQuality: 0,
            water: 0,
            studySessions: [],
            mobileHours: 0, 
            steps: 0, 
            standingHours: 0, 
            runKm: 0, runPace: 5.5, runInt: 2,
            bikeKm: 0, bikeInt: 2,
            foodLog: []
        };

        let todayData = JSON.parse(JSON.stringify(INITIAL_STATE));
        let BASE_GOALS = { cals: 2400, prot: 140, fat: 65, sat: 20, carbs: 300, water: 2200 };
        let currentGoals = { ...BASE_GOALS };
        let currentSeason = 'Winter';
        let history = JSON.parse(localStorage.getItem('fitTrackerHistory_MD')) || [];
        let stressDetails = []; 
        let waterDetails = [];
        let nutritionAdvice = "";
        let studyAdvice = "";

        window.onload = function() {
            detectSeason();
            loadDay();
            renderFoodCategories();
            updateDay();
            updateHistoryUI();
        };

        function detectSeason() {
            const m = new Date().getMonth();
            const el = document.getElementById('season-indicator');
            if (m >= 5 && m <= 8) { currentSeason = 'Summer'; el.innerText = 'Modo Verano ‚òÄÔ∏è'; }
            else if (m >= 9 && m <= 10) { currentSeason = 'Autumn'; el.innerText = 'Modo Oto√±o üçÇ'; }
            else if (m >= 2 && m <= 4) { currentSeason = 'Spring'; el.innerText = 'Modo Primavera üå∏'; }
            else { currentSeason = 'Winter'; el.innerText = 'Modo Invierno ‚ùÑÔ∏è'; }
        }

        function updateDay() {
            const wakeEl = document.getElementById('wakeTime');
            if(wakeEl) todayData.wakeTime = wakeEl.value;
            const sleepHEl = document.getElementById('sleepHours');
            if(sleepHEl) todayData.sleepHours = Number(sleepHEl.value);
            const sleepQEl = document.getElementById('sleepQuality');
            if(sleepQEl) todayData.sleepQuality = Number(sleepQEl.value);

            calculateDynamicGoals();
            calculateStressBar();
            saveDay();
            updateUI();
        }

        function calculateDynamicGoals() {
            let g = { ...BASE_GOALS };
            waterDetails = [];
            nutritionAdvice = "";
            studyAdvice = "";
            
            waterDetails.push({ txt: "Base (18 a√±os)", val: "+2200ml" });

            if (currentSeason === 'Summer') {
                g.water += 400;
                waterDetails.push({ txt: "Calor (Verano)", val: "+400ml" });
            }

            if (todayData.steps > 0) {
                const stepCals = Math.round(todayData.steps * 0.04); 
                g.cals += stepCals;
                const stepWater = Math.round(todayData.steps * 0.05);
                g.water += stepWater;
                waterDetails.push({ txt: `Pasos (${todayData.steps})`, val: `+${stepWater}ml` });
            }

            if (todayData.standingHours > 4) {
                 g.cals += (todayData.standingHours * 10);
                 g.water += (todayData.standingHours * 50);
                 waterDetails.push({ txt: `De pie (${todayData.standingHours}h)`, val: `+${Math.round(todayData.standingHours * 50)}ml` });
            }

            let sportLoad = todayData.runKm + (todayData.bikeKm * 0.4);
            if (sportLoad > 10 || todayData.steps > 15000) {
                nutritionAdvice += "<li>üèÉ‚Äç‚ôÇÔ∏è <b>Carga Alta:</b> Dep√≥sitos de gluc√≥geno vac√≠os. Cena carbohidratos (arroz/pasta) para recuperar.</li>";
                g.cals += 400; g.carbs += 60;
            } else if (sportLoad > 0 || todayData.steps > 8000) {
                nutritionAdvice += "<li>üëå <b>Actividad Moderada:</b> Mant√©n el equilibrio proteico.</li>";
            } else {
                nutritionAdvice += "<li>üí§ <b>D√≠a Sedentario:</b> Controla los carbohidratos, prioriza verduras y prote√≠nas.</li>";
            }

            if (todayData.runKm > 0) {
                let intensityFactor = 1;
                if(todayData.runPace < 5) intensityFactor = 1.3;
                const runWater = todayData.runKm * (currentSeason === 'Summer' ? 200 : 150);
                g.water += runWater;
                waterDetails.push({ txt: `Running (${todayData.runKm}km)`, val: `+${Math.round(runWater)}ml` });
            }

            let totalStudy = todayData.studySessions.reduce((a,b)=>a+b.hours,0);
            if (totalStudy > 6) {
                studyAdvice = "‚ö†Ô∏è <b>Alerta Cortisol:</b> Llevas mucha carga mental. El cerebro necesita glucosa y descanso. <br>üëâ Recomendaci√≥n: Come nueces (Omega 3) o un pl√°tano ahora. Duerme 8h hoy s√≠ o s√≠.";
                const studyWater = totalStudy * 80;
                g.water += studyWater;
                waterDetails.push({ txt: `Estudio Intenso`, val: `+${Math.round(studyWater)}ml` });
            } else if (totalStudy > 2) {
                studyAdvice = "‚úÖ <b>Buen ritmo:</b> Recuerda hidratarte cada hora. El agua mejora la concentraci√≥n un 20%.";
                g.water += totalStudy * 50;
            } else {
                studyAdvice = "üí° Sin fatiga mental aparente.";
            }

            currentGoals = g;
        }

        function calculateStressBar() {
            let stress = 0;
            stressDetails = [];

            if (todayData.sleepHours > 0) {
                let sleepScore = 0;
                if (todayData.sleepQuality < 60) {
                    sleepScore += 30; 
                    stressDetails.push({ text: "Mala Calidad Sue√±o", val: "+30%", type: 'bad' });
                } else if (todayData.sleepQuality > 80) {
                    sleepScore -= 10;
                    stressDetails.push({ text: "Sue√±o Reparador", val: "-10%", type: 'good' });
                }
                if (todayData.sleepHours < 7) {
                    const debt = (7 - todayData.sleepHours) * 15;
                    sleepScore += debt;
                    stressDetails.push({ text: "Deuda Sue√±o", val: `+${Math.round(debt)}%`, type: 'bad' });
                }
                stress += sleepScore;
            }

            let totalStudy = todayData.studySessions.reduce((a,b) => a + (b.hours * (b.focus === 1 ? 4 : (b.focus === 2 ? 6 : 9))), 0);
            
            if (todayData.mobileHours > 2) {
                const mobileStress = (todayData.mobileHours - 2) * 5; 
                stress += mobileStress;
                stressDetails.push({ text: `Uso M√≥vil (${todayData.mobileHours}h)`, val: `+${Math.round(mobileStress)}%`, type: 'bad' });
            }

            if (totalStudy > 50) { 
                stressDetails.push({ text: "Sobrecarga Cognitiva", val: "ALTO", type: 'bad' });
                stress += 20;
            } else if (totalStudy > 0) {
                stressDetails.push({ text: `Carga Estudio`, val: `+${Math.round(totalStudy/2)}%`, type: 'neutral' });
                stress += (totalStudy/3);
            }

            let physLoad = 0;
            if (todayData.steps < 4000) {
                stress += 10;
                stressDetails.push({ text: "Sedentarismo", val: "+10%", type: 'bad' });
            } else if (todayData.steps > 15000) {
                physLoad += 15;
                stressDetails.push({ text: "Carga Pasos Alta", val: "+15%", type: 'neutral' });
            } else if (todayData.steps >= 8000 && todayData.steps <= 12000) {
                stress -= 5;
                stressDetails.push({ text: "Actividad √ìptima", val: "-5%", type: 'good' });
            }

            if (todayData.standingHours > 6) {
                physLoad += (todayData.standingHours - 6) * 3;
                stressDetails.push({ text: "Fatiga Postural", val: `+${Math.round((todayData.standingHours - 6) * 3)}%`, type: 'bad' });
            }

            if (todayData.runKm > 0) {
                let runFactor = 4; 
                if (todayData.runInt === 3) runFactor = 5;
                physLoad += todayData.runKm * runFactor;
                stressDetails.push({ text: `Running ${todayData.runKm}km`, val: `+${Math.round(todayData.runKm * runFactor)}%`, type: 'neutral' });
            }
            stress += physLoad;

            const waterP = (todayData.water / currentGoals.water);
            if (waterP >= 0.9) {
                stress -= 5;
                stressDetails.push({ text: "Hidrataci√≥n", val: "-5%", type: 'good' });
            }

            stress = Math.round(stress);
            if (stress < 0) stress = 0;
            if (stress > 100) stress = 100;

            const bar = document.getElementById('stress-bar');
            const txt = document.getElementById('stress-score-num');
            const miniMsg = document.getElementById('stress-msg-mini');
            const icon = document.getElementById('stress-icon');

            bar.style.width = stress + '%';
            txt.innerText = stress + '%';
            
            if (stress < 40) {
                bar.className = 'bg-green-500 h-full rounded-full transition-all duration-700';
                txt.className = 'text-2xl font-black text-green-500 block';
                miniMsg.innerText = "√ìptimo";
                icon.className = "fas fa-battery-full text-green-300 text-xl";
            } else if (stress < 85) {
                bar.className = 'bg-yellow-400 h-full rounded-full transition-all duration-700';
                txt.className = 'text-2xl font-black text-yellow-500 block';
                miniMsg.innerText = "Cargado";
                icon.className = "fas fa-battery-half text-yellow-300 text-xl";
            } else {
                bar.className = 'bg-red-500 h-full rounded-full transition-all duration-700';
                txt.className = 'text-2xl font-black text-red-500 block';
                miniMsg.innerText = "SOBRECARGA";
                icon.className = "fas fa-battery-empty text-red-400 text-xl animate-pulse";
            }
        }

        function updateStudy() {
            todayData.mobileHours = parseFloat(document.getElementById('range-mobile').value);
            document.getElementById('val-mobile').innerText = todayData.mobileHours;
            updateDay();
        }

        function addStudySession() {
            const hInput = document.getElementById('session-hours');
            const fInput = document.getElementById('session-focus');
            const hours = parseFloat(hInput.value);
            const focus = parseInt(fInput.value);

            if (!hours || hours <= 0) { Swal.fire('Error', 'Indica las horas', 'error'); return; }
            todayData.studySessions.push({ hours, focus, id: Date.now() });
            hInput.value = '';
            updateDay();
            Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 }).fire({ icon: 'success', title: 'A√±adido' });
        }

        function removeStudySession(index) { todayData.studySessions.splice(index, 1); updateDay(); }

        function renderStudySessions() {
            const list = document.getElementById('studySessionsList');
            const totalDisplay = document.getElementById('total-study-hours-display');
            let total = 0;
            const focusLabels = {1: 'Bajo', 2: 'Medio', 3: 'Deep Work'};
            const focusColors = {1: 'text-gray-400', 2: 'text-blue-500', 3: 'text-purple-600 font-black'};

            if (todayData.studySessions.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-300 text-xs italic py-4">No hay sesiones registradas hoy.</p>';
                totalDisplay.innerText = "0 horas";
                document.getElementById('home-study').innerText = "0";
                document.getElementById('mini-bar-study').style.width = "0%";
                return;
            }

            list.innerHTML = todayData.studySessions.map((s, i) => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <div>
                        <div class="font-bold text-slate-700 text-sm">${s.hours} horas</div>
                        <div class="text-[10px] uppercase ${focusColors[s.focus]}">${focusLabels[s.focus]}</div>
                    </div>
                    <button onclick="removeStudySession(${i})" class="w-6 h-6 rounded-full bg-white text-red-300 hover:text-red-500 flex items-center justify-center shadow-sm"><i class="fas fa-times text-xs"></i></button>
                </div>
            `).join('');

            todayData.studySessions.forEach(s => total += s.hours);
            totalDisplay.innerText = total + " horas";
            document.getElementById('home-study').innerText = total;
            document.getElementById('mini-bar-study').style.width = Math.min((total/10)*100, 100) + '%';
        }

        function updateUI() {
            renderStudySessions();

            document.getElementById('range-mobile').value = todayData.mobileHours;
            document.getElementById('val-mobile').innerText = todayData.mobileHours;
            document.getElementById('home-mobile').innerText = `${todayData.mobileHours}h M√≥vil`;

            document.getElementById('range-steps').value = todayData.steps;
            document.getElementById('val-steps').innerText = todayData.steps;
            document.getElementById('home-steps').innerText = todayData.steps;

            document.getElementById('range-standing').value = todayData.standingHours;
            document.getElementById('val-standing').innerText = todayData.standingHours;


            let sum = { cal:0, prot:0, fat:0, carb:0 };
            todayData.foodLog.forEach(f => {
                sum.cal+=f.cal; sum.prot+=f.prot; sum.fat+=f.fat; sum.carb+=f.carb;
            });

            const setBar = (id, val, max) => {
                const p = Math.min((val/max)*100, 100);
                const el = document.getElementById(`bar-${id}`);
                if(el) el.style.width = p+'%';
                document.getElementById(`val-${id}`).innerText = Math.round(val);
                document.getElementById(`goal-${id}`).innerText = Math.round(max);
            };
            setBar('cals', sum.cal, currentGoals.cals);
            setBar('prot', sum.prot, currentGoals.prot);
            setBar('fat', sum.fat, currentGoals.fat);
            setBar('carbs', sum.carb, currentGoals.carbs);
            document.getElementById('total-consumed-kcal').innerText = Math.round(sum.cal) + ' kcal';

            document.getElementById('home-water').innerText = todayData.water;
            document.getElementById('home-water-goal').innerText = Math.round(currentGoals.water);
            document.getElementById('mini-bar-water').style.width = Math.min((todayData.water/currentGoals.water)*100, 100) + '%';
            
            const wp = Math.min(todayData.water / currentGoals.water, 1);
            document.getElementById('water-circle').style.strokeDashoffset = 628 - (wp * 628);
            document.getElementById('water-display-lg').innerText = todayData.water;
            document.getElementById('water-goal-text').innerText = `Meta din√°mica: ${Math.round(currentGoals.water)} ml`;

            document.getElementById('home-sport-km').innerText = todayData.runKm + todayData.bikeKm;
            const sportProgress = Math.min(((todayData.runKm + (todayData.bikeKm*0.4)) / 10) * 100, 100);
            document.getElementById('bar-sport-home').style.width = sportProgress + '%';

            document.getElementById('addedFoodsList').innerHTML = todayData.foodLog.map((f, i) => `
                <div class="flex justify-between items-center text-sm py-3 border-b border-gray-100 last:border-0 bg-white p-3 rounded-xl mb-2 shadow-sm">
                    <div>
                        <div class="text-slate-700 font-bold">${f.name} <span class="text-xs text-gray-400 font-normal">(${f.weight}g)</span></div>
                        <div class="text-[10px] text-gray-400">P: ${Math.round(f.prot)}g | C: ${Math.round(f.carb)}g | G: ${Math.round(f.fat)}g</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-xs text-slate-500 bg-gray-100 px-2 py-1 rounded">${Math.round(f.cal)} kcal</span>
                        <button onclick="removeFood(${i})" class="text-red-300 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-red-50 transition"><i class="fas fa-times"></i></button>
                    </div>
                </div>
            `).join('') || '<p class="text-center text-gray-300 text-xs py-4">No has a√±adido comidas a√∫n.</p>';
        }

        function updateSport() {
            todayData.runKm = parseFloat(document.getElementById('range-run-km').value);
            todayData.runPace = parseFloat(document.getElementById('range-run-pace').value);
            todayData.runInt = parseFloat(document.getElementById('range-run-int').value);
            todayData.bikeKm = parseFloat(document.getElementById('range-bike-km').value);
            todayData.steps = parseInt(document.getElementById('range-steps').value);
            todayData.standingHours = parseFloat(document.getElementById('range-standing').value);
            
            document.getElementById('val-run-km').innerText = todayData.runKm;
            let min = Math.floor(todayData.runPace);
            let sec = Math.round((todayData.runPace - min) * 60);
            document.getElementById('val-run-pace').innerText = `${min}:${sec < 10 ? '0' : ''}${sec}`;
            
            const ints = ['--', 'Suave', 'Normal', 'Alta'];
            document.getElementById('val-run-int-text').innerText = ints[todayData.runInt] || '--';
            document.getElementById('val-bike-km').innerText = todayData.bikeKm;

            updateDay();
        }

        // --- FUNCIONES INTERFAZ ---
        function showDetails(type) {
            const modal = document.getElementById('info-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            
            if(type === 'stress') {
                title.innerText = "Diagn√≥stico Carga (18 a√±os)";
                if(stressDetails.length === 0) {
                    body.innerHTML = '<p class="text-gray-400 text-center italic">Sin datos suficientes.</p>';
                } else {
                    body.innerHTML = `
                        <div class="space-y-3">
                            ${stressDetails.map(d => `
                                <div class="flex justify-between items-center border-b border-gray-100 pb-2">
                                    <span class="font-medium text-slate-700 text-sm">${d.text}</span>
                                    <span class="font-bold ${d.type==='good'?'text-green-500':(d.type==='bad'?'text-red-500':'text-orange-400')}">${d.val}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } else if (type === 'water') {
                title.innerText = "Hidrataci√≥n";
                body.innerHTML = waterDetails.map(d => `
                    <div class="flex justify-between items-center bg-white border border-gray-100 p-3 rounded-xl mb-2">
                        <span class="text-sm text-slate-600">${d.txt}</span>
                        <span class="text-sm font-bold text-blue-500">${d.val}</span>
                    </div>`).join('');
            } else if (type === 'study') {
                title.innerText = "Detalle Cognitivo";
                const focusLabels = {1: 'Bajo', 2: 'Medio', 3: 'Deep Work'};
                let content = `<div class="bg-purple-50 p-4 rounded-2xl border border-purple-100 text-sm text-slate-700 mb-4">${studyAdvice}</div>`;
                content += todayData.studySessions.length ? todayData.studySessions.map(s => `
                    <div class="bg-gray-50 p-3 rounded-xl mb-2 flex justify-between">
                        <span class="font-bold text-slate-700">${s.hours} horas</span>
                        <span class="text-xs text-purple-500 font-bold uppercase">${focusLabels[s.focus]}</span>
                    </div>
                `).join('') : '<p class="text-gray-400 text-center italic">Sin sesiones.</p>';
                body.innerHTML = content;

            } else if (type === 'nutrition') {
                title.innerText = "Control de Dieta";
                body.innerHTML = `
                    <p class="text-xs font-bold text-gray-400 uppercase mb-2">Consejo Recuperaci√≥n</p>
                    <div class="bg-orange-50 p-4 rounded-2xl border border-orange-100 text-sm text-slate-600 mb-4">
                        <ul class="list-disc pl-4 space-y-1">
                            ${nutritionAdvice || "<li>Mant√©n la prote√≠na alta.</li>"}
                        </ul>
                    </div>
                `;
            } else if (type === 'sport') {
                title.innerText = "Detalle Actividad";
                body.innerHTML = `
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-green-50 p-3 rounded-2xl text-center">
                            <i class="fas fa-shoe-prints text-green-500 text-2xl mb-1"></i>
                            <div class="font-bold text-slate-700">${todayData.steps}</div>
                            <div class="text-[10px] text-gray-400">Pasos</div>
                        </div>
                         <div class="bg-orange-50 p-3 rounded-2xl text-center">
                            <i class="fas fa-running text-orange-500 text-2xl mb-1"></i>
                            <div class="font-bold text-slate-700">${todayData.runKm} km</div>
                            <div class="text-[10px] text-gray-400">Running</div>
                        </div>
                    </div>
                `;
            }
            modal.classList.add('open');
        }

        function closeModal(e) {
            if (e && !e.target.classList.contains('modal-overlay')) return;
            document.getElementById('info-modal').classList.remove('open');
        }

        // --- SISTEMA DE RENDERIZADO DE ALIMENTOS (DISE√ëO MEJORADO) ---
        function renderFoodCategories() {
            const container = document.getElementById('foodCategoriesContainer');
            container.innerHTML = '';

            // 1. Tiempos de Comida Principales (ESTILIZADOS)
            const mainMealsConfig = [
                { id: 'Desayuno', icon: 'fa-sun', color: 'yellow' },
                { id: 'Almuerzo', icon: 'fa-bread-slice', color: 'orange' },
                { id: 'Comida', icon: 'fa-utensils', color: 'red' },
                { id: 'Merienda', icon: 'fa-cookie-bite', color: 'pink' },
                { id: 'Cena', icon: 'fa-moon', color: 'indigo' }
            ];

            const mealContainer = document.createElement('div');
            mealContainer.className = "mb-6 space-y-3"; // Aumentado espacio
            mealContainer.innerHTML = '<h3 class="font-bold text-slate-700 text-sm uppercase tracking-wider mb-3 ml-1">üçΩÔ∏è Tiempos de Comida</h3>';

            mainMealsConfig.forEach(cfg => {
                if(foodDatabase[cfg.id]) {
                    // Creamos grupos con estilo "Super Group" pero para comidas individuales
                    mealContainer.appendChild(createSuperGroupStyle(
                        cfg.id, 
                        cfg.icon, 
                        `bg-${cfg.color}-50`, 
                        `text-${cfg.color}-600`, 
                        `border-${cfg.color}-200`, 
                        [cfg.id] // Pasamos el ID como array para que renderice esa categor√≠a
                    ));
                }
            });
            container.appendChild(mealContainer);

            // 2. OTROS / DESPENSA
            const pantryKeys = ['Frutas', 'Verduras', 'Carnes', 'Pescados', 'Huevos', 'Frutos Secos', 'Legumbres Secas', 'Legumbres Cocidas', 'Cereales Grano', 'Pastas', 'Panes', 'Leches', 'Quesos', 'Yogures', 'Bebidas'];
            container.appendChild(createSuperGroup('üçé Despensa / Otros', 'bg-green-50', 'text-green-800', 'border-green-100', pantryKeys));

            // 3. COMIDA R√ÅPIDA
            const fastFoodKeys = ['Burger King', 'Hamburguesas', 'Acompa√±amientos'];
            container.appendChild(createSuperGroup('üçî Comida R√°pida', 'bg-orange-50', 'text-orange-800', 'border-orange-100', fastFoodKeys));

            // 4. BOLLER√çA Y DULCES
            const sweetKeys = ['Bolleria', 'Dulces'];
            container.appendChild(createSuperGroup('üç© Boller√≠a y Dulces', 'bg-purple-50', 'text-purple-800', 'border-purple-100', sweetKeys));

            // 5. SALSAS
            const sauceKeys = ['Salsas'];
            container.appendChild(createSuperGroup('ü•´ Salsas', 'bg-red-50', 'text-red-800', 'border-red-100', sauceKeys));
        }

        // Nueva funci√≥n para el estilo "chulo" de comidas principales
        function createSuperGroupStyle(title, iconClass, bgClass, textClass, borderClass, keys) {
             const groupDiv = document.createElement('div');
            groupDiv.className = `border ${borderClass} rounded-2xl ${bgClass} overflow-hidden shadow-sm transition hover:shadow-md`;
            
            const header = document.createElement('div');
            header.className = `p-4 font-bold ${textClass} cursor-pointer flex justify-between items-center group-header`;
            header.innerHTML = `<span class="flex items-center gap-3"><i class="fas ${iconClass} text-lg"></i> ${title}</span> <i class="fas fa-chevron-down opacity-50 transition-transform duration-300"></i>`;
            
            // Toggle Logic visual
            header.onclick = function() { 
                this.nextElementSibling.classList.toggle('open'); 
                this.querySelector('.fa-chevron-down').classList.toggle('rotate-180');
            };
            
            const contentDiv = document.createElement('div');
            contentDiv.className = "group-content bg-white"; 

            // Renderizamos directamente los items sin sub-acorde√≥n para las comidas principales
            // Ojo: keys[0] es la categor√≠a (ej: 'Desayuno')
            if(keys.length === 1 && foodDatabase[keys[0]]) {
                 contentDiv.innerHTML = renderFoodList(keys[0]);
            } else {
                 // Fallback para grupos complejos
                 keys.forEach(key => {
                    if(foodDatabase[key]) {
                        contentDiv.innerHTML += renderFoodList(key); // Concatenamos listas
                    }
                });
            }

            groupDiv.appendChild(header);
            groupDiv.appendChild(contentDiv);
            return groupDiv;
        }

        // Helper para los grupos grandes (Despensa, etc) - Mantiene acordeones internos
        function createSuperGroup(title, bgClass, textClass, borderClass, keys) {
            const groupDiv = document.createElement('div');
            groupDiv.className = `border ${borderClass} rounded-2xl ${bgClass} overflow-hidden shadow-sm mb-3`;
            
            const header = document.createElement('div');
            header.className = `p-4 font-bold ${textClass} cursor-pointer flex justify-between items-center group-header`;
            header.innerHTML = `<span>${title}</span> <i class="fas fa-layer-group opacity-50"></i>`;
            header.onclick = function() { this.nextElementSibling.classList.toggle('open'); };
            
            const contentDiv = document.createElement('div');
            contentDiv.className = "group-content bg-white px-2 py-2 space-y-2";

            keys.forEach(key => {
                if(foodDatabase[key]) {
                    const subCat = createAccordion(key, 'bg-gray-50', 'text-gray-600', 'border-gray-200');
                    contentDiv.appendChild(subCat);
                }
            });

            groupDiv.appendChild(header);
            groupDiv.appendChild(contentDiv);
            return groupDiv;
        }

        function createAccordion(cat, bgClass, textClass, borderClass) {
            const div = document.createElement('div');
            div.className = `border ${borderClass} rounded-2xl ${bgClass} overflow-hidden shadow-sm transition hover:shadow-md`;
            div.innerHTML = `
                <div class="p-4 font-bold ${textClass} cursor-pointer flex justify-between items-center group-header" onclick="this.nextElementSibling.classList.toggle('open')">
                    <span class="flex items-center gap-2">${cat}</span> 
                    <i class="fas fa-chevron-down text-xs opacity-50"></i>
                </div>
                <div class="meal-content bg-slate-50">
                    ${renderFoodList(cat)}
                </div>
            `;
            return div;
        }

        function renderFoodList(cat) {
            if(!foodDatabase[cat]) return '';
            return foodDatabase[cat].map((f, i) => `
                <div class="p-3 border-t border-gray-100 flex items-center justify-between hover:bg-blue-50/30 transition px-4 gap-2 search-item bg-white">
                    <div class="flex-1">
                        <div class="font-bold text-sm text-slate-700 item-name">${f.name}</div>
                        <div class="text-[10px] text-gray-400 font-mono mt-0.5">Base: ${f.cal} kcal / ${f.weight}g</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number" id="weight-${cat.replace(/\s+/g, '')}-${i}" value="${f.weight}" class="w-14 bg-white border border-gray-200 rounded-lg text-xs font-bold text-center py-2 focus:border-blue-500 outline-none shadow-sm" placeholder="g">
                        <span class="text-[10px] text-gray-400">g</span>
                    </div>
                    <div class="flex gap-2 ml-1">
                            <button onclick="viewCalculatedDetails('${cat}', ${i})" class="w-8 h-8 rounded-full bg-white border border-gray-200 text-gray-400 hover:text-blue-500 shadow-sm flex items-center justify-center"><i class="fas fa-search text-xs"></i></button>
                            <button onclick="addCalculatedFood('${cat}', ${i})" class="w-8 h-8 rounded-full bg-primary text-white shadow-sm active:scale-90 transition flex items-center justify-center"><i class="fas fa-plus text-xs"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function searchGlobal(query) {
            const results = document.getElementById('searchResults');
            if (query.length < 2) { results.classList.add('hidden'); return; }
            
            results.classList.remove('hidden');
            results.innerHTML = '';
            
            let count = 0;
            for (const cat in foodDatabase) {
                foodDatabase[cat].forEach((f, i) => {
                    if (f.name.toLowerCase().includes(query.toLowerCase()) && count < 10) {
                        count++;
                        const div = document.createElement('div');
                        div.className = 'p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 flex justify-between items-center';
                        div.innerHTML = `<span class="text-sm font-bold text-slate-700">${f.name}</span> <span class="text-xs text-gray-400">${f.cal} kcal</span>`;
                        // AQU√ç EST√Å LA CLAVE: Llamamos al detalle pasando TRUE para indicar que viene de b√∫squeda
                        div.onclick = () => { 
                             viewCalculatedDetails(cat, i, true); 
                             results.classList.add('hidden');
                             document.getElementById('globalSearch').value = '';
                        };
                        results.appendChild(div);
                    }
                });
            }
            if(count === 0) results.innerHTML = '<div class="p-3 text-xs text-gray-400">No encontrado</div>';
        }

        function getCalculatedFood(cat, idx) {
            const base = foodDatabase[cat][idx];
            const catId = cat.replace(/\s+/g, '');
            const inputEl = document.getElementById(`weight-${catId}-${idx}`);
            const inputVal = inputEl ? inputEl.value : base.weight;
            
            const newWeight = parseFloat(inputVal) || base.weight;
            const ratio = newWeight / base.weight;

            return {
                name: base.name,
                weight: newWeight,
                cal: base.cal * ratio,
                prot: base.prot * ratio,
                fat: base.fat * ratio,
                carb: base.carb * ratio
            };
        }

        // --- L√ìGICA MODIFICADA PARA DETALLES / B√öSQUEDA ---
        function viewCalculatedDetails(cat, idx, fromSearch = false) {
            const base = foodDatabase[cat][idx];
            
            // Determinar peso inicial
            let initialWeight = base.weight;
            // Si NO viene de b√∫squeda, intentamos coger el valor del input de la lista
            if (!fromSearch) {
                 const catId = cat.replace(/\s+/g, '');
                 const listInput = document.getElementById(`weight-${catId}-${idx}`);
                 if (listInput) initialWeight = parseFloat(listInput.value) || base.weight;
            }

            Swal.fire({
                title: base.name,
                html: `
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Cantidad (Gramos)</label>
                        <input id="swal-grams" type="number" value="${initialWeight}" class="w-full bg-gray-100 border border-gray-200 rounded-xl p-3 text-center text-xl font-bold text-slate-700 focus:border-blue-500 outline-none">
                    </div>
                    
                    <div id="swal-stats" class="grid grid-cols-2 gap-3 text-center mb-2 transition-all">
                        </div>
                `,
                confirmButtonText: 'A√±adir a Dieta',
                confirmButtonColor: '#3b82f6',
                showCancelButton: true,
                cancelButtonText: 'Cancelar',
                didOpen: () => {
                    const input = document.getElementById('swal-grams');
                    const stats = document.getElementById('swal-stats');
                    
                    // Funci√≥n interna para recalcular en tiempo real
                    const updateStats = () => {
                        const w = parseFloat(input.value) || 0;
                        const ratio = w / base.weight;
                        
                        stats.innerHTML = `
                            <div class="bg-gray-50 p-2 rounded-lg"><span class="block text-xs text-gray-400">Energ√≠a</span><span class="font-bold text-slate-700">${Math.round(base.cal * ratio)} kcal</span></div>
                            <div class="bg-gray-50 p-2 rounded-lg"><span class="block text-xs text-green-500">Prote√≠na</span><span class="font-bold text-green-600">${Math.round(base.prot * ratio)}g</span></div>
                            <div class="bg-gray-50 p-2 rounded-lg"><span class="block text-xs text-yellow-500">Grasas</span><span class="font-bold text-yellow-600">${Math.round(base.fat * ratio)}g</span></div>
                            <div class="bg-gray-50 p-2 rounded-lg"><span class="block text-xs text-red-500">Carbos</span><span class="font-bold text-red-600">${Math.round(base.carb * ratio)}g</span></div>
                        `;
                    };

                    // Event listener para cuando escribes
                    input.addEventListener('input', updateStats);
                    // Ejecutar una vez al abrir
                    updateStats();
                },
                preConfirm: () => {
                    const finalWeight = parseFloat(document.getElementById('swal-grams').value) || base.weight;
                    const ratio = finalWeight / base.weight;
                    return {
                        name: base.name,
                        weight: finalWeight,
                        cal: base.cal * ratio,
                        prot: base.prot * ratio,
                        fat: base.fat * ratio,
                        carb: base.carb * ratio
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    todayData.foodLog.push(result.value);
                    updateDay();
                    Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 }).fire({ icon: 'success', title: 'A√±adido' });
                }
            });
        }

        function addCalculatedFood(cat, idx) {
            const f = getCalculatedFood(cat, idx);
            todayData.foodLog.push(f);
            updateDay();
            Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 }).fire({ icon: 'success', title: 'A√±adido' });
        }

        function removeFood(i) { todayData.foodLog.splice(i, 1); updateDay(); }
        function addWater(ml) { todayData.water += ml; updateDay(); }
        
        function openCustomFoodModal() {
            Swal.fire({
                title: 'Crear Alimento',
                html: `<input id="swal-n" class="swal2-input" placeholder="Nombre"><div class="grid grid-cols-2 gap-2"><input id="swal-k" type="number" class="swal2-input" placeholder="Kcal"><input id="swal-p" type="number" class="swal2-input" placeholder="Prot"><input id="swal-c" type="number" class="swal2-input" placeholder="Carb"><input id="swal-f" type="number" class="swal2-input" placeholder="Fat"><input id="swal-w" type="number" class="swal2-input" placeholder="Gramos (ref)"></div>`,
                confirmButtonColor: '#1e293b', confirmButtonText: 'Guardar',
                preConfirm: () => ({ 
                    name: document.getElementById('swal-n').value, 
                    cal: Number(document.getElementById('swal-k').value), 
                    prot: Number(document.getElementById('swal-p').value), 
                    fat: Number(document.getElementById('swal-f').value), 
                    carb: Number(document.getElementById('swal-c').value), 
                    weight: Number(document.getElementById('swal-w').value) || 100 
                })
            }).then(r => { if(r.value) { todayData.foodLog.push(r.value); updateDay(); } });
        }

        // Sistema
        function saveDay() { localStorage.setItem('fitTrackerToday_MD', JSON.stringify(todayData)); }
        function loadDay() {
            const s = localStorage.getItem('fitTrackerToday_MD');
            if(s) {
                const loaded = JSON.parse(s);
                todayData = { ...INITIAL_STATE, ...loaded };
                if (!Array.isArray(todayData.studySessions)) todayData.studySessions = [];
                
                if(document.getElementById('wakeTime')) document.getElementById('wakeTime').value = todayData.wakeTime;
                if(document.getElementById('sleepHours')) document.getElementById('sleepHours').value = todayData.sleepHours || '';
                if(document.getElementById('sleepQuality')) document.getElementById('sleepQuality').value = todayData.sleepQuality || '';
                
                document.getElementById('range-run-km').value = todayData.runKm || 0;
                document.getElementById('range-run-pace').value = todayData.runPace || 5.5;
                document.getElementById('range-run-int').value = todayData.runInt || 2;
                document.getElementById('range-bike-km').value = todayData.bikeKm || 0;
                document.getElementById('range-mobile').value = todayData.mobileHours || 0;
                document.getElementById('range-steps').value = todayData.steps || 0;
                document.getElementById('range-standing').value = todayData.standingHours || 0;
            }
        }

        function finishDay() {
            Swal.fire({
                title: '¬øFinalizar el d√≠a?', text: "Se generar√° el informe en el historial.", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#10b981', cancelButtonColor: '#d33', confirmButtonText: 'S√≠, guardar'
            }).then((result) => {
                if (result.isConfirmed) {
                    history.unshift({ date: new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }), data: { ...todayData }, goals: { ...currentGoals } });
                    localStorage.setItem('fitTrackerHistory_MD', JSON.stringify(history));
                    todayData = JSON.parse(JSON.stringify(INITIAL_STATE));
                    saveDay();
                    Swal.fire('¬°Guardado!', 'D√≠a registrado.', 'success').then(() => window.location.reload());
                }
            });
        }
        
        function navigateTo(id) {
            document.querySelectorAll('.page-section').forEach(e=>e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            document.getElementById('nav-'+id).classList.add('active');
            window.scrollTo(0,0);
        }

        function updateHistoryUI() {
            const list = document.getElementById('historyList');
            if(history.length === 0) { list.innerHTML = '<div class="text-center text-gray-400 mt-10"><i class="fas fa-history text-4xl mb-3 opacity-30"></i><p>Sin historial</p></div>'; return; }
            list.innerHTML = history.map((h, i) => `
                <div class="card p-5 flex justify-between items-center shadow-sm hover:shadow-md transition">
                    <div>
                        <div class="font-bold text-slate-800 capitalize text-sm">${h.date}</div>
                        <div class="text-[10px] text-gray-400 mt-1">Carga Fisiol√≥gica: <b>${Math.round(h.data.water/h.goals.water*100)}%</b></div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="restoreDay(${i})" class="w-10 h-10 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center hover:bg-orange-200 transition"><i class="fas fa-undo-alt text-sm"></i></button>
                        <button onclick="generateBeautifulPDF(${i})" class="bg-slate-800 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition"><i class="fas fa-file-pdf text-sm"></i></button>
                        <button onclick="deleteDay(${i})" class="w-10 h-10 rounded-full bg-red-100 text-red-500 flex items-center justify-center hover:bg-red-200 transition"><i class="fas fa-trash-alt text-sm"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function restoreDay(index) {
            Swal.fire({
                title: '¬øRestaurar este d√≠a?',
                text: "Esto sobreescribir√° lo que lleves registrado hoy.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'S√≠, restaurar',
                confirmButtonColor: '#f59e0b'
            }).then((result) => {
                if(result.isConfirmed) {
                    todayData = history[index].data;
                    history.splice(index, 1); 
                    localStorage.setItem('fitTrackerHistory_MD', JSON.stringify(history));
                    saveDay(); 
                    window.location.reload();
                }
            });
        }

        function deleteDay(index) {
            Swal.fire({
                title: '¬øEliminar registro?',
                text: "No se podr√° recuperar.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'S√≠, eliminar',
                confirmButtonColor: '#ef4444'
            }).then((result) => {
                if(result.isConfirmed) {
                    history.splice(index, 1);
                    localStorage.setItem('fitTrackerHistory_MD', JSON.stringify(history));
                    updateHistoryUI();
                    Swal.fire('Eliminado', '', 'success');
                }
            });
        }

        function generateBeautifulPDF(index) {
            const rec = history[index];
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const dark = [30, 41, 59];
            doc.setFillColor(...dark);
            doc.rect(0, 0, 210, 35, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.text("INFORME DIARIO DE RENDIMIENTO", 105, 18, null, null, "center");
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(rec.date.toUpperCase(), 105, 26, null, null, "center");

            let y = 45;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("Resumen Biom√©trico", 14, y);
            y += 8;

            const metricData = [
                ['Sue√±o', `${rec.data.sleepHours}h (${rec.data.sleepQuality}%)`, 'Uso M√≥vil', `${rec.data.mobileHours}h`],
                ['Agua', `${rec.data.water} ml`, 'Pasos', `${rec.data.steps}`],
                ['Deporte', `${rec.data.runKm + rec.data.bikeKm} km`, 'Horas de Pie', `${rec.data.standingHours}h`]
            ];

            doc.autoTable({
                startY: y,
                head: [['M√©trica', 'Valor', 'M√©trica', 'Valor']],
                body: metricData,
                theme: 'grid',
                headStyles: { fillColor: [240, 240, 240], textColor: [50, 50, 50] },
                styles: { fontSize: 10 }
            });
            y = doc.lastAutoTable.finalY + 10;

            doc.text("Carga Cognitiva (Estudio)", 14, y);
            y += 6;
            let studyRows = rec.data.studySessions ? rec.data.studySessions.map(s => [s.hours + 'h', s.focus === 1 ? 'Bajo' : (s.focus === 2 ? 'Medio' : 'Alto (Deep Work)')]) : [];
            if(studyRows.length > 0) {
                 doc.autoTable({ startY: y, head: [['Duraci√≥n', 'Foco']], body: studyRows, theme: 'striped', headStyles: { fillColor: [139, 92, 246] } });
                y = doc.lastAutoTable.finalY + 10;
            } else { doc.text("Sin sesiones.", 14, y+5); y += 15; }

            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text("Registro Nutricional", 14, y);
            y += 6;
            const foodBody = rec.data.foodLog.map(f => [f.name, Math.round(f.cal), Math.round(f.prot), Math.round(f.fat), Math.round(f.carb)]);
            const totalCal = rec.data.foodLog.reduce((a,b)=>a+b.cal,0);
            foodBody.push(['TOTAL', Math.round(totalCal), '-', '-', '-']);

            doc.autoTable({
                startY: y,
                head: [['Alimento', 'Kcal', 'Prot (g)', 'Grasa (g)', 'Carb (g)']],
                body: foodBody,
                theme: 'grid',
                headStyles: { fillColor: dark }
            });

            const blob = doc.output('bloburl');
            window.open(blob, '_blank');
        }
    </script>
</body>
</html>


